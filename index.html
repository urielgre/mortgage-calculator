<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mortgage Calculator ‚Äî Free Payment Estimator | All 50 States</title>
    <meta name="description" content="Free mortgage calculator with monthly payment breakdown, tax benefits, PMI tracking, ARM vs fixed rates, rent vs buy comparison, and 10-year wealth projections for all 50 US states.">
    <meta name="author" content="Home Investment Calculator">
    <meta name="robots" content="index, follow">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Home Investment Calculator ‚Äî All 50 States">
    <meta property="og:description" content="Comprehensive mortgage analysis with tax benefits, cashflow modeling, and wealth building projections for US homebuyers.">
    <!-- TODO: Add hosted screenshot URL for social sharing preview -->
    <meta property="og:image" content="">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Home Investment Calculator ‚Äî All 50 States">
    <meta name="twitter:description" content="Comprehensive mortgage analysis with tax benefits, cashflow modeling, and wealth building projections for US homebuyers.">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%232563eb'/%3E%3Ctext x='16' y='23' font-size='18' text-anchor='middle'%3Eüè†%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'%3E%3Crect width='180' height='180' rx='36' fill='%232563eb'/%3E%3Ctext x='90' y='125' font-size='110' text-anchor='middle'%3Eüè†%3C/text%3E%3C/svg%3E">
    <link rel="canonical" href="https://mortgage-calculator-tau-five.vercel.app/">
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@graph": [
            {
                "@type": "WebApplication",
                "name": "Mortgage Payment Calculator",
                "applicationCategory": "FinanceApplication",
                "operatingSystem": "Any",
                "browserRequirements": "Requires JavaScript",
                "offers": { "@type": "Offer", "price": "0", "priceCurrency": "USD" },
                "description": "Free mortgage calculator with monthly payment breakdown, tax benefits, PMI tracking, ARM vs fixed rates, rent vs buy comparison, and 10-year wealth projections for all 50 US states.",
                "featureList": "Monthly payment breakdown, Amortization schedule, Tax benefit analysis, PMI tracking, ARM vs Fixed comparison, Rent vs Buy analysis, Wealth building projections, Extra payment modeling, Affordability calculator, County-level tax rates for all 50 states"
            },
            {
                "@type": "FAQPage",
                "mainEntity": [
                    {
                        "@type": "Question",
                        "name": "How much house can I afford?",
                        "acceptedAnswer": {
                            "@type": "Answer",
                            "text": "Most lenders use the 28/36 rule: your monthly housing costs (mortgage, taxes, insurance) should not exceed 28% of your gross monthly income, and total debt payments should stay below 36%. This calculator uses the 28% front-end DTI ratio to estimate your maximum affordable home price based on your income, debts, and down payment."
                        }
                    },
                    {
                        "@type": "Question",
                        "name": "What is PMI and when can I remove it?",
                        "acceptedAnswer": {
                            "@type": "Answer",
                            "text": "Private Mortgage Insurance (PMI) is required when your down payment is less than 20% of the home price. It protects the lender if you default. PMI typically costs 0.3-1.5% of the loan amount annually. Under the Homeowners Protection Act, you can request PMI removal at 80% LTV and it's automatically cancelled at 78% LTV based on the original amortization schedule."
                        }
                    },
                    {
                        "@type": "Question",
                        "name": "Should I rent or buy a home?",
                        "acceptedAnswer": {
                            "@type": "Answer",
                            "text": "The rent vs buy decision depends on several factors: how long you plan to stay (typically 5+ years to break even on buying), local market conditions, your financial readiness (down payment, credit score, emergency fund), and the price-to-rent ratio in your area. This calculator compares total costs of renting vs buying over time including tax benefits, equity building, and opportunity cost of your down payment."
                        }
                    },
                    {
                        "@type": "Question",
                        "name": "How do extra mortgage payments save money?",
                        "acceptedAnswer": {
                            "@type": "Answer",
                            "text": "Extra payments go directly toward your principal balance, reducing the amount of interest charged over the life of the loan. Even small additional payments can save tens of thousands in interest and shorten your loan term by years. For example, adding $200/month to a $400,000 30-year mortgage at 7% can save over $100,000 in interest and pay off the loan 7 years early."
                        }
                    },
                    {
                        "@type": "Question",
                        "name": "What are typical closing costs when buying a home?",
                        "acceptedAnswer": {
                            "@type": "Answer",
                            "text": "Closing costs typically range from 2-5% of the home purchase price. They include loan origination fees (0.5-1%), title insurance (0.5-1%), appraisal ($300-$600), home inspection ($300-$500), escrow and recording fees, and prepaid items like property taxes and homeowners insurance. Some costs are negotiable, and sellers sometimes contribute to closing costs."
                        }
                    },
                    {
                        "@type": "Question",
                        "name": "How does this mortgage calculator work?",
                        "acceptedAnswer": {
                            "@type": "Answer",
                            "text": "This calculator uses the standard amortization formula to compute monthly principal and interest, then adds property taxes (using county-level data for all 50 US states plus DC), homeowners insurance, PMI if applicable, HOA fees, and other housing costs. It models federal and state tax benefits, compares renting vs buying, projects 10-year wealth building including home equity and appreciation, and calculates your maximum affordable home price using the 28% DTI ratio. All calculations run entirely in your browser with no data sent to any server."
                        }
                    }
                ]
            }
        ]
    }
    </script>
    <!-- Analytics: Uncomment and replace YOUR_DOMAIN after deploying -->
    <!-- <script defer data-domain="YOUR_DOMAIN" src="https://plausible.io/js/script.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js" integrity="sha384-vsrfeLOOY6KuIYKDlmVH5UiBmgIdB1oEf7p01YgWHuqmOHfZr374+odEv96n9tNC" crossorigin="anonymous"></script>
    <script async src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha384-Yv5O+t3uE3hunW8uyrbpPW3iw6/5/Y7HitWJBLgqfMoA36NogMmy+8wWZMpn3HWc" crossorigin="anonymous"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #16a34a;
            --warning: #ea580c;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 30px 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            margin-bottom: 30px;
            border-radius: 12px;
        }

        header h1 {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        header p {
            opacity: 0.9;
        }

        .grid {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 24px;
        }

        @media (max-width: 1024px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid var(--border);
        }

        .card h2 {
            font-size: 1.1rem;
            color: var(--text);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--primary);
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .input-group input:focus, .input-group select:focus {
            outline: 2px solid var(--primary);
            outline-offset: 1px;
            border-color: var(--primary);
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .input-hint, .hint {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .input-group input.input-error, .input-group select.input-error {
            border-color: #dc2626;
        }
        .input-group input.input-error:focus {
            outline-color: #dc2626;
        }
        .input-error-msg {
            font-size: 0.75rem;
            color: #dc2626;
            margin-top: 2px;
        }

        .section-divider {
            height: 1px;
            background: var(--border);
            margin: 20px 0;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .result-box {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            border-radius: 10px;
            padding: 20px;
        }

        .result-box.highlight {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }

        .result-box.success {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        }

        .result-box h3 {
            font-size: 0.85rem;
            font-weight: 500;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .result-box .value {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .result-box .subtext {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 4px;
        }

        /* Hero Payment Banner */
        .hero-payment {
            background: linear-gradient(135deg, var(--primary) 0%, #1e40af 100%);
            color: white;
            border-radius: 12px;
            padding: 28px 24px;
            text-align: center;
            margin-bottom: 20px;
        }
        .hero-payment .hero-label {
            display: block;
            font-size: 0.9rem;
            opacity: 0.85;
            margin-bottom: 4px;
        }
        .hero-payment .hero-value {
            display: block;
            font-size: 3rem;
            font-weight: 800;
            letter-spacing: -1px;
            line-height: 1.1;
        }
        .hero-payment .hero-sublabel {
            display: block;
            font-size: 0.85rem;
            opacity: 0.75;
            margin-top: 8px;
        }

        /* Simple/Advanced Mode Toggle */
        .mode-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
            font-size: 0.85rem;
        }
        .mode-toggle .toggle-label {
            color: var(--text-muted);
            cursor: pointer;
        }
        .mode-toggle .toggle-label.active {
            color: var(--primary);
            font-weight: 600;
        }
        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: #cbd5e1;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .toggle-switch.on {
            background: var(--primary);
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            transition: transform 0.2s;
        }
        .toggle-switch.on::after {
            transform: translateX(20px);
        }
        .advanced-inputs {
            display: none;
        }
        .advanced-tab {
            display: none !important;
        }
        body.advanced-mode .advanced-inputs {
            display: block;
        }
        body.advanced-mode .advanced-tab {
            display: inline-flex !important;
        }

        /* Calc Mode Switcher */
        .calc-mode-switcher {
            display: flex;
            gap: 0;
            margin-bottom: 16px;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid var(--primary);
        }
        .calc-mode-btn {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: white;
            color: var(--primary);
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }
        .calc-mode-btn.active {
            background: var(--primary);
            color: white;
        }
        .calc-mode-btn:hover:not(.active) {
            background: #eff6ff;
        }

        .breakdown-table {
            width: 100%;
            border-collapse: collapse;
        }
        .table-scroll-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .breakdown-table tr {
            border-bottom: 1px solid var(--border);
        }

        .breakdown-table tr:last-child {
            border-bottom: none;
        }

        .breakdown-table td {
            padding: 10px 0;
        }

        .breakdown-table td:last-child {
            text-align: right;
            font-weight: 500;
            font-family: 'SF Mono', 'Cascadia Code', Consolas, 'Ubuntu Mono', monospace;
        }

        .breakdown-table tr.total {
            font-weight: 700;
            border-top: 2px solid var(--text);
        }

        .breakdown-table tr.total td {
            padding-top: 14px;
        }

        .breakdown-table tr.subtotal {
            background: #f8fafc;
            font-weight: 600;
        }

        .flex-between {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }
        .flex-between.muted {
            color: var(--text-muted);
        }
        .flex-between.total-row {
            border-top: 1px solid #cbd5e1;
            padding-top: 4px;
            font-weight: 600;
        }
        .summary-box {
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            font-size: 0.85rem;
        }
        .summary-box.income {
            background: #f1f5f9;
        }
        .summary-box.cashflow {
            background: #e0f2fe;
        }
        .summary-box .box-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #0369a1;
        }
        .summary-box.cashflow .total-row {
            border-color: #7dd3fc;
            color: #0369a1;
        }
        .summary-box .section-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin: 8px 0 4px 0;
        }
        .summary-box .section-label:first-child {
            margin-top: 0;
        }
        .readonly-input {
            background: #f1f5f9;
        }
        .dti-hint {
            padding-left: 16px;
            font-size: 0.85em;
            color: var(--text-muted);
        }
        .section-gap {
            margin-bottom: 12px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        .chart-container-sm {
            height: 250px;
        }
        .chart-container-lg {
            height: 350px;
        }

        .tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 20px;
            background: var(--bg);
            padding: 4px;
            border-radius: 10px;
        }

        .tab {
            flex: 1;
            padding: 10px 16px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-muted);
            transition: background 0.2s, color 0.2s, box-shadow 0.2s;
        }

        .tab.active {
            background: var(--card);
            color: var(--primary);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .tab:hover:not(.active) {
            color: var(--text);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .input-tab-content {
            display: none;
        }

        .input-tab-content.active {
            display: block;
        }

        .amortization-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .amortization-table th {
            text-align: left;
            padding: 12px 8px;
            background: var(--bg);
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .amortization-table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border);
            font-family: 'SF Mono', 'Cascadia Code', Consolas, 'Ubuntu Mono', monospace;
            font-size: 0.85rem;
        }

        .amortization-table tr:hover {
            background: #f8fafc;
        }

        .scroll-table {
            max-height: 400px;
            overflow-y: auto;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .tag.yes {
            background: #dcfce7;
            color: #16a34a;
        }

        .tag.no {
            background: #fee2e2;
            color: #dc2626;
        }

        .info-banner {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #1e40af;
        }

        .comparison-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }

        .comparison-row:last-child {
            border-bottom: none;
        }

        .affordability-meter {
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 8px;
        }

        .affordability-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s, background 0.3s;
        }

        .sticky-sidebar {
            position: sticky;
            top: 20px;
        }

        .input-section-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--primary);
            margin: 20px 0 12px 0;
            font-weight: 600;
        }

        .input-section-title:first-child {
            margin-top: 0;
        }

        .header-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, color 0.2s;
        }

        .save-btn {
            background: white;
            color: var(--primary-dark);
        }

        .save-btn:hover {
            background: #e0e7ff;
        }

        .reset-btn {
            background: rgba(255,255,255,0.85);
            color: var(--primary-dark);
        }

        .reset-btn:hover {
            background: white;
        }

        /* Tooltips ‚Äî accessible via hover, focus, and click */
        [data-tooltip] {
            position: relative;
        }
        .tooltip-trigger {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--border);
            color: var(--text-muted);
            font-size: 0.7rem;
            font-weight: 700;
            border: none;
            cursor: pointer;
            vertical-align: middle;
            margin-left: 6px;
            padding: 0;
            line-height: 1;
            flex-shrink: 0;
            position: relative;
        }
        .tooltip-trigger::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 44px;
            height: 44px;
        }
        .tooltip-trigger:hover, .tooltip-trigger:focus {
            background: var(--primary);
            color: white;
            outline: 2px solid var(--primary);
            outline-offset: 1px;
        }
        .tooltip-bubble {
            display: none;
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: #1e293b;
            color: white;
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 400;
            line-height: 1.5;
            white-space: normal;
            width: max-content;
            max-width: 300px;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
        }
        .tooltip-bubble::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: #1e293b;
        }
        [data-tooltip]:hover .tooltip-bubble,
        [data-tooltip].tooltip-open .tooltip-bubble {
            display: block;
        }

        /* Error banner */
        .error-banner {
            background: #fee2e2;
            border: 1px solid #fca5a5;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #991b1b;
            display: none;
        }
        .error-banner button {
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 12px;
            cursor: pointer;
            margin-left: 8px;
            font-size: 0.85rem;
        }

        /* Warning banner */
        .warning-banner {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            color: #92400e;
            display: none;
        }

        /* ARM badge */
        .arm-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            background: #dbeafe;
            color: #1d4ed8;
            margin-left: 8px;
        }

        /* PMI timeline */
        .pmi-timeline {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 12px 0;
        }
        .pmi-timeline-bar {
            flex: 1;
            height: 24px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        .pmi-timeline-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s;
        }
        .pmi-stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin: 16px 0;
        }
        .pmi-stat {
            background: #f8fafc;
            border-radius: 8px;
            padding: 12px;
        }
        .pmi-stat .label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        .pmi-stat .val {
            font-size: 1.2rem;
            font-weight: 700;
        }

        /* Mobile responsive */
        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }
            .sticky-sidebar {
                position: static;
            }
            .results-grid {
                grid-template-columns: 1fr;
            }
            .tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                scrollbar-width: none;
                -webkit-overflow-scrolling: touch;
                position: relative;
                -webkit-mask-image: linear-gradient(to right, black 85%, transparent 100%);
                mask-image: linear-gradient(to right, black 85%, transparent 100%);
            }
            .tabs::-webkit-scrollbar {
                display: none;
            }
            .tab {
                flex: 0 0 auto;
                font-size: 0.8rem;
                padding: 10px 14px;
                white-space: nowrap;
                min-height: 44px;
            }
            .hero-payment .hero-value {
                font-size: 2.4rem;
            }
            .calc-mode-switcher {
                flex-direction: column;
            }
            header h1 {
                font-size: 1.4rem;
            }
            .container {
                padding: 12px;
            }
            .cashflow-split {
                grid-template-columns: 1fr !important;
            }
            .tooltip-bubble {
                left: 0;
                transform: none;
                max-width: 220px;
            }
            .tooltip-bubble::after {
                left: 20px;
                transform: none;
            }
        }
        @media (max-width: 480px) {
            .hero-payment {
                padding: 20px 16px;
            }
            .hero-payment .hero-value {
                font-size: 2.2rem;
            }
            .results-grid {
                grid-template-columns: 1fr;
            }
            .input-row {
                grid-template-columns: 1fr;
            }
            .card {
                padding: 16px;
            }
            .result-box .value {
                font-size: 1.4rem;
            }
            .pmi-stat-grid {
                grid-template-columns: 1fr;
            }
            .chart-container {
                height: 220px;
            }
            .chart-container-sm {
                height: 200px;
            }
            .chart-container-lg {
                height: 260px;
            }
        }
        @media (max-width: 320px) {
            .container {
                padding: 8px;
            }
            header h1 {
                font-size: 1.2rem;
            }
            .hero-payment .hero-value {
                font-size: 1.8rem;
            }
            .hero-payment .hero-label {
                font-size: 0.8rem;
            }
            .card {
                padding: 12px;
            }
            .tab {
                padding: 8px 10px;
                font-size: 0.75rem;
            }
            .chart-container {
                height: 180px;
            }
            .result-box .value {
                font-size: 1.2rem;
            }
        }

        /* Legal disclaimer */
        .legal-disclaimer {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px 20px;
            margin-top: 24px;
            font-size: 0.8rem;
            line-height: 1.6;
            color: var(--text-muted);
        }
        .legal-disclaimer strong {
            color: var(--text);
            font-size: 0.85rem;
        }
        .legal-disclaimer p {
            margin: 6px 0 0 0;
        }

        /* Footer */
        .site-footer {
            text-align: center;
            padding: 24px 0;
            margin-top: 40px;
            border-top: 1px solid var(--border);
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .site-footer a {
            color: var(--primary);
            text-decoration: none;
        }
        .site-footer a:hover {
            text-decoration: underline;
        }

        /* Skip-to-content */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--primary);
            color: white;
            padding: 8px 16px;
            z-index: 1000;
            transition: top 0.2s;
            border-radius: 0 0 8px 0;
            font-size: 0.9rem;
            text-decoration: none;
        }
        .skip-link:focus {
            top: 0;
        }

        /* Screen reader only */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Methodology section */
        .methodology-section summary {
            cursor: pointer;
            font-weight: 600;
            color: var(--primary);
            padding: 12px 0;
            font-size: 0.95rem;
        }
        .methodology-section summary:hover {
            color: var(--primary-dark);
        }
        .methodology-content {
            font-size: 0.85rem;
            color: var(--text-muted);
            line-height: 1.8;
            padding: 12px 0;
        }
        .methodology-content h4 {
            color: var(--text);
            margin: 16px 0 8px;
            font-size: 0.9rem;
        }
        .methodology-content ul {
            padding-left: 20px;
            margin: 8px 0;
        }

        /* Scenario comparison */
        .scenario-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 16px;
        }
        .scenario-card {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 16px;
            position: relative;
        }
        .scenario-card h4 {
            font-size: 0.9rem;
            margin-bottom: 12px;
            padding-right: 24px;
        }
        .scenario-card .scenario-delete {
            position: absolute;
            top: 4px;
            right: 4px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-muted);
            font-size: 1.2rem;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .scenario-card .scenario-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            padding: 4px 0;
            border-bottom: 1px solid var(--border);
        }
        .scenario-card .scenario-row:last-of-type {
            border-bottom: none;
        }

        /* Print stylesheet */
        @media print {
            body {
                background: white;
                font-size: 11pt;
            }
            .container {
                max-width: 100%;
                padding: 0;
            }
            header {
                background: none !important;
                color: black !important;
                padding: 10px 0 !important;
                border-bottom: 2px solid black;
            }
            header h1 {
                font-size: 16pt;
                background: none !important;
                -webkit-background-clip: unset !important;
                -webkit-text-fill-color: black !important;
            }
            header nav,
            header .subtitle {
                display: none !important;
            }
            .grid {
                display: block !important;
            }
            aside.sticky-sidebar {
                display: none !important;
            }
            section[aria-label="Results"] {
                break-inside: avoid;
            }
            .tabs {
                display: none !important;
            }
            .tab-content {
                display: block !important;
                break-inside: avoid;
                margin-bottom: 20px;
                border-bottom: 1px solid #ccc;
                padding-bottom: 15px;
            }
            .card {
                box-shadow: none !important;
                border: 1px solid #ccc;
                break-inside: avoid;
            }
            .result-box {
                border: 1px solid #ccc;
                background: white !important;
            }
            .result-box.highlight {
                color: #1e293b !important;
            }
            .hero-payment {
                background: white !important;
                color: black !important;
                border: 2px solid #333;
                padding: 16px;
            }
            .hero-payment .hero-label,
            .hero-payment .hero-sublabel {
                opacity: 1;
            }
            .mode-toggle,
            .calc-mode-switcher {
                display: none !important;
            }
            .chart-container {
                display: none !important;
            }
            .tooltip-trigger,
            .tooltip-bubble {
                display: none !important;
            }
            .info-banner,
            .warning-banner {
                border: 1px solid #999;
                background: white !important;
            }
            a {
                color: black;
                text-decoration: none;
            }
            .legal-disclaimer {
                border: 1px solid #999;
                background: white !important;
            }
            .site-footer {
                border-top: 1px solid #ccc;
            }
            .skip-link {
                display: none !important;
            }
            .scenario-comparison {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to calculator results</a>
    <div class="container">
        <header>
            <h1><span aria-hidden="true">üè†</span> Mortgage Payment Calculator</h1>
            <p>Primary Residence Analysis with Tax Benefits ‚Äî All 50 States</p>
            <p style="font-size: 0.8rem; opacity: 0.75; margin-top: 4px;">Data verified Feb 2026 ¬∑ No data leaves your browser ¬∑ Free & open-source</p>
            <nav aria-label="Calculator actions" style="margin-top: 16px; display: flex; flex-wrap: wrap; gap: 12px; justify-content: center;">
                <button onclick="saveData()" class="header-btn save-btn"><span aria-hidden="true">üíæ</span> Save</button>
                <button onclick="shareURL()" class="header-btn save-btn"><span aria-hidden="true">üîó</span> Share</button>
                <button onclick="saveScenario()" class="header-btn save-btn"><span aria-hidden="true">üìã</span> Scenario</button>
                <button onclick="exportPDF()" class="header-btn save-btn"><span aria-hidden="true">üìÑ</span> PDF</button>
                <button onclick="resetData()" class="header-btn reset-btn"><span aria-hidden="true">üîÑ</span> Reset</button>
                <span id="saveStatus" style="font-size: 0.85rem; opacity: 0.8; align-self: center;" aria-live="polite"></span>
            </nav>
        </header>

        <div class="error-banner" id="errorBanner" role="alert">
            <strong>Something went wrong.</strong>
            <span id="errorMessage">An error occurred during calculation.</span>
            <button onclick="dismissError(); calculate();">Retry</button>
        </div>
        <div class="warning-banner" id="dataWarning" role="alert"></div>

        <main class="grid">
            <!-- Input Panel -->
            <aside class="sticky-sidebar" aria-label="Scenario inputs">
                <div class="card">
                    <h2><span aria-hidden="true">üìù</span> Scenario Inputs</h2>

                    <!-- Simple/Advanced Toggle -->
                    <div class="mode-toggle">
                        <span class="toggle-label active" id="simpleModeLabel">Simple</span>
                        <div class="toggle-switch" id="advancedToggle" role="switch" aria-checked="false" aria-label="Advanced mode" tabindex="0" onclick="toggleAdvancedMode()" onkeydown="if(event.key===' '||event.key==='Enter'){event.preventDefault();toggleAdvancedMode();}"></div>
                        <span class="toggle-label" id="advancedModeLabel">Advanced</span>
                    </div>

                    <!-- Left Panel Tabs -->
                    <div class="tabs" role="tablist" aria-label="Input sections" style="margin-bottom: 16px;">
                        <button class="tab active" role="tab" aria-selected="true" aria-controls="propertyTab" id="tab-property" onclick="showInputTab('propertyTab', this)">Property</button>
                        <button class="tab advanced-tab" role="tab" aria-selected="false" aria-controls="incomeTab" id="tab-income" onclick="showInputTab('incomeTab', this)">Income</button>
                        <button class="tab advanced-tab" role="tab" aria-selected="false" aria-controls="expensesTab" id="tab-expenses" onclick="showInputTab('expensesTab', this)">Expenses</button>
                    </div>

                    <!-- Property Tab -->
                    <div id="propertyTab" class="input-tab-content active" role="tabpanel" aria-labelledby="tab-property">
                        <div class="input-section-title">Location</div>

                        <div class="input-group">
                            <label>State</label>
                            <select id="stateSelect" onchange="onStateChange()">
                                <optgroup label="Popular">
                                    <option value="CA" selected>California</option>
                                    <option value="TX">Texas</option>
                                    <option value="FL">Florida</option>
                                    <option value="NY">New York</option>
                                    <option value="IL">Illinois</option>
                                    <option value="PA">Pennsylvania</option>
                                    <option value="OH">Ohio</option>
                                    <option value="GA">Georgia</option>
                                    <option value="NC">North Carolina</option>
                                    <option value="WA">Washington</option>
                                    <option value="NJ">New Jersey</option>
                                    <option value="CO">Colorado</option>
                                </optgroup>
                                <optgroup label="All States">
                                    <option value="AL">Alabama</option>
                                    <option value="AK">Alaska</option>
                                    <option value="AZ">Arizona</option>
                                    <option value="AR">Arkansas</option>
                                    <option value="CA">California</option>
                                    <option value="CO">Colorado</option>
                                    <option value="CT">Connecticut</option>
                                    <option value="DE">Delaware</option>
                                    <option value="DC">District of Columbia</option>
                                    <option value="FL">Florida</option>
                                    <option value="GA">Georgia</option>
                                    <option value="HI">Hawaii</option>
                                    <option value="ID">Idaho</option>
                                    <option value="IL">Illinois</option>
                                    <option value="IN">Indiana</option>
                                    <option value="IA">Iowa</option>
                                    <option value="KS">Kansas</option>
                                    <option value="KY">Kentucky</option>
                                    <option value="LA">Louisiana</option>
                                    <option value="ME">Maine</option>
                                    <option value="MD">Maryland</option>
                                    <option value="MA">Massachusetts</option>
                                    <option value="MI">Michigan</option>
                                    <option value="MN">Minnesota</option>
                                    <option value="MS">Mississippi</option>
                                    <option value="MO">Missouri</option>
                                    <option value="MT">Montana</option>
                                    <option value="NE">Nebraska</option>
                                    <option value="NV">Nevada</option>
                                    <option value="NH">New Hampshire</option>
                                    <option value="NJ">New Jersey</option>
                                    <option value="NM">New Mexico</option>
                                    <option value="NY">New York</option>
                                    <option value="NC">North Carolina</option>
                                    <option value="ND">North Dakota</option>
                                    <option value="OH">Ohio</option>
                                    <option value="OK">Oklahoma</option>
                                    <option value="OR">Oregon</option>
                                    <option value="PA">Pennsylvania</option>
                                    <option value="RI">Rhode Island</option>
                                    <option value="SC">South Carolina</option>
                                    <option value="SD">South Dakota</option>
                                    <option value="TN">Tennessee</option>
                                    <option value="TX">Texas</option>
                                    <option value="UT">Utah</option>
                                    <option value="VT">Vermont</option>
                                    <option value="VA">Virginia</option>
                                    <option value="WA">Washington</option>
                                    <option value="WV">West Virginia</option>
                                    <option value="WI">Wisconsin</option>
                                    <option value="WY">Wyoming</option>
                                </optgroup>
                            </select>
                        </div>

                        <div class="input-section-title">Property & Loan</div>

                        <div class="input-group">
                            <label>Purchase Price ($)</label>
                            <input type="number" id="purchasePrice" value="800000" step="10000" inputmode="numeric">
                        </div>

                        <div class="input-row">
                            <div class="input-group">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    Down Payment
                                    <select id="downPaymentMode" onchange="toggleDownPaymentMode()" style="padding: 8px 12px; font-size: 0.85rem; border-radius: 6px; min-height: 36px;">
                                        <option value="percent">%</option>
                                        <option value="amount">$</option>
                                    </select>
                                </label>
                                <input type="number" id="downPaymentPercent" value="20" min="0" max="100" step="1" inputmode="decimal">
                                <input type="number" id="downPaymentAmount" value="160000" min="0" step="5000" style="display: none;">
                                <div class="input-hint" id="downPaymentHint">$160,000 (20%)</div>
                            </div>
                            <div class="input-group">
                                <label>Interest Rate (%)</label>
                                <input type="number" id="interestRate" value="6.5" min="0" max="15" step="0.125" inputmode="decimal">
                                <div class="input-hint">Typical 30-yr fixed: ~6.5% <em>(Feb 2026)</em></div>
                            </div>
                        </div>

                        <div class="input-group">
                            <label>Loan Term (Years)</label>
                            <select id="loanTerm">
                                <option value="30" selected>30 Years</option>
                                <option value="20">20 Years</option>
                                <option value="15">15 Years</option>
                            </select>
                        </div>

                        <div class="advanced-inputs">
                        <div class="input-group">
                            <label>Mortgage Type</label>
                            <select id="loanType" onchange="toggleARMInputs(); calculate();">
                                <option value="fixed" selected>Fixed Rate</option>
                                <option value="5">5/1 ARM</option>
                                <option value="7">7/1 ARM</option>
                                <option value="10">10/1 ARM</option>
                            </select>
                        </div>

                        <div id="armInputs" style="display: none;">
                            <div class="input-row">
                                <div class="input-group">
                                    <label>Adj. Per Year (%)</label>
                                    <input type="number" id="armAdjustment" value="0.25" min="0" max="3" step="0.125">
                                    <div class="input-hint">Rate change after fixed period</div>
                                </div>
                                <div class="input-group">
                                    <label>Lifetime Rate Cap (%)</label>
                                    <input type="number" id="armCap" value="11" min="0" max="20" step="0.5">
                                    <div class="input-hint">Maximum rate over life of loan</div>
                                </div>
                            </div>
                        </div>

                        <div class="input-section-title">Property Taxes</div>

                        <div class="input-group">
                            <label>County / Area</label>
                            <select id="countySelect" onchange="updatePropertyTaxRate()">
                                <option value="1.00">Modoc / Sierra County (1.00%)</option>
                                <option value="1.10" selected>Average California (1.10%)</option>
                                <option value="1.16">Los Angeles County (1.16%)</option>
                                <option value="1.12">San Diego County (1.12%)</option>
                                <option value="1.13">Orange County (1.13%)</option>
                                <option value="1.24">Alameda County (1.24%)</option>
                                <option value="1.18">Santa Clara County (1.18%)</option>
                                <option value="1.09">San Francisco (1.09%)</option>
                                <option value="1.25">Riverside County (1.25%)</option>
                                <option value="1.20">Sacramento County (1.20%)</option>
                                <option value="1.15">San Mateo County (1.15%)</option>
                                <option value="1.50">High Special Assessment (1.50%)</option>
                                <option value="custom">Custom</option>
                            </select>
                        </div>

                        <div class="input-row">
                            <div class="input-group">
                                <label>Tax Rate (%)</label>
                                <input type="number" id="propertyTaxRate" value="1.1" min="0" max="3" step="0.05">
                            </div>
                            <div class="input-group">
                                <label>Special Assessment ($/yr)</label>
                                <input type="number" id="melloRoos" value="0" step="100">
                            </div>
                        </div>

                        <div class="input-section-title">Insurance & HOA</div>

                        <div class="input-row">
                            <div class="input-group">
                                <label>Insurance ($/yr)</label>
                                <input type="number" id="insurance" value="2400" step="100">
                            </div>
                            <div class="input-group">
                                <label>HOA ($/mo)</label>
                                <input type="number" id="hoa" value="0" step="25">
                            </div>
                        </div>

                        <div class="input-group" id="pmiRateGroup">
                            <label>PMI Rate (%/yr)</label>
                            <input type="number" id="pmiRate" value="0.5" min="0.1" max="3.0" step="0.1" inputmode="decimal">
                            <span class="hint" id="pmiRateHint">Typical: 0.3-1.5% based on down payment</span>
                        </div>

                        <div class="input-row">
                            <div class="input-group">
                                <label>Maintenance (%/yr)</label>
                                <input type="number" id="maintenance" value="1" min="0" max="5" step="0.25">
                            </div>
                            <div class="input-group">
                                <label>Utilities ($/mo)</label>
                                <input type="number" id="utilities" value="300" step="25">
                            </div>
                        </div>

                        <div class="input-section-title">Appreciation</div>
                        <div class="input-group">
                            <label>Expected Annual Appreciation (%)</label>
                            <input type="number" id="appreciation" value="3" min="-5" max="15" step="0.5">
                        </div>

                        <div class="input-section-title">Extra Payments</div>
                        <div class="input-row">
                            <div class="input-group">
                                <label>Extra Monthly Principal ($/mo)</label>
                                <input type="number" id="extraMonthly" value="0" min="0" step="50" inputmode="decimal">
                                <span class="hint">Additional principal each month</span>
                            </div>
                            <div class="input-group">
                                <label>One-Time Lump Sum ($)</label>
                                <input type="number" id="lumpSum" value="0" min="0" step="1000" inputmode="decimal">
                                <span class="hint">Applied at purchase toward principal</span>
                            </div>
                        </div>
                        </div><!-- /advanced-inputs -->
                    </div>

                    <!-- Income Tab -->
                    <div id="incomeTab" class="input-tab-content" role="tabpanel" aria-labelledby="tab-income">
                        <div class="input-section-title">Tax Filing</div>

                        <div class="input-row">
                            <div class="input-group">
                                <label>Tax Year</label>
                                <select id="taxYear" onchange="updateTaxRules()">
                                    <option value="2024">2024</option>
                                    <option value="2025" selected>2025</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label>Filing Status</label>
                                <select id="filingStatus" onchange="calculateTakeHome(); updateTaxBrackets()">
                                    <option value="married_jointly" selected>Married Jointly</option>
                                    <option value="single">Single</option>
                                    <option value="head_of_household">Head of Household</option>
                                </select>
                            </div>
                        </div>

                        <div class="input-group">
                            <label>Household Income (auto-calculated)</label>
                            <input type="number" id="annualIncome" value="250000" step="5000" readonly class="readonly-input">
                            <div class="input-hint" id="bracketHint">Federal: 24% | CA: 9.3%</div>
                        </div>

                        <div class="input-row">
                            <div class="input-group">
                                <label>Federal Rate</label>
                                <input type="number" id="federalTax" value="24" readonly class="readonly-input">
                            </div>
                            <div class="input-group">
                                <label>State Rate</label>
                                <input type="number" id="stateTax" value="9.3" readonly class="readonly-input">
                            </div>
                        </div>

                        <div class="input-group">
                            <label>Est. State Tax ($/yr)</label>
                            <input type="number" id="stateIncomeTax" value="15000" readonly class="readonly-input">
                            <div class="input-hint" id="saltHint">For SALT cap calculation</div>
                        </div>

                        <!-- Person 1 Compensation -->
                        <div class="input-section-title" id="person1Title">Person 1 Compensation</div>

                        <div class="input-group">
                            <label>Base Salary ($/yr)</label>
                            <input type="number" id="baseSalary1" value="200000" step="5000" onchange="calculateTakeHome()">
                        </div>

                        <div class="input-row">
                            <div class="input-group">
                                <label>Bonus ($)</label>
                                <input type="number" id="annualBonus1" value="30000" step="1000" onchange="calculateTakeHome()">
                                <div class="input-hint" id="bonusHint1">15%</div>
                            </div>
                            <div class="input-group">
                                <label>Bonus Freq</label>
                                <select id="bonusFreq1" onchange="calculateTakeHome()">
                                    <option value="annual" selected>Annual</option>
                                    <option value="quarterly">Quarterly</option>
                                </select>
                            </div>
                        </div>

                        <div class="input-row">
                            <div class="input-group">
                                <label>RSU ($/yr)</label>
                                <input type="number" id="annualRSU1" value="50000" step="5000" onchange="calculateTakeHome()">
                            </div>
                            <div class="input-group">
                                <label>RSU Vest</label>
                                <select id="rsuFreq1" onchange="calculateTakeHome()">
                                    <option value="quarterly" selected>Quarterly</option>
                                    <option value="annual">Annual</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                        </div>

                        <div class="input-row">
                            <div class="input-group">
                                <label>401k (%)</label>
                                <input type="number" id="retirement401k1" value="6" min="0" max="100" step="1" onchange="calculateTakeHome()">
                                <div class="input-hint" id="contrib401kHint1">$12k/yr</div>
                            </div>
                            <div class="input-group">
                                <label>Pre-tax ($/mo)</label>
                                <input type="number" id="preTaxDeductions1" value="500" step="50" onchange="calculateTakeHome()">
                            </div>
                        </div>

                        <!-- Person 2 Compensation -->
                        <div id="person2Section">
                            <div class="input-section-title">Person 2 Compensation</div>

                            <div class="input-group">
                                <label>Base Salary ($/yr)</label>
                                <input type="number" id="baseSalary2" value="150000" step="5000" onchange="calculateTakeHome()">
                            </div>

                            <div class="input-row">
                                <div class="input-group">
                                    <label>Bonus ($)</label>
                                    <input type="number" id="annualBonus2" value="20000" step="1000" onchange="calculateTakeHome()">
                                    <div class="input-hint" id="bonusHint2">13%</div>
                                </div>
                                <div class="input-group">
                                    <label>Bonus Freq</label>
                                    <select id="bonusFreq2" onchange="calculateTakeHome()">
                                        <option value="annual" selected>Annual</option>
                                        <option value="quarterly">Quarterly</option>
                                    </select>
                                </div>
                            </div>

                            <div class="input-row">
                                <div class="input-group">
                                    <label>RSU ($/yr)</label>
                                    <input type="number" id="annualRSU2" value="30000" step="5000" onchange="calculateTakeHome()">
                                </div>
                                <div class="input-group">
                                    <label>RSU Vest</label>
                                    <select id="rsuFreq2" onchange="calculateTakeHome()">
                                        <option value="quarterly" selected>Quarterly</option>
                                        <option value="annual">Annual</option>
                                        <option value="monthly">Monthly</option>
                                    </select>
                                </div>
                            </div>

                            <div class="input-row">
                                <div class="input-group">
                                    <label>401k (%)</label>
                                    <input type="number" id="retirement401k2" value="6" min="0" max="100" step="1" onchange="calculateTakeHome()">
                                    <div class="input-hint" id="contrib401kHint2">$9k/yr</div>
                                </div>
                                <div class="input-group">
                                    <label>Pre-tax ($/mo)</label>
                                    <input type="number" id="preTaxDeductions2" value="300" step="50" onchange="calculateTakeHome()">
                                </div>
                            </div>
                        </div>

                        <!-- Detailed Income Summary -->
                        <div class="input-section-title">Income Summary</div>
                        <div class="summary-box income">
                            <div class="section-label">Gross Income</div>
                            <div class="flex-between">
                                <span>Base Salary (combined):</span>
                                <span id="summaryBaseSalary">$350,000</span>
                            </div>
                            <div class="flex-between">
                                <span>Bonuses (gross):</span>
                                <span id="summaryBonusGross">$50,000</span>
                            </div>
                            <div class="flex-between muted">
                                <span>&nbsp;&nbsp;‚îî After ~40% withholding:</span>
                                <span id="summaryBonusNet">$39,000</span>
                            </div>
                            <div class="flex-between">
                                <span>RSU Vesting (gross):</span>
                                <span id="summaryRSUGross">$80,000</span>
                            </div>
                            <div class="flex-between muted">
                                <span>&nbsp;&nbsp;‚îî After ~40% withholding:</span>
                                <span id="summaryRSUNet">$48,000</span>
                            </div>
                            <div class="flex-between total-row">
                                <span>Total Gross Comp:</span>
                                <strong id="totalGrossComp">$480,000</strong>
                            </div>
                            <div class="section-label">Deductions</div>
                            <div class="flex-between">
                                <span>401k + Pre-tax:</span>
                                <span id="totalDeductions">-$30,600</span>
                            </div>
                            <div class="flex-between">
                                <span>Est. Annual Taxes:</span>
                                <span id="estimatedTaxes">-$144,000</span>
                            </div>
                            <div class="flex-between muted">
                                <span>&nbsp;&nbsp;‚îî Effective rate:</span>
                                <span id="effectiveTaxRate">30.0%</span>
                            </div>
                        </div>

                        <!-- Monthly Cash Flow Breakdown -->
                        <div class="summary-box cashflow">
                            <div class="box-title">Monthly Cash Flow</div>
                            <div class="flex-between">
                                <span>Base salary (net):</span>
                                <span id="monthlyBaseNet">$18,500</span>
                            </div>
                            <div class="flex-between">
                                <span>+ Quarterly RSU vest (net):</span>
                                <span id="monthlyRSUNet">+$4,000/qtr</span>
                            </div>
                            <div class="flex-between">
                                <span>+ Annual bonus (net):</span>
                                <span id="monthlyBonusNet">+$39,000/yr</span>
                            </div>
                            <div class="flex-between total-row">
                                <span>Avg Monthly Take-Home:</span>
                                <span id="calculatedTakeHome">$25,450</span>
                            </div>
                        </div>

                        <div class="input-row">
                            <div class="input-group">
                                <label style="display: flex; align-items: center; gap: 6px;">
                                    Monthly Take-Home
                                    <input type="checkbox" id="overrideTakeHome" onchange="toggleTakeHomeOverride()" style="width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary);">
                                    <span style="font-size: 0.8rem; color: var(--text-muted); cursor: pointer;" onclick="document.getElementById('overrideTakeHome').click()">Override</span>
                                </label>
                                <input type="number" id="monthlyTakeHome" value="15000" step="500" readonly class="readonly-input">
                                <div class="input-hint">Auto-calculated. Check "Override" to edit manually.</div>
                            </div>
                            <div class="input-group">
                                <label>Other Income ($/mo)</label>
                                <input type="number" id="otherIncome" value="0" step="100">
                            </div>
                        </div>
                    </div>

                    <!-- Expenses Tab -->
                    <div id="expensesTab" class="input-tab-content" role="tabpanel" aria-labelledby="tab-expenses">
                        <div class="input-section-title">Transportation</div>

                        <div class="input-row">
                            <div class="input-group">
                                <label>Car Payment</label>
                                <input type="number" id="expCar" value="500" step="50">
                            </div>
                            <div class="input-group">
                                <label>Gas / Transport</label>
                                <input type="number" id="expGas" value="300" step="25">
                            </div>
                        </div>

                        <div class="input-row">
                            <div class="input-group">
                                <label>Car Insurance</label>
                                <input type="number" id="expCarInsurance" value="200" step="25">
                            </div>
                            <div class="input-group">
                                <label>Health Insurance</label>
                                <input type="number" id="expHealth" value="400" step="50">
                            </div>
                        </div>

                        <div class="input-section-title">Food & Living</div>

                        <div class="input-row">
                            <div class="input-group">
                                <label>Groceries</label>
                                <input type="number" id="expFood" value="800" step="50">
                            </div>
                            <div class="input-group">
                                <label>Dining Out</label>
                                <input type="number" id="expDining" value="400" step="50">
                            </div>
                        </div>

                        <div class="input-row">
                            <div class="input-group">
                                <label>Phone / Internet</label>
                                <input type="number" id="expPhone" value="150" step="25">
                            </div>
                            <div class="input-group">
                                <label>Subscriptions</label>
                                <input type="number" id="expSubscriptions" value="100" step="10">
                            </div>
                        </div>

                        <div class="input-section-title">Family & Debt</div>

                        <div class="input-row">
                            <div class="input-group">
                                <label>Childcare</label>
                                <input type="number" id="expChildcare" value="0" step="100">
                            </div>
                            <div class="input-group">
                                <label>Student Loans</label>
                                <input type="number" id="expStudentLoans" value="0" step="50">
                            </div>
                        </div>

                        <div class="input-row">
                            <div class="input-group">
                                <label>Credit Cards</label>
                                <input type="number" id="expCreditCards" value="0" step="50">
                            </div>
                            <div class="input-group">
                                <label>Other Debt</label>
                                <input type="number" id="expOtherDebt" value="0" step="50">
                            </div>
                        </div>

                        <div class="input-section-title">Lifestyle</div>

                        <div class="input-row">
                            <div class="input-group">
                                <label>Shopping</label>
                                <input type="number" id="expShopping" value="300" step="50">
                            </div>
                            <div class="input-group">
                                <label>Entertainment</label>
                                <input type="number" id="expEntertainment" value="200" step="50">
                            </div>
                        </div>

                        <div class="input-row">
                            <div class="input-group">
                                <label>Medical / Rx</label>
                                <input type="number" id="expMedical" value="100" step="25">
                            </div>
                            <div class="input-group">
                                <label>Pet Expenses</label>
                                <input type="number" id="expPets" value="0" step="25">
                            </div>
                        </div>

                        <div class="input-row">
                            <div class="input-group">
                                <label>Savings</label>
                                <input type="number" id="expSavings" value="1000" step="100">
                            </div>
                            <div class="input-group">
                                <label>Other</label>
                                <input type="number" id="expOther" value="200" step="50">
                            </div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Results Panel -->
            <section aria-label="Results" id="main-content">
                <!-- Calc Mode Switcher -->
                <div class="calc-mode-switcher" role="radiogroup" aria-label="Calculator mode">
                    <button class="calc-mode-btn active" role="radio" aria-checked="true" onclick="setCalcMode('payment')">Monthly Payment</button>
                    <button class="calc-mode-btn" role="radio" aria-checked="false" onclick="setCalcMode('affordability')">How Much Can I Afford?</button>
                </div>
                <!-- Hero Payment Banner -->
                <div class="hero-payment" aria-live="polite">
                    <span class="hero-label" id="heroLabel">Your Monthly Payment</span>
                    <span class="hero-value" id="heroMonthlyPayment">$4,979</span>
                    <span class="hero-sublabel" id="heroPITIBreakdown">P&I $4,046 + Tax $733 + Ins $200</span>
                </div>

                <!-- Summary Cards -->
                <div class="results-grid" aria-live="polite">
                    <div class="result-box highlight" data-tooltip="Down payment + closing costs (origination, appraisal, title, escrow, inspections, prepaid items) + escrow reserves. The cash you need at signing.">
                        <h3><span aria-hidden="true">üíµ</span> Cash Needed at Closing</h3>
                        <div class="value" id="totalCashNeeded">$178,443</div>
                        <div class="subtext">Down payment + closing costs</div>
                    </div>
                    <div class="result-box" data-tooltip="Principal repayment + interest + property tax + homeowners insurance. Your required monthly payment to the lender, including escrow.">
                        <h3><span aria-hidden="true">üè¶</span> Monthly Payment (PITI)</h3>
                        <div class="value" id="monthlyPayment">$4,979</div>
                        <div class="subtext">Principal, Interest, Tax, Insurance</div>
                    </div>
                    <div class="result-box" data-tooltip="PITI + HOA + PMI + maintenance reserves (1% of home value/yr) + utilities. The actual total monthly cost of homeownership.">
                        <h3><span aria-hidden="true">üìä</span> True Monthly Cost</h3>
                        <div class="value" id="trueMonthlyCost">$5,945</div>
                        <div class="subtext">Including maintenance & utilities</div>
                    </div>
                    <div class="result-box success" data-tooltip="True monthly cost minus tax savings from mortgage interest deduction, SALT deduction, and CA homeowners exemption. Your real net housing cost.">
                        <h3><span aria-hidden="true">‚ú®</span> Effective Cost (After Tax)</h3>
                        <div class="value" id="effectiveCost">$5,462</div>
                        <div class="subtext" id="taxSavingsNote">Saving $483/mo in taxes</div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="card" style="margin-top: 24px;">
                    <div class="tabs" role="tablist" aria-label="Result sections">
                        <button class="tab active" role="tab" aria-selected="true" aria-controls="cashflow" id="rtab-cashflow" onclick="showTab('cashflow', this)">Cashflow</button>
                        <button class="tab" role="tab" aria-selected="false" aria-controls="breakdown" id="rtab-breakdown" onclick="showTab('breakdown', this)">Housing Costs</button>
                        <button class="tab" role="tab" aria-selected="false" aria-controls="upfront" id="rtab-upfront" onclick="showTab('upfront', this)">Upfront Costs</button>
                        <button class="tab" role="tab" aria-selected="false" aria-controls="taxes" id="rtab-taxes" onclick="showTab('taxes', this)">Tax Benefits</button>
                        <button class="tab" role="tab" aria-selected="false" aria-controls="wealth" id="rtab-wealth" onclick="showTab('wealth', this)">Wealth Building</button>
                        <button class="tab" role="tab" aria-selected="false" aria-controls="rentvsbuy" id="rtab-rentvsbuy" onclick="showTab('rentvsbuy', this)">Rent vs Buy</button>
                    </div>

                    <!-- Cashflow Tab -->
                    <div id="cashflow" class="tab-content active" role="tabpanel" aria-labelledby="rtab-cashflow">
                        <h2>Monthly Cashflow Analysis</h2>
                        <div class="info-banner" id="cashflowAdvice">
                            <!-- Populated by JS -->
                        </div>

                        <div class="results-grid" style="margin: 20px 0;">
                            <div class="result-box" data-tooltip="Your monthly take-home pay (after taxes, 401k, pre-tax deductions) plus any other income sources.">
                                <h3><span aria-hidden="true">üìà</span> Total Income</h3>
                                <div class="value" id="totalIncome">$15,000</div>
                            </div>
                            <div class="result-box" data-tooltip="PITI + HOA + PMI + maintenance + utilities. Aim for under 28-30% of gross income.">
                                <h3><span aria-hidden="true">üè†</span> Housing Cost</h3>
                                <div class="value" id="housingCostSummary">$5,945</div>
                                <div class="subtext" id="housingPercent">39.6% of income</div>
                            </div>
                            <div class="result-box" data-tooltip="All non-housing monthly expenses: transportation, food, health, debt payments, lifestyle, and savings.">
                                <h3><span aria-hidden="true">üí≥</span> Other Expenses</h3>
                                <div class="value" id="otherExpensesSummary">$4,650</div>
                                <div class="subtext" id="otherPercent">31.0% of income</div>
                            </div>
                            <div class="result-box" id="cashflowBox" data-tooltip="Income minus all expenses. Positive = money left over each month. Negative = you're spending more than you earn.">
                                <h3><span aria-hidden="true">üíµ</span> Monthly Cashflow</h3>
                                <div class="value" id="monthlyCashflow">$4,405</div>
                                <div class="subtext" id="cashflowPercent">29.4% remaining</div>
                            </div>
                        </div>

                        <div class="cashflow-split" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <h3 class="section-gap">DTI Ratios (Debt-to-Income)</h3>
                                <div class="table-scroll-wrapper">
                                <table class="breakdown-table" id="dtiTable">
                                    <!-- Populated by JS -->
                                </table>
                                </div>
                            </div>
                            <div>
                                <h3 class="section-gap">Expense Breakdown</h3>
                                <div class="chart-container chart-container-sm">
                                    <canvas id="cashflowChart" role="img" aria-label="Expense breakdown bar chart showing housing vs personal expenses"></canvas>
                                    <div class="sr-only" id="cashflowChartTable"></div>
                                </div>
                            </div>
                        </div>

                        <h3 style="margin: 20px 0 12px 0;">Full Budget Breakdown</h3>
                        <div class="table-scroll-wrapper">
                        <table class="breakdown-table" id="budgetBreakdown">
                            <!-- Populated by JS -->
                        </table>
                        </div>
                    </div>

                    <!-- Cost Breakdown Tab -->
                    <div id="breakdown" class="tab-content" role="tabpanel" aria-labelledby="rtab-breakdown">
                        <h2>Monthly Housing Cost Breakdown</h2>
                        <div class="table-scroll-wrapper">
                        <table class="breakdown-table" id="monthlyBreakdown">
                            <!-- Populated by JS -->
                        </table>
                        </div>
                        <div class="chart-container">
                            <canvas id="monthlyChart" role="img" aria-label="Monthly housing cost breakdown doughnut chart"></canvas>
                            <div class="sr-only" id="monthlyChartTable"></div>
                        </div>
                        <h2 style="margin-top: 30px;">PMI Tracker & Removal Timeline</h2>
                        <div class="info-banner" id="pmiAdvice"></div>
                        <div class="pmi-stat-grid" id="pmiStats"></div>
                        <div id="pmiTimeline"></div>
                        <div id="pmiDetails"></div>
                    </div>

                    <!-- Upfront Costs Tab -->
                    <div id="upfront" class="tab-content" role="tabpanel" aria-labelledby="rtab-upfront">
                        <h2>Upfront Costs at Closing</h2>
                        <div class="table-scroll-wrapper">
                        <table class="breakdown-table" id="upfrontBreakdown">
                            <!-- Populated by JS -->
                        </table>
                        </div>
                    </div>

                    <!-- Tax Benefits Tab -->
                    <div id="taxes" class="tab-content" role="tabpanel" aria-labelledby="rtab-taxes">
                        <h2>Tax Benefits Analysis (Year 1)</h2>
                        <div class="info-banner" id="itemizeAdvice">
                            <!-- Populated by JS -->
                        </div>
                        <div class="table-scroll-wrapper">
                        <table class="breakdown-table" id="taxBreakdown">
                            <!-- Populated by JS -->
                        </table>
                        </div>
                    </div>

                    <!-- Wealth Building Tab -->
                    <div id="wealth" class="tab-content" role="tabpanel" aria-labelledby="rtab-wealth">
                        <div id="extraPaymentSavings" class="info-banner" style="display: none;" role="status">
                            <strong>Extra Payment Impact:</strong> <span id="extraPaymentText"></span>
                        </div>
                        <h2>10-Year Wealth Building Projection</h2>
                        <div class="results-grid" style="margin-bottom: 20px;">
                            <div class="result-box">
                                <h3><span aria-hidden="true">üè†</span> Home Value (Year 10)</h3>
                                <div class="value" id="homeValue10">$1,075,133</div>
                            </div>
                            <div class="result-box">
                                <h3><span aria-hidden="true">üí∞</span> Total Equity</h3>
                                <div class="value" id="equity10">$532,566</div>
                            </div>
                            <div class="result-box">
                                <h3><span aria-hidden="true">üìà</span> Total Wealth Impact</h3>
                                <div class="value" id="wealthImpact10">$581,952</div>
                                <div class="subtext">Equity + Tax Savings</div>
                            </div>
                        </div>
                        <div class="chart-container chart-container-lg">
                            <canvas id="wealthChart" role="img" aria-label="10-year wealth building projection line chart"></canvas>
                            <div class="sr-only" id="wealthChartTable"></div>
                        </div>
                        <h2 style="margin-top: 30px;">Yearly Amortization Schedule</h2>
                        <div class="scroll-table">
                            <table class="amortization-table" id="amortizationTable">
                                <!-- Populated by JS -->
                            </table>
                        </div>
                    </div>

                    <!-- Rent vs Buy Tab -->
                    <div id="rentvsbuy" class="tab-content" role="tabpanel" aria-labelledby="rtab-rentvsbuy">
                        <h2>Rent vs Buy Comparison</h2>
                        <div class="input-row" style="margin-bottom: 20px;">
                            <div class="input-group">
                                <label>Monthly Rent ($)</label>
                                <input type="number" id="rentAmount" value="3000" min="0" step="100" oninput="debouncedCalculate()">
                            </div>
                            <div class="input-group">
                                <label>Annual Rent Increase (%)</label>
                                <input type="number" id="rentIncrease" value="3" min="0" max="15" step="0.5" oninput="debouncedCalculate()">
                            </div>
                            <div class="input-group">
                                <label>Investment Return (%)</label>
                                <input type="number" id="investReturn" value="7" min="0" max="20" step="0.5" oninput="debouncedCalculate()">
                            </div>
                        </div>

                        <div id="rentVsBuyAdvice" class="info-banner" style="margin-bottom: 16px;"></div>

                        <div class="results-grid" style="margin-bottom: 20px;">
                            <div class="result-box">
                                <h3>Break-Even Year</h3>
                                <div class="value" id="breakEvenYear">‚Äî</div>
                            </div>
                            <div class="result-box">
                                <h3>10-Year Rent Cost</h3>
                                <div class="value" id="totalRentCost">‚Äî</div>
                            </div>
                            <div class="result-box">
                                <h3>10-Year Buy Cost</h3>
                                <div class="value" id="totalBuyCost">‚Äî</div>
                            </div>
                        </div>

                        <div class="chart-container chart-container-lg">
                            <canvas id="rentVsBuyChart" role="img" aria-label="Rent vs Buy wealth comparison line chart over 10 years"></canvas>
                            <div class="sr-only" id="rentVsBuyChartTable"></div>
                        </div>

                        <h2 style="margin-top: 30px;">Year-by-Year Comparison</h2>
                        <div class="scroll-table">
                            <table class="amortization-table" id="rentVsBuyTable">
                                <!-- Populated by JS -->
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Scenario Comparison -->
            <div class="scenario-comparison card" id="scenarioSection" style="display: none;">
                <h2><span aria-hidden="true">üìã</span> Scenario Comparison</h2>
                <div class="scenario-grid" id="scenarioGrid"></div>
            </div>

            <!-- Legal Disclaimer -->
            <div class="legal-disclaimer" id="disclaimer" role="note" aria-label="Legal disclaimer">
                <strong>Important Disclaimer</strong>
                <p>This calculator is for educational and illustrative purposes only. It does not constitute financial, tax, or legal advice. Results are estimates based on simplified assumptions and may not reflect your actual costs, tax situation, or loan terms. Tax laws change frequently; calculations use data available at time of publication and may not reflect current legislation. Consult a licensed mortgage professional, tax advisor, or financial planner before making any real estate or financial decisions.</p>
            </div>

            <!-- Methodology & Assumptions -->
            <details class="methodology-section card" style="margin-top: 24px;">
                <summary>Methodology & Assumptions</summary>
                <div class="methodology-content">
                    <h4>Mortgage Calculation</h4>
                    <ul>
                        <li>Monthly P&I uses the standard amortization formula: M = P[r(1+r)<sup>n</sup>]/[(1+r)<sup>n</sup> - 1]</li>
                        <li>PMI rate defaults to 0.5% annually (typical range: 0.3-1.5% based on credit score and LTV)</li>
                        <li>ARM adjustments model annual rate changes after the fixed period with a lifetime cap</li>
                        <li>Closing costs use typical percentages: origination 0.75%, title 0.3%, escrow 0.2% (vary by state)</li>
                    </ul>
                    <h4>Tax Benefits</h4>
                    <ul>
                        <li>Federal mortgage interest deduction on first $750,000 of loan (post-2017 purchases)</li>
                        <li>SALT cap: $10,000 (2024) / $40,000 (2025+) with phaseout for high earners above $400k</li>
                        <li>Standard deduction vs. itemized comparison determines actual benefit</li>
                        <li>Homestead exemption varies by state (e.g., CA: $7k assessed value, TX: $100k, FL: unlimited for primary residence)</li>
                    </ul>
                    <h4>Income & Take-Home</h4>
                    <ul>
                        <li>Federal tax uses marginal bracket system (10%-37%) with filing status adjustments</li>
                        <li>State income tax: ranges from 0% (9 states) to 13.3% (CA). Progressive brackets for top states, effective rates for others.</li>
                        <li>FICA: 6.2% Social Security (up to wage base), 1.45% Medicare (+ 0.9% above threshold)</li>
                        <li>Bonus/RSU withholding estimated at ~40% (federal supplemental + state + FICA)</li>
                    </ul>
                    <h4>What's NOT Included</h4>
                    <ul>
                        <li>Capital gains exclusion ($250k/$500k) on primary residence sale</li>
                        <li>Property tax assessment caps (e.g., CA Prop 13 2% cap) ‚Äî calculator uses appreciation rate for projections</li>
                        <li>Rental income potential or opportunity cost of down payment invested elsewhere</li>
                        <li>Inflation adjustment on future expenses or income growth</li>
                        <li>Mortgage points, buydowns, or refinancing scenarios</li>
                    </ul>
                    <h4>Data Sources</h4>
                    <ul>
                        <li>Federal tax brackets: IRS Revenue Procedures 2024-40, 2025-11</li>
                        <li>State tax data: respective state tax authority websites (FTB.ca.gov, tax.ny.gov, etc.)</li>
                        <li>Social Security wage base: SSA.gov</li>
                        <li>SDI rates: state disability/PFML programs (CA EDD, NY WCB, NJ DWD, HI DLI, RI DLT)</li>
                        <li>Property tax rates: state/county assessor offices, Tax Foundation averages</li>
                    </ul>
                </div>
            </details>

            <!-- Educational SEO Content -->
            <section class="card" style="margin-top: 24px;">
                <h2>How Mortgage Payments Work</h2>
                <p style="font-size: 0.9rem; line-height: 1.6; color: var(--text-muted);">Your monthly mortgage payment (PITI) includes four components: <strong>Principal</strong> (paying down your loan balance), <strong>Interest</strong> (cost of borrowing), <strong>Taxes</strong> (property taxes escrowed monthly), and <strong>Insurance</strong> (homeowners insurance + PMI if applicable). In the early years, most of your payment goes toward interest. Over time, the principal portion grows ‚Äî this is called amortization.</p>
                <h2 style="margin-top: 16px;">Understanding DTI Ratios</h2>
                <p style="font-size: 0.9rem; line-height: 1.6; color: var(--text-muted);">Lenders use two debt-to-income (DTI) ratios to assess affordability. The <strong>front-end ratio</strong> (housing DTI) compares your total housing costs to gross monthly income ‚Äî most lenders prefer this under 28%. The <strong>back-end ratio</strong> includes all debts (car loans, student loans, credit cards) and should generally stay below 36-43%. This calculator shows both ratios in the Cash Flow tab.</p>
            </section>

            <!-- FAQ Section -->
            <section class="card" style="margin-top: 24px;" id="faq">
                <h2><span aria-hidden="true">‚ùì</span> Frequently Asked Questions</h2>
                <details style="margin-top: 16px; border-bottom: 1px solid var(--border); padding-bottom: 12px;">
                    <summary style="cursor: pointer; font-weight: 600; font-size: 0.95rem; padding: 8px 0;">How much house can I afford?</summary>
                    <p style="font-size: 0.9rem; line-height: 1.6; color: var(--text-muted); padding: 8px 0 4px 0;">Most lenders use the 28/36 rule: your monthly housing costs (mortgage, taxes, insurance) should not exceed 28% of your gross monthly income, and total debt payments should stay below 36%. Use the <strong>Affordability</strong> tab in this calculator to see your maximum home price based on your specific income, debts, and down payment amount.</p>
                </details>
                <details style="border-bottom: 1px solid var(--border); padding-bottom: 12px;">
                    <summary style="cursor: pointer; font-weight: 600; font-size: 0.95rem; padding: 8px 0;">What is PMI and when can I remove it?</summary>
                    <p style="font-size: 0.9rem; line-height: 1.6; color: var(--text-muted); padding: 8px 0 4px 0;">Private Mortgage Insurance (PMI) is required when your down payment is less than 20% of the home price. It protects the lender if you default and typically costs 0.3%-1.5% of the loan amount annually. Under the <a href="https://www.consumerfinance.gov/ask-cfpb/when-can-i-remove-private-mortgage-insurance-pmi-from-my-loan-en-202/" style="color: var(--primary);">Homeowners Protection Act</a>, you can request PMI removal at 80% loan-to-value (LTV) and it's automatically cancelled at 78% LTV. Check the <strong>Housing Costs</strong> tab to see your PMI timeline.</p>
                </details>
                <details style="border-bottom: 1px solid var(--border); padding-bottom: 12px;">
                    <summary style="cursor: pointer; font-weight: 600; font-size: 0.95rem; padding: 8px 0;">Should I rent or buy a home?</summary>
                    <p style="font-size: 0.9rem; line-height: 1.6; color: var(--text-muted); padding: 8px 0 4px 0;">The answer depends on how long you plan to stay (typically 5+ years to break even on buying), local market conditions, and your financial readiness. Key factors include the price-to-rent ratio in your area, your down payment savings, credit score, and job stability. Use the <strong>Rent vs Buy</strong> tab to compare total costs over time, including tax benefits, equity building, and investment opportunity cost of your down payment.</p>
                </details>
                <details style="border-bottom: 1px solid var(--border); padding-bottom: 12px;">
                    <summary style="cursor: pointer; font-weight: 600; font-size: 0.95rem; padding: 8px 0;">How do extra mortgage payments save money?</summary>
                    <p style="font-size: 0.9rem; line-height: 1.6; color: var(--text-muted); padding: 8px 0 4px 0;">Extra payments go directly toward your principal balance, reducing the total interest charged over the life of the loan. Even small additional payments can save tens of thousands of dollars. For example, adding $200/month to a $400,000 30-year mortgage at 7% can save over $100,000 in interest and pay off the loan 7 years early. Enter extra payments in the <strong>Property</strong> input tab to see your savings.</p>
                </details>
                <details style="border-bottom: 1px solid var(--border); padding-bottom: 12px;">
                    <summary style="cursor: pointer; font-weight: 600; font-size: 0.95rem; padding: 8px 0;">What are typical closing costs?</summary>
                    <p style="font-size: 0.9rem; line-height: 1.6; color: var(--text-muted); padding: 8px 0 4px 0;">Closing costs typically range from 2-5% of the purchase price. They include loan origination fees (0.5-1%), title insurance (0.5-1%), appraisal ($300-$600), home inspection ($300-$500), escrow and recording fees, and prepaid items like property taxes and homeowners insurance. This calculator estimates closing costs and includes them in the <strong>Wealth Building</strong> tab's net worth projection.</p>
                </details>
                <details>
                    <summary style="cursor: pointer; font-weight: 600; font-size: 0.95rem; padding: 8px 0;">How does this calculator work?</summary>
                    <p style="font-size: 0.9rem; line-height: 1.6; color: var(--text-muted); padding: 8px 0 4px 0;">This calculator uses the standard amortization formula to compute monthly principal and interest payments. It adds property taxes (using county-level rates for all 50 US states plus DC sourced from county assessor offices and the Tax Foundation), homeowners insurance, PMI, HOA fees, and maintenance costs. Tax benefits are modeled by comparing standard vs. itemized deductions using current <a href="https://www.irs.gov/newsroom/irs-provides-tax-inflation-adjustments-for-tax-year-2026" style="color: var(--primary);">IRS tax brackets</a>. All calculations run entirely in your browser ‚Äî no data is sent to any server.</p>
                </details>
            </section>

            <!-- Footer -->
            <footer class="site-footer" role="contentinfo">
                <p>v1.0 &middot; Last updated February 2026 &middot; <a href="#disclaimer">Disclaimer</a></p>
                <p>Free mortgage calculator ‚Äî no login, no ads, no data collection. All calculations run entirely in your browser.</p>
                <p>Tax data verified through 2026. Not affiliated with any financial institution.</p>
            </footer>
        </main>
    </div>

    <noscript><p style="text-align:center;padding:40px;">This calculator requires JavaScript to function. Please enable JavaScript in your browser.</p></noscript>

    <script>
        // ========================================
        // GLOBAL ERROR HANDLING
        // ========================================
        window.onerror = function(msg, source, lineno, colno, error) {
            showError('Unexpected error. Please try refreshing the page.');
            console.error('Global error:', msg, source, lineno, colno, error);
            return true;
        };
        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
        });

        function showError(msg) {
            const banner = document.getElementById('errorBanner');
            if (banner) {
                document.getElementById('errorMessage').textContent = msg;
                banner.style.display = 'block';
            }
        }
        function dismissError() {
            const banner = document.getElementById('errorBanner');
            if (banner) banner.style.display = 'none';
        }

        // ========================================
        // CALCULATOR LOGIC
        // ========================================

        function getInputs() {
            const taxYear = document.getElementById('taxYear').value;
            const filingStatus = document.getElementById('filingStatus').value;
            const annualIncome = parseFloat(document.getElementById('annualIncome').value) || 0;

            return {
                purchasePrice: parseFloat(document.getElementById('purchasePrice').value) || 0,
                downPaymentPercent: parseFloat(document.getElementById('downPaymentPercent').value) || 0,
                interestRate: parseFloat(document.getElementById('interestRate').value) || 0,
                loanTerm: parseInt(document.getElementById('loanTerm').value) || 30,
                propertyTaxRate: parseFloat(document.getElementById('propertyTaxRate').value) || 0,
                melloRoos: parseFloat(document.getElementById('melloRoos').value) || 0,
                insurance: parseFloat(document.getElementById('insurance').value) || 0,
                hoa: parseFloat(document.getElementById('hoa').value) || 0,
                maintenance: parseFloat(document.getElementById('maintenance').value) || 0,
                utilities: parseFloat(document.getElementById('utilities').value) || 0,
                filingStatus: filingStatus,
                taxYear: taxYear,
                annualIncome: annualIncome,
                federalTax: parseFloat(document.getElementById('federalTax').value) || 0,
                stateTax: parseFloat(document.getElementById('stateTax').value) || 0,
                stateIncomeTax: parseFloat(document.getElementById('stateIncomeTax').value) || 0,
                appreciation: parseFloat(document.getElementById('appreciation').value) || 0,
                // Dynamic values based on year (from TAX_DATA)
                saltCap: getTaxData(taxYear).saltCap,
                standardDeduction: getTaxData(taxYear).standardDeduction[filingStatus] || 29200,
                stateCode: (document.getElementById('stateSelect') || {}).value || 'CA',
                // ARM settings
                loanType: document.getElementById('loanType').value,
                armAdjustment: parseFloat(document.getElementById('armAdjustment').value) || 0,
                armCap: parseFloat(document.getElementById('armCap').value) || 15,
                // PMI
                pmiRate: parseFloat(document.getElementById('pmiRate').value) || 0.5,
                // Extra payments
                extraMonthly: parseFloat(document.getElementById('extraMonthly').value) || 0,
                lumpSum: parseFloat(document.getElementById('lumpSum').value) || 0,
                // Monthly income
                monthlyTakeHome: parseFloat(document.getElementById('monthlyTakeHome').value) || 0,
                otherIncome: parseFloat(document.getElementById('otherIncome').value) || 0,
                // Monthly expenses
                expenses: {
                    car: parseFloat(document.getElementById('expCar').value) || 0,
                    gas: parseFloat(document.getElementById('expGas').value) || 0,
                    carInsurance: parseFloat(document.getElementById('expCarInsurance').value) || 0,
                    health: parseFloat(document.getElementById('expHealth').value) || 0,
                    food: parseFloat(document.getElementById('expFood').value) || 0,
                    dining: parseFloat(document.getElementById('expDining').value) || 0,
                    phone: parseFloat(document.getElementById('expPhone').value) || 0,
                    subscriptions: parseFloat(document.getElementById('expSubscriptions').value) || 0,
                    childcare: parseFloat(document.getElementById('expChildcare').value) || 0,
                    studentLoans: parseFloat(document.getElementById('expStudentLoans').value) || 0,
                    creditCards: parseFloat(document.getElementById('expCreditCards').value) || 0,
                    otherDebt: parseFloat(document.getElementById('expOtherDebt').value) || 0,
                    shopping: parseFloat(document.getElementById('expShopping').value) || 0,
                    entertainment: parseFloat(document.getElementById('expEntertainment').value) || 0,
                    medical: parseFloat(document.getElementById('expMedical').value) || 0,
                    pets: parseFloat(document.getElementById('expPets').value) || 0,
                    savings: parseFloat(document.getElementById('expSavings').value) || 0,
                    other: parseFloat(document.getElementById('expOther').value) || 0,
                }
            };
        }

        function updatePropertyTaxRate() {
            const select = document.getElementById('countySelect');
            const rateInput = document.getElementById('propertyTaxRate');
            if (select.value !== 'custom') {
                rateInput.value = select.value;
                calculate();
            }
        }

        // ========================================
        // COUNTY PROPERTY TAX DATA (effective rates by county)
        // Source: SmartAsset 2025-2026, Tax Foundation
        // ========================================
        const COUNTY_TAX_DATA = {
            AL: [
                { name: 'Alabama Average', rate: 0.40 },
                { name: 'Jefferson County', rate: 0.59 },
                { name: 'Shelby County', rate: 0.48 },
                { name: 'Mobile County', rate: 0.46 },
                { name: 'Lee County', rate: 0.44 },
                { name: 'Montgomery County', rate: 0.44 },
                { name: 'Madison County', rate: 0.41 },
                { name: 'Calhoun County', rate: 0.40 },
                { name: 'Lauderdale County', rate: 0.40 },
                { name: 'Baldwin County', rate: 0.32 },
                { name: 'Tuscaloosa County', rate: 0.31 },
            ],
            AK: [
                { name: 'Alaska Average', rate: 1.04 },
                { name: 'Anchorage Municipality', rate: 1.22 },
                { name: 'Fairbanks North Star Borough', rate: 1.04 },
                { name: 'Matanuska-Susitna Borough', rate: 0.99 },
            ],
            AZ: [
                { name: 'Arizona Average', rate: 0.62 },
                { name: 'Pima County', rate: 0.65 },
                { name: 'Navajo County', rate: 0.62 },
                { name: 'Yuma County', rate: 0.54 },
                { name: 'Cochise County', rate: 0.53 },
                { name: 'Coconino County', rate: 0.42 },
                { name: 'Pinal County', rate: 0.41 },
                { name: 'Maricopa County', rate: 0.40 },
                { name: 'Mohave County', rate: 0.39 },
                { name: 'Yavapai County', rate: 0.37 },
            ],
            AR: [
                { name: 'Arkansas Average', rate: 0.63 },
                { name: 'Pulaski County', rate: 0.74 },
                { name: 'Saline County', rate: 0.58 },
                { name: 'Craighead County', rate: 0.55 },
                { name: 'Sebastian County', rate: 0.55 },
                { name: 'Benton County', rate: 0.54 },
                { name: 'Washington County', rate: 0.49 },
                { name: 'Faulkner County', rate: 0.48 },
                { name: 'Garland County', rate: 0.44 },
            ],
            CA: [
                { name: 'California Average', rate: 1.10 },
                { name: 'Los Angeles County', rate: 1.16 },
                { name: 'San Diego County', rate: 1.12 },
                { name: 'Orange County', rate: 1.13 },
                { name: 'Alameda County', rate: 1.24 },
                { name: 'Santa Clara County', rate: 1.18 },
                { name: 'San Francisco', rate: 1.09 },
                { name: 'Riverside County', rate: 1.25 },
                { name: 'Sacramento County', rate: 1.20 },
                { name: 'San Mateo County', rate: 1.15 },
                { name: 'Modoc / Sierra County', rate: 1.00 },
                { name: 'High Special Assessment', rate: 1.50 },
            ],
            CO: [
                { name: 'Colorado Average', rate: 0.51 },
                { name: 'Douglas County', rate: 0.61 },
                { name: 'Adams County', rate: 0.60 },
                { name: 'Boulder County', rate: 0.55 },
                { name: 'Weld County', rate: 0.54 },
                { name: 'Arapahoe County', rate: 0.52 },
                { name: 'Larimer County', rate: 0.52 },
                { name: 'Jefferson County', rate: 0.51 },
                { name: 'Denver County', rate: 0.48 },
                { name: 'El Paso County', rate: 0.43 },
            ],
            CT: [
                { name: 'Connecticut Average', rate: 2.15 },
                { name: 'Hartford County', rate: 2.40 },
                { name: 'New Haven County', rate: 2.38 },
                { name: 'Tolland County', rate: 2.24 },
                { name: 'Litchfield County', rate: 2.07 },
                { name: 'Middlesex County', rate: 2.01 },
                { name: 'New London County', rate: 1.95 },
                { name: 'Windham County', rate: 1.93 },
                { name: 'Fairfield County', rate: 1.83 },
            ],
            DE: [
                { name: 'Delaware Average', rate: 0.57 },
                { name: 'New Castle County', rate: 0.67 },
                { name: 'Kent County', rate: 0.42 },
                { name: 'Sussex County', rate: 0.31 },
            ],
            DC: [
                { name: 'District of Columbia', rate: 0.56 },
            ],
            FL: [
                { name: 'Florida Average', rate: 0.80 },
                { name: 'St. Lucie County', rate: 1.00 },
                { name: 'Broward County', rate: 0.94 },
                { name: 'Alachua County', rate: 0.92 },
                { name: 'Palm Beach County', rate: 0.83 },
                { name: 'Hillsborough County', rate: 0.82 },
                { name: 'Duval County', rate: 0.77 },
                { name: 'Miami-Dade County', rate: 0.76 },
                { name: 'Orange County', rate: 0.75 },
                { name: 'Sarasota County', rate: 0.74 },
                { name: 'Brevard County', rate: 0.70 },
                { name: 'Pinellas County', rate: 0.67 },
                { name: 'Collier County', rate: 0.57 },
            ],
            GA: [
                { name: 'Georgia Average', rate: 0.87 },
                { name: 'DeKalb County', rate: 0.96 },
                { name: 'Gwinnett County', rate: 0.92 },
                { name: 'Fulton County', rate: 0.86 },
                { name: 'Chatham County', rate: 0.81 },
                { name: 'Richmond County', rate: 0.79 },
                { name: 'Cobb County', rate: 0.68 },
                { name: 'Cherokee County', rate: 0.68 },
                { name: 'Forsyth County', rate: 0.68 },
                { name: 'Douglas County', rate: 0.69 },
            ],
            HI: [
                { name: 'Hawaii Average', rate: 0.27 },
                { name: 'Honolulu County', rate: 0.29 },
                { name: 'Hawaii County', rate: 0.28 },
                { name: 'Kauai County', rate: 0.23 },
                { name: 'Maui County', rate: 0.15 },
            ],
            ID: [
                { name: 'Idaho Average', rate: 0.63 },
                { name: 'Nez Perce County', rate: 0.92 },
                { name: 'Latah County', rate: 0.75 },
                { name: 'Madison County', rate: 0.66 },
                { name: 'Twin Falls County', rate: 0.55 },
                { name: 'Bannock County', rate: 0.52 },
                { name: 'Bonner County', rate: 0.47 },
                { name: 'Canyon County', rate: 0.47 },
                { name: 'Bonneville County', rate: 0.46 },
                { name: 'Ada County', rate: 0.44 },
                { name: 'Kootenai County', rate: 0.36 },
            ],
            IL: [
                { name: 'Illinois Average', rate: 2.07 },
                { name: 'Lake County', rate: 2.43 },
                { name: 'McHenry County', rate: 2.18 },
                { name: 'Winnebago County', rate: 2.16 },
                { name: 'Will County', rate: 2.12 },
                { name: 'Kane County', rate: 2.05 },
                { name: 'Sangamon County', rate: 1.94 },
                { name: 'DuPage County', rate: 1.91 },
                { name: 'Cook County', rate: 1.89 },
                { name: 'St. Clair County', rate: 1.77 },
                { name: 'Madison County', rate: 1.75 },
            ],
            IN: [
                { name: 'Indiana Average', rate: 0.81 },
                { name: 'Marion County', rate: 0.93 },
                { name: 'Lake County', rate: 0.92 },
                { name: 'Hamilton County', rate: 0.89 },
                { name: 'St. Joseph County', rate: 0.89 },
                { name: 'Porter County', rate: 0.84 },
                { name: 'Elkhart County', rate: 0.82 },
                { name: 'Allen County', rate: 0.79 },
                { name: 'Hendricks County', rate: 0.79 },
                { name: 'Vanderburgh County', rate: 0.74 },
                { name: 'Tippecanoe County', rate: 0.64 },
            ],
            IA: [
                { name: 'Iowa Average', rate: 1.52 },
                { name: 'Linn County', rate: 1.56 },
                { name: 'Polk County', rate: 1.51 },
                { name: 'Johnson County', rate: 1.50 },
                { name: 'Pottawattamie County', rate: 1.38 },
                { name: 'Woodbury County', rate: 1.38 },
                { name: 'Black Hawk County', rate: 1.36 },
                { name: 'Scott County', rate: 1.33 },
                { name: 'Dallas County', rate: 1.32 },
                { name: 'Story County', rate: 1.24 },
                { name: 'Dubuque County', rate: 1.15 },
            ],
            KS: [
                { name: 'Kansas Average', rate: 1.33 },
                { name: 'Riley County', rate: 1.53 },
                { name: 'Wyandotte County', rate: 1.44 },
                { name: 'Shawnee County', rate: 1.42 },
                { name: 'Butler County', rate: 1.41 },
                { name: 'Douglas County', rate: 1.25 },
                { name: 'Leavenworth County', rate: 1.18 },
                { name: 'Sedgwick County', rate: 1.14 },
                { name: 'Johnson County', rate: 1.09 },
            ],
            KY: [
                { name: 'Kentucky Average', rate: 0.83 },
                { name: 'Campbell County', rate: 0.95 },
                { name: 'Kenton County', rate: 0.93 },
                { name: 'Jefferson County', rate: 0.86 },
                { name: 'Fayette County', rate: 0.83 },
                { name: 'Boone County', rate: 0.80 },
                { name: 'Daviess County', rate: 0.78 },
                { name: 'Bullitt County', rate: 0.76 },
                { name: 'Madison County', rate: 0.67 },
                { name: 'Hardin County', rate: 0.62 },
                { name: 'Warren County', rate: 0.61 },
            ],
            LA: [
                { name: 'Louisiana Average', rate: 0.55 },
                { name: 'Orleans Parish', rate: 0.88 },
                { name: 'East Baton Rouge Parish', rate: 0.70 },
                { name: 'St. Tammany Parish', rate: 0.67 },
                { name: 'Bossier Parish', rate: 0.59 },
                { name: 'Caddo Parish', rate: 0.57 },
                { name: 'Ascension Parish', rate: 0.57 },
                { name: 'Lafayette Parish', rate: 0.55 },
                { name: 'Jefferson Parish', rate: 0.53 },
                { name: 'Calcasieu Parish', rate: 0.50 },
                { name: 'Livingston Parish', rate: 0.41 },
            ],
            ME: [
                { name: 'Maine Average', rate: 1.24 },
                { name: 'Sagadahoc County', rate: 1.16 },
                { name: 'Knox County', rate: 1.06 },
                { name: 'Aroostook County', rate: 1.04 },
                { name: 'Kennebec County', rate: 1.00 },
                { name: 'Penobscot County', rate: 0.99 },
                { name: 'Cumberland County', rate: 0.97 },
                { name: 'Androscoggin County', rate: 0.96 },
                { name: 'York County', rate: 0.86 },
                { name: 'Hancock County', rate: 0.81 },
            ],
            MD: [
                { name: 'Maryland Average', rate: 1.05 },
                { name: 'Baltimore City', rate: 1.40 },
                { name: "Prince George's County", rate: 1.12 },
                { name: 'Howard County', rate: 1.11 },
                { name: 'Baltimore County', rate: 1.03 },
                { name: 'Charles County', rate: 1.01 },
                { name: 'Frederick County', rate: 0.94 },
                { name: 'Montgomery County', rate: 0.89 },
                { name: 'Carroll County', rate: 0.85 },
                { name: 'Anne Arundel County', rate: 0.83 },
                { name: 'Harford County', rate: 0.80 },
            ],
            MA: [
                { name: 'Massachusetts Average', rate: 1.15 },
                { name: 'Hampden County', rate: 1.39 },
                { name: 'Hampshire County', rate: 1.38 },
                { name: 'Worcester County', rate: 1.22 },
                { name: 'Plymouth County', rate: 1.08 },
                { name: 'Norfolk County', rate: 1.01 },
                { name: 'Bristol County', rate: 1.01 },
                { name: 'Middlesex County', rate: 1.00 },
                { name: 'Essex County', rate: 0.99 },
                { name: 'Suffolk County', rate: 0.66 },
                { name: 'Barnstable County', rate: 0.63 },
            ],
            MI: [
                { name: 'Michigan Average', rate: 1.38 },
                { name: 'Ingham County', rate: 1.76 },
                { name: 'Saginaw County', rate: 1.52 },
                { name: 'Wayne County', rate: 1.51 },
                { name: 'Washtenaw County', rate: 1.47 },
                { name: 'Kalamazoo County', rate: 1.36 },
                { name: 'Genesee County', rate: 1.28 },
                { name: 'Macomb County', rate: 1.28 },
                { name: 'Oakland County', rate: 1.23 },
                { name: 'Kent County', rate: 1.03 },
                { name: 'Ottawa County', rate: 0.99 },
            ],
            MN: [
                { name: 'Minnesota Average', rate: 1.05 },
                { name: 'Ramsey County', rate: 1.27 },
                { name: 'Hennepin County', rate: 1.17 },
                { name: 'Olmsted County', rate: 1.09 },
                { name: 'Washington County', rate: 1.01 },
                { name: 'Stearns County', rate: 1.00 },
                { name: 'St. Louis County', rate: 0.99 },
                { name: 'Dakota County', rate: 0.99 },
                { name: 'Scott County', rate: 0.97 },
                { name: 'Wright County', rate: 0.95 },
                { name: 'Anoka County', rate: 0.94 },
            ],
            MS: [
                { name: 'Mississippi Average', rate: 0.65 },
                { name: 'Hinds County', rate: 0.83 },
                { name: 'Forrest County', rate: 0.82 },
                { name: 'Lauderdale County', rate: 0.80 },
                { name: 'Lee County', rate: 0.72 },
                { name: 'Jackson County', rate: 0.66 },
                { name: 'Madison County', rate: 0.65 },
                { name: 'Lamar County', rate: 0.63 },
                { name: 'Harrison County', rate: 0.62 },
                { name: 'Rankin County', rate: 0.56 },
                { name: 'DeSoto County', rate: 0.55 },
            ],
            MO: [
                { name: 'Missouri Average', rate: 0.91 },
                { name: 'St. Louis County', rate: 1.14 },
                { name: 'Jackson County', rate: 1.11 },
                { name: 'St. Charles County', rate: 1.05 },
                { name: 'Clay County', rate: 1.04 },
                { name: 'St. Louis City', rate: 1.02 },
                { name: 'Platte County', rate: 0.99 },
                { name: 'Boone County', rate: 0.80 },
                { name: 'Jefferson County', rate: 0.76 },
                { name: 'Greene County', rate: 0.67 },
            ],
            MT: [
                { name: 'Montana Average', rate: 0.74 },
                { name: 'Missoula County', rate: 0.85 },
                { name: 'Cascade County', rate: 0.84 },
                { name: 'Yellowstone County', rate: 0.82 },
                { name: 'Lewis and Clark County', rate: 0.77 },
                { name: 'Gallatin County', rate: 0.64 },
                { name: 'Flathead County', rate: 0.54 },
            ],
            NE: [
                { name: 'Nebraska Average', rate: 1.65 },
                { name: 'Adams County', rate: 1.91 },
                { name: 'Hall County', rate: 1.81 },
                { name: 'Lincoln County', rate: 1.76 },
                { name: 'Madison County', rate: 1.71 },
                { name: 'Sarpy County', rate: 1.69 },
                { name: 'Douglas County', rate: 1.66 },
                { name: 'Dodge County', rate: 1.63 },
                { name: 'Platte County', rate: 1.58 },
                { name: 'Lancaster County', rate: 1.45 },
                { name: 'Buffalo County', rate: 1.41 },
            ],
            NV: [
                { name: 'Nevada Average', rate: 0.53 },
                { name: 'Churchill County', rate: 0.62 },
                { name: 'Humboldt County', rate: 0.54 },
                { name: 'Elko County', rate: 0.53 },
                { name: 'Nye County', rate: 0.51 },
                { name: 'Clark County', rate: 0.48 },
                { name: 'Douglas County', rate: 0.48 },
                { name: 'Lyon County', rate: 0.48 },
                { name: 'Carson City', rate: 0.46 },
                { name: 'Washoe County', rate: 0.44 },
            ],
            NH: [
                { name: 'New Hampshire Average', rate: 1.86 },
                { name: 'Cheshire County', rate: 1.84 },
                { name: 'Strafford County', rate: 1.64 },
                { name: 'Merrimack County', rate: 1.60 },
                { name: 'Grafton County', rate: 1.56 },
                { name: 'Hillsborough County', rate: 1.50 },
                { name: 'Rockingham County', rate: 1.35 },
                { name: 'Belknap County', rate: 1.12 },
            ],
            NJ: [
                { name: 'New Jersey Average', rate: 2.23 },
                { name: 'Camden County', rate: 2.32 },
                { name: 'Essex County', rate: 2.05 },
                { name: 'Passaic County', rate: 1.97 },
                { name: 'Union County', rate: 1.87 },
                { name: 'Middlesex County', rate: 1.82 },
                { name: 'Somerset County', rate: 1.81 },
                { name: 'Bergen County', rate: 1.76 },
                { name: 'Hudson County', rate: 1.69 },
                { name: 'Morris County', rate: 1.62 },
                { name: 'Monmouth County', rate: 1.48 },
            ],
            NM: [
                { name: 'New Mexico Average', rate: 0.67 },
                { name: 'Bernalillo County', rate: 0.84 },
                { name: 'Sandoval County', rate: 0.71 },
                { name: 'San Juan County', rate: 0.63 },
                { name: "Dona Ana County", rate: 0.59 },
                { name: 'Valencia County', rate: 0.56 },
                { name: 'Otero County', rate: 0.51 },
                { name: 'Lea County', rate: 0.49 },
                { name: 'Santa Fe County', rate: 0.46 },
            ],
            NY: [
                { name: 'New York Average', rate: 1.62 },
                { name: 'Monroe County', rate: 2.36 },
                { name: 'Onondaga County', rate: 2.12 },
                { name: 'Orange County', rate: 1.89 },
                { name: 'Dutchess County', rate: 1.84 },
                { name: 'Erie County', rate: 1.76 },
                { name: 'Albany County', rate: 1.62 },
                { name: 'Bronx County', rate: 0.95 },
                { name: 'Richmond County', rate: 0.91 },
                { name: 'Queens County', rate: 0.88 },
                { name: 'Kings County', rate: 0.73 },
            ],
            NC: [
                { name: 'North Carolina Average', rate: 0.77 },
                { name: 'Cumberland County', rate: 1.06 },
                { name: 'Durham County', rate: 0.93 },
                { name: 'Guilford County', rate: 0.92 },
                { name: 'Forsyth County', rate: 0.90 },
                { name: 'Gaston County', rate: 0.85 },
                { name: 'Mecklenburg County', rate: 0.80 },
                { name: 'Wake County', rate: 0.75 },
                { name: 'Union County', rate: 0.65 },
                { name: 'New Hanover County', rate: 0.62 },
                { name: 'Buncombe County', rate: 0.61 },
            ],
            ND: [
                { name: 'North Dakota Average', rate: 0.98 },
                { name: 'Grand Forks County', rate: 1.20 },
                { name: 'Cass County', rate: 1.16 },
                { name: 'Ward County', rate: 1.12 },
                { name: 'Burleigh County', rate: 0.89 },
            ],
            OH: [
                { name: 'Ohio Average', rate: 1.53 },
                { name: 'Cuyahoga County', rate: 1.80 },
                { name: 'Montgomery County', rate: 1.58 },
                { name: 'Lucas County', rate: 1.55 },
                { name: 'Delaware County', rate: 1.53 },
                { name: 'Summit County', rate: 1.45 },
                { name: 'Hamilton County', rate: 1.44 },
                { name: 'Franklin County', rate: 1.40 },
                { name: 'Lorain County', rate: 1.22 },
                { name: 'Butler County', rate: 1.18 },
                { name: 'Stark County', rate: 1.16 },
            ],
            OK: [
                { name: 'Oklahoma Average', rate: 0.87 },
                { name: 'Cleveland County', rate: 0.95 },
                { name: 'Oklahoma County', rate: 0.94 },
                { name: 'Canadian County', rate: 0.92 },
                { name: 'Tulsa County', rate: 0.90 },
                { name: 'Comanche County', rate: 0.81 },
                { name: 'Payne County', rate: 0.75 },
                { name: 'Wagoner County', rate: 0.74 },
                { name: 'Rogers County', rate: 0.71 },
                { name: 'Creek County', rate: 0.67 },
            ],
            OR: [
                { name: 'Oregon Average', rate: 0.87 },
                { name: 'Multnomah County', rate: 0.98 },
                { name: 'Benton County', rate: 0.89 },
                { name: 'Washington County', rate: 0.84 },
                { name: 'Linn County', rate: 0.82 },
                { name: 'Clackamas County', rate: 0.81 },
                { name: 'Marion County', rate: 0.79 },
                { name: 'Lane County', rate: 0.77 },
                { name: 'Jackson County', rate: 0.74 },
                { name: 'Yamhill County', rate: 0.70 },
                { name: 'Deschutes County', rate: 0.59 },
            ],
            PA: [
                { name: 'Pennsylvania Average', rate: 1.53 },
                { name: 'Delaware County', rate: 1.67 },
                { name: 'York County', rate: 1.46 },
                { name: 'Berks County', rate: 1.43 },
                { name: 'Allegheny County', rate: 1.39 },
                { name: 'Lehigh County', rate: 1.36 },
                { name: 'Montgomery County', rate: 1.25 },
                { name: 'Bucks County', rate: 1.17 },
                { name: 'Lancaster County', rate: 1.17 },
                { name: 'Chester County', rate: 1.15 },
                { name: 'Philadelphia County', rate: 0.83 },
            ],
            RI: [
                { name: 'Rhode Island Average', rate: 1.40 },
                { name: 'Providence County', rate: 1.09 },
                { name: 'Kent County', rate: 1.22 },
                { name: 'Washington County', rate: 0.87 },
                { name: 'Newport County', rate: 0.78 },
            ],
            SC: [
                { name: 'South Carolina Average', rate: 0.57 },
                { name: 'Richland County', rate: 0.59 },
                { name: 'Dorchester County', rate: 0.54 },
                { name: 'Spartanburg County', rate: 0.52 },
                { name: 'Greenville County', rate: 0.48 },
                { name: 'York County', rate: 0.46 },
                { name: 'Beaufort County', rate: 0.46 },
                { name: 'Lexington County', rate: 0.43 },
                { name: 'Berkeley County', rate: 0.42 },
                { name: 'Horry County', rate: 0.33 },
                { name: 'Charleston County', rate: 0.32 },
            ],
            SD: [
                { name: 'South Dakota Average', rate: 1.22 },
                { name: 'Lincoln County', rate: 1.46 },
                { name: 'Brown County', rate: 1.44 },
                { name: 'Minnehaha County', rate: 1.42 },
                { name: 'Davison County', rate: 1.39 },
                { name: 'Brookings County', rate: 1.38 },
                { name: 'Pennington County', rate: 1.33 },
                { name: 'Hughes County', rate: 1.28 },
                { name: 'Lawrence County', rate: 1.19 },
                { name: 'Codington County', rate: 1.12 },
            ],
            TN: [
                { name: 'Tennessee Average', rate: 0.56 },
                { name: 'Shelby County', rate: 0.89 },
                { name: 'Davidson County', rate: 0.57 },
                { name: 'Hamilton County', rate: 0.55 },
                { name: 'Montgomery County', rate: 0.52 },
                { name: 'Rutherford County', rate: 0.48 },
                { name: 'Sumner County', rate: 0.44 },
                { name: 'Maury County', rate: 0.42 },
                { name: 'Wilson County', rate: 0.38 },
                { name: 'Knox County', rate: 0.37 },
                { name: 'Williamson County', rate: 0.34 },
            ],
            TX: [
                { name: 'Texas Average', rate: 1.60 },
                { name: 'El Paso County', rate: 1.73 },
                { name: 'Fort Bend County', rate: 1.65 },
                { name: 'Bexar County', rate: 1.54 },
                { name: 'Williamson County', rate: 1.49 },
                { name: 'Tarrant County', rate: 1.47 },
                { name: 'Harris County', rate: 1.46 },
                { name: 'Denton County', rate: 1.43 },
                { name: 'Dallas County', rate: 1.41 },
                { name: 'Travis County', rate: 1.34 },
                { name: 'Collin County', rate: 1.31 },
            ],
            UT: [
                { name: 'Utah Average', rate: 0.58 },
                { name: 'Weber County', rate: 0.61 },
                { name: 'Tooele County', rate: 0.57 },
                { name: 'Salt Lake County', rate: 0.51 },
                { name: 'Davis County', rate: 0.48 },
                { name: 'Utah County', rate: 0.43 },
                { name: 'Cache County', rate: 0.43 },
                { name: 'Iron County', rate: 0.42 },
                { name: 'Washington County', rate: 0.39 },
            ],
            VT: [
                { name: 'Vermont Average', rate: 1.83 },
                { name: 'Windham County', rate: 1.74 },
                { name: 'Rutland County', rate: 1.73 },
                { name: 'Windsor County', rate: 1.73 },
                { name: 'Washington County', rate: 1.70 },
                { name: 'Addison County', rate: 1.67 },
                { name: 'Caledonia County', rate: 1.63 },
                { name: 'Chittenden County', rate: 1.61 },
                { name: 'Bennington County', rate: 1.60 },
                { name: 'Lamoille County', rate: 1.57 },
                { name: 'Franklin County', rate: 1.37 },
            ],
            VA: [
                { name: 'Virginia Average', rate: 0.80 },
                { name: 'Richmond City', rate: 1.02 },
                { name: 'Fairfax County', rate: 1.01 },
                { name: 'Norfolk City', rate: 1.00 },
                { name: 'Arlington County', rate: 0.94 },
                { name: 'Prince William County', rate: 0.87 },
                { name: 'Chesapeake City', rate: 0.85 },
                { name: 'Virginia Beach City', rate: 0.81 },
                { name: 'Loudoun County', rate: 0.79 },
                { name: 'Henrico County', rate: 0.73 },
                { name: 'Chesterfield County', rate: 0.71 },
            ],
            WA: [
                { name: 'Washington Average', rate: 0.87 },
                { name: 'Pierce County', rate: 0.88 },
                { name: 'Spokane County', rate: 0.83 },
                { name: 'King County', rate: 0.82 },
                { name: 'Thurston County', rate: 0.81 },
                { name: 'Yakima County', rate: 0.81 },
                { name: 'Clark County', rate: 0.79 },
                { name: 'Benton County', rate: 0.77 },
                { name: 'Kitsap County', rate: 0.76 },
                { name: 'Snohomish County', rate: 0.75 },
                { name: 'Whatcom County', rate: 0.70 },
            ],
            WV: [
                { name: 'West Virginia Average', rate: 0.57 },
                { name: 'Kanawha County', rate: 0.65 },
                { name: 'Cabell County', rate: 0.59 },
                { name: 'Putnam County', rate: 0.57 },
                { name: 'Wood County', rate: 0.55 },
                { name: 'Harrison County', rate: 0.54 },
                { name: 'Jefferson County', rate: 0.54 },
                { name: 'Berkeley County', rate: 0.49 },
                { name: 'Raleigh County', rate: 0.49 },
                { name: 'Monongalia County', rate: 0.46 },
            ],
            WI: [
                { name: 'Wisconsin Average', rate: 1.61 },
                { name: 'Milwaukee County', rate: 1.68 },
                { name: 'Dane County', rate: 1.48 },
                { name: 'Racine County', rate: 1.47 },
                { name: 'Winnebago County', rate: 1.46 },
                { name: 'Rock County', rate: 1.36 },
                { name: 'Kenosha County', rate: 1.31 },
                { name: 'Marathon County', rate: 1.24 },
                { name: 'Outagamie County', rate: 1.22 },
                { name: 'Brown County', rate: 1.20 },
                { name: 'Waukesha County', rate: 1.01 },
            ],
            WY: [
                { name: 'Wyoming Average', rate: 0.55 },
                { name: 'Laramie County', rate: 0.66 },
                { name: 'Albany County', rate: 0.65 },
                { name: 'Park County', rate: 0.65 },
                { name: 'Fremont County', rate: 0.62 },
                { name: 'Sheridan County', rate: 0.60 },
                { name: 'Sweetwater County', rate: 0.56 },
                { name: 'Natrona County', rate: 0.55 },
                { name: 'Uinta County', rate: 0.49 },
                { name: 'Teton County', rate: 0.48 },
                { name: 'Campbell County', rate: 0.47 },
                { name: 'Lincoln County', rate: 0.47 },
            ],
        };

        function onStateChange() {
            const stateCode = document.getElementById('stateSelect').value;
            const meta = getStateMeta(stateCode);

            // Update property tax rate to state average
            const rateInput = document.getElementById('propertyTaxRate');
            rateInput.value = meta.avgPropertyTax;

            // Update county dropdown for the selected state
            const countySelect = document.getElementById('countySelect');
            const counties = COUNTY_TAX_DATA[stateCode];
            if (counties && counties.length > 0) {
                countySelect.innerHTML = counties.map((c, i) =>
                    `<option value="${c.rate.toFixed(2)}"${i === 0 ? ' selected' : ''}>${escapeHTML(c.name)} (${c.rate.toFixed(2)}%)</option>`
                ).join('') + '\n<option value="custom">Custom</option>';
            } else {
                countySelect.innerHTML = `
                    <option value="${meta.avgPropertyTax}" selected>${escapeHTML(meta.name)} Average (${meta.avgPropertyTax.toFixed(2)}%)</option>
                    <option value="custom">Custom</option>
                `;
            }

            // Update tax brackets and recalculate
            calculateTakeHome();
            updateTaxBrackets();
        }

        function toggleDownPaymentMode() {
            const mode = document.getElementById('downPaymentMode').value;
            const percentInput = document.getElementById('downPaymentPercent');
            const amountInput = document.getElementById('downPaymentAmount');
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 0;

            if (mode === 'percent') {
                // Switching to percent mode - convert current amount to percent
                const currentAmount = parseFloat(amountInput.value) || 0;
                const percent = purchasePrice > 0 ? (currentAmount / purchasePrice) * 100 : 20;
                percentInput.value = Math.round(percent * 10) / 10; // Round to 1 decimal
                percentInput.style.display = 'block';
                amountInput.style.display = 'none';
            } else {
                // Switching to amount mode - convert current percent to amount
                const currentPercent = parseFloat(percentInput.value) || 0;
                const amount = purchasePrice * (currentPercent / 100);
                amountInput.value = Math.round(amount);
                amountInput.style.display = 'block';
                percentInput.style.display = 'none';
            }
            calculate();
        }

        function getDownPayment() {
            const mode = document.getElementById('downPaymentMode').value;
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 0;

            if (mode === 'percent') {
                const percent = parseFloat(document.getElementById('downPaymentPercent').value) || 0;
                return {
                    amount: purchasePrice * (percent / 100),
                    percent: percent
                };
            } else {
                const amount = parseFloat(document.getElementById('downPaymentAmount').value) || 0;
                const percent = purchasePrice > 0 ? (amount / purchasePrice) * 100 : 0;
                return {
                    amount: amount,
                    percent: percent
                };
            }
        }

        function syncDownPaymentHint() {
            const dp = getDownPayment();
            const hint = document.getElementById('downPaymentHint');
            hint.textContent = formatCurrency(dp.amount) + ' (' + Math.round(dp.percent * 10) / 10 + '%)';
            // Dim PMI rate when down payment >= 20%
            const pmiGroup = document.getElementById('pmiRateGroup');
            const pmiHint = document.getElementById('pmiRateHint');
            if (pmiGroup) {
                pmiGroup.style.opacity = dp.percent >= 20 ? '0.4' : '1';
                if (pmiHint) {
                    pmiHint.textContent = dp.percent >= 20 ? 'N/A ‚Äî no PMI with 20%+ down' :
                        dp.percent >= 15 ? 'Typical: 0.3-0.5% for 15-19% down' :
                        dp.percent >= 10 ? 'Typical: 0.5-0.8% for 10-14% down' :
                        dp.percent >= 5 ? 'Typical: 0.8-1.2% for 5-9% down' :
                        'Typical: 1.0-1.5% for <5% down';
                }
            }
        }

        // ========================================
        // TAX DATA CONFIGURATION
        // Last verified: February 2026
        // Update this section annually when new rates are published.
        // Sources: IRS.gov, FTB.ca.gov, EDD.ca.gov, SSA.gov
        // ========================================
        const TAX_DATA = {
            // TAX_DATA now contains FEDERAL-ONLY data. State data moved to STATE_TAX_DATA.
            2024: {
                federal: {
                    single: [
                        { min: 0, max: 11600, rate: 10 }, { min: 11600, max: 47150, rate: 12 },
                        { min: 47150, max: 100525, rate: 22 }, { min: 100525, max: 191950, rate: 24 },
                        { min: 191950, max: 243725, rate: 32 }, { min: 243725, max: 609350, rate: 35 },
                        { min: 609350, max: Infinity, rate: 37 }
                    ],
                    married_jointly: [
                        { min: 0, max: 23200, rate: 10 }, { min: 23200, max: 94300, rate: 12 },
                        { min: 94300, max: 201050, rate: 22 }, { min: 201050, max: 383900, rate: 24 },
                        { min: 383900, max: 487450, rate: 32 }, { min: 487450, max: 731200, rate: 35 },
                        { min: 731200, max: Infinity, rate: 37 }
                    ],
                    head_of_household: [
                        { min: 0, max: 16550, rate: 10 }, { min: 16550, max: 63100, rate: 12 },
                        { min: 63100, max: 100500, rate: 22 }, { min: 100500, max: 191950, rate: 24 },
                        { min: 191950, max: 243700, rate: 32 }, { min: 243700, max: 609350, rate: 35 },
                        { min: 609350, max: Infinity, rate: 37 }
                    ]
                },
                standardDeduction: { single: 14600, married_jointly: 29200, head_of_household: 21900 },
                saltCap: 10000,
                saltPhaseout: null,
                ssWageBase: 168600,
                max401k: 23000
            },
            2025: {
                federal: {
                    single: [
                        { min: 0, max: 11925, rate: 10 }, { min: 11925, max: 48475, rate: 12 },
                        { min: 48475, max: 103350, rate: 22 }, { min: 103350, max: 197300, rate: 24 },
                        { min: 197300, max: 250525, rate: 32 }, { min: 250525, max: 626350, rate: 35 },
                        { min: 626350, max: Infinity, rate: 37 }
                    ],
                    married_jointly: [
                        { min: 0, max: 23850, rate: 10 }, { min: 23850, max: 96950, rate: 12 },
                        { min: 96950, max: 206700, rate: 22 }, { min: 206700, max: 394600, rate: 24 },
                        { min: 394600, max: 501050, rate: 32 }, { min: 501050, max: 751600, rate: 35 },
                        { min: 751600, max: Infinity, rate: 37 }
                    ],
                    head_of_household: [
                        { min: 0, max: 17000, rate: 10 }, { min: 17000, max: 64850, rate: 12 },
                        { min: 64850, max: 103350, rate: 22 }, { min: 103350, max: 197300, rate: 24 },
                        { min: 197300, max: 250500, rate: 32 }, { min: 250500, max: 626350, rate: 35 },
                        { min: 626350, max: Infinity, rate: 37 }
                    ]
                },
                standardDeduction: { single: 15750, married_jointly: 31500, head_of_household: 23625 },
                saltCap: 40000,
                saltPhaseout: { threshold: 500000, rate: 0.30, floor: 10000 }, // OBBBA: 30% reduction above $500k MAGI
                ssWageBase: 176100,
                max401k: 23500
            },
            2026: {
                federal: {
                    single: [
                        { min: 0, max: 12400, rate: 10 }, { min: 12400, max: 50400, rate: 12 },
                        { min: 50400, max: 105700, rate: 22 }, { min: 105700, max: 201775, rate: 24 },
                        { min: 201775, max: 256225, rate: 32 }, { min: 256225, max: 640600, rate: 35 },
                        { min: 640600, max: Infinity, rate: 37 }
                    ],
                    married_jointly: [
                        { min: 0, max: 24800, rate: 10 }, { min: 24800, max: 100800, rate: 12 },
                        { min: 100800, max: 211400, rate: 22 }, { min: 211400, max: 403550, rate: 24 },
                        { min: 403550, max: 512450, rate: 32 }, { min: 512450, max: 768700, rate: 35 },
                        { min: 768700, max: Infinity, rate: 37 }
                    ],
                    head_of_household: [
                        { min: 0, max: 17700, rate: 10 }, { min: 17700, max: 67450, rate: 12 },
                        { min: 67450, max: 105700, rate: 22 }, { min: 105700, max: 201775, rate: 24 },
                        { min: 201775, max: 256200, rate: 32 }, { min: 256200, max: 640600, rate: 35 },
                        { min: 640600, max: Infinity, rate: 37 }
                    ]
                },
                standardDeduction: { single: 16100, married_jointly: 32200, head_of_household: 24150 },
                saltCap: 40400,
                saltPhaseout: { threshold: 505000, rate: 0.30, floor: 10000 }, // 1% annual increase from 2025
                ssWageBase: 184500,
                max401k: 24500
            }
        };

        // ========================================
        // STATE TAX DATA (income tax by state)
        // ========================================
        // Tier 1: none = no state income tax
        // Tier 2: flat = single rate applied to taxable income
        // Tier 3: progressive = bracketed marginal rates
        // Tier 4: effective = simplified effective rate table for less-used progressive states
        const STATE_TAX_DATA = {
            // === NO INCOME TAX (9 states) ===
            AK: { type: 'none' },
            FL: { type: 'none' },
            NV: { type: 'none' },
            NH: { type: 'none' }, // Interest/dividends tax repealed 2025
            SD: { type: 'none' },
            TN: { type: 'none' }, // Hall tax repealed 2021
            TX: { type: 'none' },
            WA: { type: 'none' }, // Has capital gains tax but no income tax
            WY: { type: 'none' },

            // === FLAT RATE STATES (14 states) === // Source: Tax Foundation 2025
            AZ: { type: 'flat', rate: 2.5, stdDed: { single: 14600, married_jointly: 29200, head_of_household: 21900 }, supplementalRate: 0.025 },
            CO: { type: 'flat', rate: 4.4, stdDed: { single: 14600, married_jointly: 29200, head_of_household: 21900 }, supplementalRate: 0.044 },
            GA: { type: 'flat', rate: 5.39, stdDed: { single: 12000, married_jointly: 24000, head_of_household: 18000 }, supplementalRate: 0.0539 },
            ID: { type: 'flat', rate: 5.695, stdDed: { single: 14600, married_jointly: 29200, head_of_household: 21900 }, supplementalRate: 0.05695 },
            IL: { type: 'flat', rate: 4.95, stdDed: { single: 0, married_jointly: 0, head_of_household: 0 }, supplementalRate: 0.0495, note: 'No standard deduction; uses personal exemption $2,775' },
            IN: { type: 'flat', rate: 3.05, stdDed: { single: 0, married_jointly: 0, head_of_household: 0 }, supplementalRate: 0.0305 },
            KS: { type: 'flat', rate: 5.7, stdDed: { single: 3500, married_jointly: 8000, head_of_household: 6000 }, supplementalRate: 0.057 },
            KY: { type: 'flat', rate: 4.0, stdDed: { single: 3160, married_jointly: 6320, head_of_household: 3160 }, supplementalRate: 0.04 },
            MI: { type: 'flat', rate: 4.25, stdDed: { single: 0, married_jointly: 0, head_of_household: 0 }, supplementalRate: 0.0425, note: 'Uses personal exemption $5,600' },
            MS: { type: 'flat', rate: 4.4, stdDed: { single: 2300, married_jointly: 4600, head_of_household: 3400 }, supplementalRate: 0.044 },
            NC: { type: 'flat', rate: 4.5, stdDed: { single: 12750, married_jointly: 25500, head_of_household: 19125 }, supplementalRate: 0.045 },
            ND: { type: 'flat', rate: 1.95, stdDed: { single: 14600, married_jointly: 29200, head_of_household: 21900 }, supplementalRate: 0.0195 },
            PA: { type: 'flat', rate: 3.07, stdDed: { single: 0, married_jointly: 0, head_of_household: 0 }, supplementalRate: 0.0307, note: 'No standard deduction' },
            UT: { type: 'flat', rate: 4.65, stdDed: { single: 14600, married_jointly: 29200, head_of_household: 21900 }, supplementalRate: 0.0465 },

            // === PROGRESSIVE STATES ‚Äî FULL BRACKETS (top 10) ===
            // Source: State tax authorities, Tax Foundation 2025
            CA: {
                type: 'progressive',
                supplementalRate: 0.1023,
                brackets: {
                    2024: {
                        single: [
                            { min: 0, max: 10756, rate: 1 }, { min: 10756, max: 25499, rate: 2 },
                            { min: 25499, max: 40245, rate: 4 }, { min: 40245, max: 55866, rate: 6 },
                            { min: 55866, max: 70606, rate: 8 }, { min: 70606, max: 360659, rate: 9.3 },
                            { min: 360659, max: 432787, rate: 10.3 }, { min: 432787, max: 721314, rate: 11.3 },
                            { min: 721314, max: 1000000, rate: 12.3 }, { min: 1000000, max: Infinity, rate: 13.3 }
                        ],
                        married_jointly: [
                            { min: 0, max: 21512, rate: 1 }, { min: 21512, max: 50998, rate: 2 },
                            { min: 50998, max: 80490, rate: 4 }, { min: 80490, max: 111732, rate: 6 },
                            { min: 111732, max: 141212, rate: 8 }, { min: 141212, max: 721318, rate: 9.3 },
                            { min: 721318, max: 865574, rate: 10.3 }, { min: 865574, max: 1442628, rate: 11.3 },
                            { min: 1442628, max: 2000000, rate: 12.3 }, { min: 2000000, max: Infinity, rate: 13.3 }
                        ],
                        head_of_household: [
                            { min: 0, max: 21527, rate: 1 }, { min: 21527, max: 51000, rate: 2 },
                            { min: 51000, max: 65744, rate: 4 }, { min: 65744, max: 81364, rate: 6 },
                            { min: 81364, max: 96107, rate: 8 }, { min: 96107, max: 490493, rate: 9.3 },
                            { min: 490493, max: 588593, rate: 10.3 }, { min: 588593, max: 980987, rate: 11.3 },
                            { min: 980987, max: 1000000, rate: 12.3 }, { min: 1000000, max: Infinity, rate: 13.3 }
                        ]
                    },
                    2025: {
                        single: [
                            { min: 0, max: 10756, rate: 1 }, { min: 10756, max: 25499, rate: 2 },
                            { min: 25499, max: 40245, rate: 4 }, { min: 40245, max: 55866, rate: 6 },
                            { min: 55866, max: 70606, rate: 8 }, { min: 70606, max: 360659, rate: 9.3 },
                            { min: 360659, max: 432787, rate: 10.3 }, { min: 432787, max: 721314, rate: 11.3 },
                            { min: 721314, max: 1000000, rate: 12.3 }, { min: 1000000, max: Infinity, rate: 13.3 }
                        ],
                        married_jointly: [
                            { min: 0, max: 21512, rate: 1 }, { min: 21512, max: 50998, rate: 2 },
                            { min: 50998, max: 80490, rate: 4 }, { min: 80490, max: 111732, rate: 6 },
                            { min: 111732, max: 141212, rate: 8 }, { min: 141212, max: 721318, rate: 9.3 },
                            { min: 721318, max: 865574, rate: 10.3 }, { min: 865574, max: 1442628, rate: 11.3 },
                            { min: 1442628, max: 2000000, rate: 12.3 }, { min: 2000000, max: Infinity, rate: 13.3 }
                        ],
                        head_of_household: [
                            { min: 0, max: 21527, rate: 1 }, { min: 21527, max: 51000, rate: 2 },
                            { min: 51000, max: 65744, rate: 4 }, { min: 65744, max: 81364, rate: 6 },
                            { min: 81364, max: 96107, rate: 8 }, { min: 96107, max: 490493, rate: 9.3 },
                            { min: 490493, max: 588593, rate: 10.3 }, { min: 588593, max: 980987, rate: 11.3 },
                            { min: 980987, max: 1000000, rate: 12.3 }, { min: 1000000, max: Infinity, rate: 13.3 }
                        ]
                    },
                    2026: {
                        single: [
                            { min: 0, max: 11079, rate: 1 }, { min: 11079, max: 26264, rate: 2 },
                            { min: 26264, max: 41452, rate: 4 }, { min: 41452, max: 57542, rate: 6 },
                            { min: 57542, max: 72724, rate: 8 }, { min: 72724, max: 371479, rate: 9.3 },
                            { min: 371479, max: 445771, rate: 10.3 }, { min: 445771, max: 742953, rate: 11.3 },
                            { min: 742953, max: 1000000, rate: 12.3 }, { min: 1000000, max: Infinity, rate: 13.3 }
                        ],
                        married_jointly: [
                            { min: 0, max: 22158, rate: 1 }, { min: 22158, max: 52528, rate: 2 },
                            { min: 52528, max: 82905, rate: 4 }, { min: 82905, max: 115084, rate: 6 },
                            { min: 115084, max: 145448, rate: 8 }, { min: 145448, max: 742958, rate: 9.3 },
                            { min: 742958, max: 891541, rate: 10.3 }, { min: 891541, max: 1485907, rate: 11.3 },
                            { min: 1485907, max: 2000000, rate: 12.3 }, { min: 2000000, max: Infinity, rate: 13.3 }
                        ],
                        head_of_household: [
                            { min: 0, max: 22173, rate: 1 }, { min: 22173, max: 52530, rate: 2 },
                            { min: 52530, max: 67716, rate: 4 }, { min: 67716, max: 83805, rate: 6 },
                            { min: 83805, max: 98990, rate: 8 }, { min: 98990, max: 505208, rate: 9.3 },
                            { min: 505208, max: 606251, rate: 10.3 }, { min: 606251, max: 1000000, rate: 11.3 },
                            { min: 1000000, max: 1010417, rate: 12.3 }, { min: 1010417, max: Infinity, rate: 13.3 }
                        ]
                    }
                },
                stdDed: {
                    2024: { single: 5540, married_jointly: 11080, head_of_household: 11080 },
                    2025: { single: 5540, married_jointly: 11080, head_of_household: 11080 },
                    2026: { single: 5706, married_jointly: 11412, head_of_household: 11412 }
                },
                topRate: 13.3
            },
            NY: {
                type: 'progressive', supplementalRate: 0.1197,
                brackets: { 2025: {
                    single: [
                        { min: 0, max: 8500, rate: 4 }, { min: 8500, max: 11700, rate: 4.5 },
                        { min: 11700, max: 13900, rate: 5.25 }, { min: 13900, max: 80650, rate: 5.5 },
                        { min: 80650, max: 215400, rate: 6 }, { min: 215400, max: 1077550, rate: 6.85 },
                        { min: 1077550, max: 5000000, rate: 9.65 }, { min: 5000000, max: 25000000, rate: 10.3 },
                        { min: 25000000, max: Infinity, rate: 10.9 }
                    ],
                    married_jointly: [
                        { min: 0, max: 17150, rate: 4 }, { min: 17150, max: 23600, rate: 4.5 },
                        { min: 23600, max: 27900, rate: 5.25 }, { min: 27900, max: 161550, rate: 5.5 },
                        { min: 161550, max: 323200, rate: 6 }, { min: 323200, max: 2155350, rate: 6.85 },
                        { min: 2155350, max: 5000000, rate: 9.65 }, { min: 5000000, max: 25000000, rate: 10.3 },
                        { min: 25000000, max: Infinity, rate: 10.9 }
                    ],
                    head_of_household: [
                        { min: 0, max: 12800, rate: 4 }, { min: 12800, max: 17650, rate: 4.5 },
                        { min: 17650, max: 20900, rate: 5.25 }, { min: 20900, max: 107650, rate: 5.5 },
                        { min: 107650, max: 269300, rate: 6 }, { min: 269300, max: 1616450, rate: 6.85 },
                        { min: 1616450, max: 5000000, rate: 9.65 }, { min: 5000000, max: 25000000, rate: 10.3 },
                        { min: 25000000, max: Infinity, rate: 10.9 }
                    ]
                }},
                stdDed: { 2025: { single: 8000, married_jointly: 16050, head_of_household: 11200 } },
                topRate: 10.9
            },
            NJ: {
                type: 'progressive', supplementalRate: 0.1075,
                brackets: { 2025: {
                    single: [
                        { min: 0, max: 20000, rate: 1.4 }, { min: 20000, max: 35000, rate: 1.75 },
                        { min: 35000, max: 40000, rate: 3.5 }, { min: 40000, max: 75000, rate: 5.525 },
                        { min: 75000, max: 500000, rate: 6.37 }, { min: 500000, max: 1000000, rate: 8.97 },
                        { min: 1000000, max: Infinity, rate: 10.75 }
                    ],
                    married_jointly: [
                        { min: 0, max: 20000, rate: 1.4 }, { min: 20000, max: 50000, rate: 1.75 },
                        { min: 50000, max: 70000, rate: 2.45 }, { min: 70000, max: 80000, rate: 3.5 },
                        { min: 80000, max: 150000, rate: 5.525 }, { min: 150000, max: 500000, rate: 6.37 },
                        { min: 500000, max: 1000000, rate: 8.97 }, { min: 1000000, max: Infinity, rate: 10.75 }
                    ],
                    head_of_household: [
                        { min: 0, max: 20000, rate: 1.4 }, { min: 20000, max: 50000, rate: 1.75 },
                        { min: 50000, max: 70000, rate: 2.45 }, { min: 70000, max: 80000, rate: 3.5 },
                        { min: 80000, max: 150000, rate: 5.525 }, { min: 150000, max: 500000, rate: 6.37 },
                        { min: 500000, max: 1000000, rate: 8.97 }, { min: 1000000, max: Infinity, rate: 10.75 }
                    ]
                }},
                stdDed: { 2025: { single: 0, married_jointly: 0, head_of_household: 0 } },
                topRate: 10.75, note: 'No standard deduction; uses personal exemption $1,000'
            },
            CT: {
                type: 'progressive', supplementalRate: 0.0699,
                brackets: { 2025: {
                    single: [
                        { min: 0, max: 10000, rate: 2 }, { min: 10000, max: 50000, rate: 4.5 },
                        { min: 50000, max: 100000, rate: 5.5 }, { min: 100000, max: 200000, rate: 6 },
                        { min: 200000, max: 250000, rate: 6.5 }, { min: 250000, max: 500000, rate: 6.9 },
                        { min: 500000, max: Infinity, rate: 6.99 }
                    ],
                    married_jointly: [
                        { min: 0, max: 20000, rate: 2 }, { min: 20000, max: 100000, rate: 4.5 },
                        { min: 100000, max: 200000, rate: 5.5 }, { min: 200000, max: 400000, rate: 6 },
                        { min: 400000, max: 500000, rate: 6.5 }, { min: 500000, max: 1000000, rate: 6.9 },
                        { min: 1000000, max: Infinity, rate: 6.99 }
                    ],
                    head_of_household: [
                        { min: 0, max: 16000, rate: 2 }, { min: 16000, max: 80000, rate: 4.5 },
                        { min: 80000, max: 160000, rate: 5.5 }, { min: 160000, max: 320000, rate: 6 },
                        { min: 320000, max: 400000, rate: 6.5 }, { min: 400000, max: 800000, rate: 6.9 },
                        { min: 800000, max: Infinity, rate: 6.99 }
                    ]
                }},
                stdDed: { 2025: { single: 0, married_jointly: 0, head_of_household: 0 } },
                topRate: 6.99, note: 'No standard deduction; uses personal exemption credit'
            },
            MA: {
                type: 'flat', rate: 5.0, supplementalRate: 0.05,
                stdDed: { single: 0, married_jointly: 0, head_of_household: 0 },
                note: 'Flat rate + 4% surtax on income over $1M (effective 9% above $1M)',
                surtax: { threshold: 1000000, rate: 4.0 }
            },
            OR: {
                type: 'progressive', supplementalRate: 0.08,
                brackets: { 2025: {
                    single: [
                        { min: 0, max: 4050, rate: 4.75 }, { min: 4050, max: 10200, rate: 6.75 },
                        { min: 10200, max: 125000, rate: 8.75 }, { min: 125000, max: Infinity, rate: 9.9 }
                    ],
                    married_jointly: [
                        { min: 0, max: 8100, rate: 4.75 }, { min: 8100, max: 20400, rate: 6.75 },
                        { min: 20400, max: 250000, rate: 8.75 }, { min: 250000, max: Infinity, rate: 9.9 }
                    ],
                    head_of_household: [
                        { min: 0, max: 4050, rate: 4.75 }, { min: 4050, max: 10200, rate: 6.75 },
                        { min: 10200, max: 125000, rate: 8.75 }, { min: 125000, max: Infinity, rate: 9.9 }
                    ]
                }},
                stdDed: { 2025: { single: 2745, married_jointly: 5495, head_of_household: 4420 } },
                topRate: 9.9
            },
            MN: {
                type: 'progressive', supplementalRate: 0.0985,
                brackets: { 2025: {
                    single: [
                        { min: 0, max: 31690, rate: 5.35 }, { min: 31690, max: 104090, rate: 6.8 },
                        { min: 104090, max: 193240, rate: 7.85 }, { min: 193240, max: Infinity, rate: 9.85 }
                    ],
                    married_jointly: [
                        { min: 0, max: 46330, rate: 5.35 }, { min: 46330, max: 184040, rate: 6.8 },
                        { min: 184040, max: 321450, rate: 7.85 }, { min: 321450, max: Infinity, rate: 9.85 }
                    ],
                    head_of_household: [
                        { min: 0, max: 39810, rate: 5.35 }, { min: 39810, max: 159450, rate: 6.8 },
                        { min: 159450, max: 257310, rate: 7.85 }, { min: 257310, max: Infinity, rate: 9.85 }
                    ]
                }},
                stdDed: { 2025: { single: 14575, married_jointly: 29150, head_of_household: 21850 } },
                topRate: 9.85
            },
            HI: {
                type: 'progressive', supplementalRate: 0.11,
                brackets: { 2025: {
                    single: [
                        { min: 0, max: 2400, rate: 1.4 }, { min: 2400, max: 4800, rate: 3.2 },
                        { min: 4800, max: 9600, rate: 5.5 }, { min: 9600, max: 14400, rate: 6.4 },
                        { min: 14400, max: 19200, rate: 6.8 }, { min: 19200, max: 24000, rate: 7.2 },
                        { min: 24000, max: 36000, rate: 7.6 }, { min: 36000, max: 48000, rate: 7.9 },
                        { min: 48000, max: 150000, rate: 8.25 }, { min: 150000, max: 175000, rate: 9 },
                        { min: 175000, max: 200000, rate: 10 }, { min: 200000, max: Infinity, rate: 11 }
                    ],
                    married_jointly: [
                        { min: 0, max: 4800, rate: 1.4 }, { min: 4800, max: 9600, rate: 3.2 },
                        { min: 9600, max: 19200, rate: 5.5 }, { min: 19200, max: 28800, rate: 6.4 },
                        { min: 28800, max: 38400, rate: 6.8 }, { min: 38400, max: 48000, rate: 7.2 },
                        { min: 48000, max: 72000, rate: 7.6 }, { min: 72000, max: 96000, rate: 7.9 },
                        { min: 96000, max: 300000, rate: 8.25 }, { min: 300000, max: 350000, rate: 9 },
                        { min: 350000, max: 400000, rate: 10 }, { min: 400000, max: Infinity, rate: 11 }
                    ],
                    head_of_household: [
                        { min: 0, max: 3600, rate: 1.4 }, { min: 3600, max: 7200, rate: 3.2 },
                        { min: 7200, max: 14400, rate: 5.5 }, { min: 14400, max: 21600, rate: 6.4 },
                        { min: 21600, max: 28800, rate: 6.8 }, { min: 28800, max: 36000, rate: 7.2 },
                        { min: 36000, max: 54000, rate: 7.6 }, { min: 54000, max: 72000, rate: 7.9 },
                        { min: 72000, max: 225000, rate: 8.25 }, { min: 225000, max: 262500, rate: 9 },
                        { min: 262500, max: 300000, rate: 10 }, { min: 300000, max: Infinity, rate: 11 }
                    ]
                }},
                stdDed: { 2025: { single: 2200, married_jointly: 4400, head_of_household: 3212 } },
                topRate: 11
            },
            WI: {
                type: 'progressive', supplementalRate: 0.0765,
                brackets: { 2025: {
                    single: [
                        { min: 0, max: 14320, rate: 3.5 }, { min: 14320, max: 28640, rate: 4.4 },
                        { min: 28640, max: 315310, rate: 5.3 }, { min: 315310, max: Infinity, rate: 7.65 }
                    ],
                    married_jointly: [
                        { min: 0, max: 19090, rate: 3.5 }, { min: 19090, max: 38190, rate: 4.4 },
                        { min: 38190, max: 420420, rate: 5.3 }, { min: 420420, max: Infinity, rate: 7.65 }
                    ],
                    head_of_household: [
                        { min: 0, max: 14320, rate: 3.5 }, { min: 14320, max: 28640, rate: 4.4 },
                        { min: 28640, max: 315310, rate: 5.3 }, { min: 315310, max: Infinity, rate: 7.65 }
                    ]
                }},
                stdDed: { 2025: { single: 13230, married_jointly: 24450, head_of_household: 16190 } },
                topRate: 7.65
            },
            VT: {
                type: 'progressive', supplementalRate: 0.0875,
                brackets: { 2025: {
                    single: [
                        { min: 0, max: 45400, rate: 3.35 }, { min: 45400, max: 110050, rate: 6.6 },
                        { min: 110050, max: 229950, rate: 7.6 }, { min: 229950, max: Infinity, rate: 8.75 }
                    ],
                    married_jointly: [
                        { min: 0, max: 75850, rate: 3.35 }, { min: 75850, max: 183700, rate: 6.6 },
                        { min: 183700, max: 279650, rate: 7.6 }, { min: 279650, max: Infinity, rate: 8.75 }
                    ],
                    head_of_household: [
                        { min: 0, max: 60850, rate: 3.35 }, { min: 60850, max: 156850, rate: 6.6 },
                        { min: 156850, max: 254700, rate: 7.6 }, { min: 254700, max: Infinity, rate: 8.75 }
                    ]
                }},
                stdDed: { 2025: { single: 7000, married_jointly: 14000, head_of_household: 10500 } },
                topRate: 8.75
            },
            IA: { type: 'flat', rate: 3.8, stdDed: { single: 2210, married_jointly: 5450, head_of_household: 5450 }, supplementalRate: 0.038 },

            // === PROGRESSIVE STATES ‚Äî SIMPLIFIED (effective rate tables) ===
            // Format: { type: 'effective', rates: [rate at $50k, $100k, $200k, $400k, $1M], topRate, supplementalRate }
            // Rates are approximate effective rates for married_jointly filing
            AL: { type: 'effective', rates: [3.5, 4.2, 4.6, 4.8, 4.9], topRate: 5.0, supplementalRate: 0.05, stdDed: { single: 2500, married_jointly: 7500, head_of_household: 4700 } },
            AR: { type: 'effective', rates: [3.2, 3.8, 4.1, 4.3, 4.4], topRate: 4.4, supplementalRate: 0.044, stdDed: { single: 2340, married_jointly: 4680, head_of_household: 2340 } },
            DC: { type: 'effective', rates: [4.5, 6.0, 7.5, 8.5, 9.5], topRate: 10.75, supplementalRate: 0.1075, stdDed: { single: 14600, married_jointly: 29200, head_of_household: 21900 } },
            DE: { type: 'effective', rates: [3.8, 5.0, 5.8, 6.2, 6.5], topRate: 6.6, supplementalRate: 0.066, stdDed: { single: 3250, married_jointly: 6500, head_of_household: 3250 } },
            LA: { type: 'effective', rates: [1.5, 2.5, 3.3, 3.8, 4.1], topRate: 4.25, supplementalRate: 0.0425, stdDed: { single: 0, married_jointly: 0, head_of_household: 0 } },
            MD: { type: 'effective', rates: [3.5, 4.2, 4.8, 5.3, 5.6], topRate: 5.75, supplementalRate: 0.0575, stdDed: { single: 2550, married_jointly: 5100, head_of_household: 3825 } },
            ME: { type: 'effective', rates: [4.5, 5.5, 6.5, 7.0, 7.1], topRate: 7.15, supplementalRate: 0.0715, stdDed: { single: 14600, married_jointly: 29200, head_of_household: 21900 } },
            MO: { type: 'effective', rates: [3.0, 4.0, 4.6, 4.8, 4.9], topRate: 4.95, supplementalRate: 0.0495, stdDed: { single: 14600, married_jointly: 29200, head_of_household: 21900 } },
            MT: { type: 'effective', rates: [3.5, 4.8, 5.5, 5.8, 5.9], topRate: 5.9, supplementalRate: 0.059, stdDed: { single: 5540, married_jointly: 11080, head_of_household: 8310 } },
            NE: { type: 'effective', rates: [3.5, 4.5, 5.3, 5.7, 5.8], topRate: 5.84, supplementalRate: 0.0584, stdDed: { single: 7900, married_jointly: 15800, head_of_household: 11250 } },
            NM: { type: 'effective', rates: [2.5, 3.5, 4.5, 5.2, 5.7], topRate: 5.9, supplementalRate: 0.059, stdDed: { single: 14600, married_jointly: 29200, head_of_household: 21900 } },
            OH: { type: 'effective', rates: [0, 1.5, 2.8, 3.3, 3.5], topRate: 3.5, supplementalRate: 0.035, stdDed: { single: 0, married_jointly: 0, head_of_household: 0 }, note: 'No tax on first $26,050' },
            OK: { type: 'effective', rates: [2.5, 3.5, 4.2, 4.5, 4.7], topRate: 4.75, supplementalRate: 0.0475, stdDed: { single: 6350, married_jointly: 12700, head_of_household: 9350 } },
            RI: { type: 'effective', rates: [3.0, 3.8, 4.5, 5.0, 5.6], topRate: 5.99, supplementalRate: 0.0599, stdDed: { single: 10550, married_jointly: 21100, head_of_household: 15825 } },
            SC: { type: 'effective', rates: [2.5, 4.0, 5.5, 6.0, 6.3], topRate: 6.4, supplementalRate: 0.064, stdDed: { single: 14600, married_jointly: 29200, head_of_household: 21900 } },
            VA: { type: 'effective', rates: [3.5, 4.8, 5.3, 5.5, 5.7], topRate: 5.75, supplementalRate: 0.0575, stdDed: { single: 4500, married_jointly: 9000, head_of_household: 4500 } },
            WV: { type: 'effective', rates: [3.0, 4.0, 4.8, 5.2, 5.5], topRate: 5.12, supplementalRate: 0.0512, stdDed: { single: 0, married_jointly: 0, head_of_household: 0 } }
        };

        // ========================================
        // STATE METADATA (non-tax properties)
        // ========================================
        // Source: Tax Foundation, Census Bureau, state assessor offices
        const STATE_META = {
            AL: { name: 'Alabama', avgPropertyTax: 0.40, homesteadExemption: 0, homesteadType: 'none', sdiRate: 0 },
            AK: { name: 'Alaska', avgPropertyTax: 1.04, homesteadExemption: 150000, homesteadType: 'assessed_value', sdiRate: 0 },
            AZ: { name: 'Arizona', avgPropertyTax: 0.62, homesteadExemption: 0, homesteadType: 'none', sdiRate: 0 },
            AR: { name: 'Arkansas', avgPropertyTax: 0.63, homesteadExemption: 350, homesteadType: 'credit', sdiRate: 0 },
            CA: { name: 'California', avgPropertyTax: 1.10, homesteadExemption: 7000, homesteadType: 'assessed_value', sdiRate: 0.012, sdiCap: null },
            CO: { name: 'Colorado', avgPropertyTax: 0.51, homesteadExemption: 0, homesteadType: 'none', sdiRate: 0.009, sdiCap: null, note: 'FAMLI program' },
            CT: { name: 'Connecticut', avgPropertyTax: 2.15, homesteadExemption: 0, homesteadType: 'none', sdiRate: 0.005, sdiCap: null },
            DE: { name: 'Delaware', avgPropertyTax: 0.57, homesteadExemption: 50000, homesteadType: 'assessed_value', sdiRate: 0 },
            DC: { name: 'District of Columbia', avgPropertyTax: 0.56, homesteadExemption: 82150, homesteadType: 'assessed_value', sdiRate: 0 },
            FL: { name: 'Florida', avgPropertyTax: 0.80, homesteadExemption: 50000, homesteadType: 'assessed_value', sdiRate: 0 },
            GA: { name: 'Georgia', avgPropertyTax: 0.87, homesteadExemption: 2000, homesteadType: 'assessed_value', sdiRate: 0 },
            HI: { name: 'Hawaii', avgPropertyTax: 0.27, homesteadExemption: 100000, homesteadType: 'assessed_value', sdiRate: 0.005, sdiCap: 71998 },
            ID: { name: 'Idaho', avgPropertyTax: 0.63, homesteadExemption: 125000, homesteadType: 'market_value', sdiRate: 0 },
            IL: { name: 'Illinois', avgPropertyTax: 2.07, homesteadExemption: 10000, homesteadType: 'assessed_value', sdiRate: 0 },
            IN: { name: 'Indiana', avgPropertyTax: 0.81, homesteadExemption: 48000, homesteadType: 'assessed_value', sdiRate: 0 },
            IA: { name: 'Iowa', avgPropertyTax: 1.52, homesteadExemption: 4850, homesteadType: 'credit', sdiRate: 0 },
            KS: { name: 'Kansas', avgPropertyTax: 1.33, homesteadExemption: 0, homesteadType: 'none', sdiRate: 0 },
            KY: { name: 'Kentucky', avgPropertyTax: 0.83, homesteadExemption: 46350, homesteadType: 'assessed_value', sdiRate: 0 },
            LA: { name: 'Louisiana', avgPropertyTax: 0.55, homesteadExemption: 75000, homesteadType: 'market_value', sdiRate: 0 },
            ME: { name: 'Maine', avgPropertyTax: 1.24, homesteadExemption: 25000, homesteadType: 'assessed_value', sdiRate: 0 },
            MD: { name: 'Maryland', avgPropertyTax: 1.05, homesteadExemption: 0, homesteadType: 'none', sdiRate: 0 },
            MA: { name: 'Massachusetts', avgPropertyTax: 1.15, homesteadExemption: 125000, homesteadType: 'assessed_value', sdiRate: 0.0088, sdiCap: null, note: 'PFML program' },
            MI: { name: 'Michigan', avgPropertyTax: 1.38, homesteadExemption: 0, homesteadType: 'none', sdiRate: 0 },
            MN: { name: 'Minnesota', avgPropertyTax: 1.05, homesteadExemption: 0, homesteadType: 'none', sdiRate: 0 },
            MS: { name: 'Mississippi', avgPropertyTax: 0.65, homesteadExemption: 7500, homesteadType: 'assessed_value', sdiRate: 0 },
            MO: { name: 'Missouri', avgPropertyTax: 0.91, homesteadExemption: 0, homesteadType: 'none', sdiRate: 0 },
            MT: { name: 'Montana', avgPropertyTax: 0.74, homesteadExemption: 0, homesteadType: 'none', sdiRate: 0 },
            NE: { name: 'Nebraska', avgPropertyTax: 1.65, homesteadExemption: 0, homesteadType: 'none', sdiRate: 0 },
            NV: { name: 'Nevada', avgPropertyTax: 0.53, homesteadExemption: 605000, homesteadType: 'equity', sdiRate: 0 },
            NH: { name: 'New Hampshire', avgPropertyTax: 1.86, homesteadExemption: 0, homesteadType: 'none', sdiRate: 0 },
            NJ: { name: 'New Jersey', avgPropertyTax: 2.23, homesteadExemption: 0, homesteadType: 'none', sdiRate: 0.006, sdiCap: 43300 },
            NM: { name: 'New Mexico', avgPropertyTax: 0.67, homesteadExemption: 0, homesteadType: 'none', sdiRate: 0 },
            NY: { name: 'New York', avgPropertyTax: 1.62, homesteadExemption: 0, homesteadType: 'none', sdiRate: 0.005, sdiCap: 31200 },
            NC: { name: 'North Carolina', avgPropertyTax: 0.77, homesteadExemption: 0, homesteadType: 'none', sdiRate: 0 },
            ND: { name: 'North Dakota', avgPropertyTax: 0.98, homesteadExemption: 0, homesteadType: 'none', sdiRate: 0 },
            OH: { name: 'Ohio', avgPropertyTax: 1.53, homesteadExemption: 26200, homesteadType: 'assessed_value', sdiRate: 0 },
            OK: { name: 'Oklahoma', avgPropertyTax: 0.87, homesteadExemption: 1000, homesteadType: 'assessed_value', sdiRate: 0 },
            OR: { name: 'Oregon', avgPropertyTax: 0.87, homesteadExemption: 0, homesteadType: 'none', sdiRate: 0.006, sdiCap: null, note: 'Paid Leave Oregon' },
            PA: { name: 'Pennsylvania', avgPropertyTax: 1.53, homesteadExemption: 0, homesteadType: 'none', sdiRate: 0 },
            RI: { name: 'Rhode Island', avgPropertyTax: 1.40, homesteadExemption: 0, homesteadType: 'none', sdiRate: 0.011, sdiCap: 87000 },
            SC: { name: 'South Carolina', avgPropertyTax: 0.57, homesteadExemption: 50000, homesteadType: 'assessed_value', sdiRate: 0 },
            SD: { name: 'South Dakota', avgPropertyTax: 1.22, homesteadExemption: 0, homesteadType: 'none', sdiRate: 0 },
            TN: { name: 'Tennessee', avgPropertyTax: 0.56, homesteadExemption: 5000, homesteadType: 'assessed_value', sdiRate: 0 },
            TX: { name: 'Texas', avgPropertyTax: 1.60, homesteadExemption: 100000, homesteadType: 'assessed_value', sdiRate: 0 },
            UT: { name: 'Utah', avgPropertyTax: 0.58, homesteadExemption: 0, homesteadType: 'none', sdiRate: 0 },
            VT: { name: 'Vermont', avgPropertyTax: 1.83, homesteadExemption: 0, homesteadType: 'none', sdiRate: 0 },
            VA: { name: 'Virginia', avgPropertyTax: 0.80, homesteadExemption: 0, homesteadType: 'none', sdiRate: 0 },
            WA: { name: 'Washington', avgPropertyTax: 0.87, homesteadExemption: 0, homesteadType: 'none', sdiRate: 0.0058, sdiCap: null, note: 'WA Cares + PFML' },
            WV: { name: 'West Virginia', avgPropertyTax: 0.57, homesteadExemption: 20000, homesteadType: 'assessed_value', sdiRate: 0 },
            WI: { name: 'Wisconsin', avgPropertyTax: 1.61, homesteadExemption: 0, homesteadType: 'none', sdiRate: 0 },
            WY: { name: 'Wyoming', avgPropertyTax: 0.55, homesteadExemption: 0, homesteadType: 'none', sdiRate: 0 }
        };

        // ========================================
        // STATE TAX HELPER FUNCTIONS
        // ========================================

        function getStateTaxConfig(stateCode) {
            return STATE_TAX_DATA[stateCode] || STATE_TAX_DATA.CA;
        }

        function getStateMeta(stateCode) {
            return STATE_META[stateCode] || STATE_META.CA;
        }

        function getStateSdiRate(stateCode) {
            const meta = getStateMeta(stateCode);
            return meta.sdiRate || 0;
        }

        function getSupplementalRate(stateCode) {
            const config = getStateTaxConfig(stateCode);
            return config.supplementalRate || 0;
        }

        function getHomesteadSavings(stateCode, purchasePrice, propertyTaxRate) {
            const meta = getStateMeta(stateCode);
            if (!meta.homesteadExemption || meta.homesteadType === 'none') return 0;
            if (meta.homesteadType === 'credit') return meta.homesteadExemption; // Fixed $ credit
            if (meta.homesteadType === 'equity') return 0; // Protects equity, not tax savings
            // assessed_value or market_value: reduction in taxable value
            const exemption = Math.min(meta.homesteadExemption, purchasePrice);
            return exemption * (propertyTaxRate / 100);
        }

        function getStateBrackets(stateCode, year) {
            const config = getStateTaxConfig(stateCode);
            if (config.type === 'none') return null;
            if (config.type === 'flat') return null;
            if (config.type === 'effective') return null;
            // Progressive with full brackets
            if (config.brackets) {
                // Try exact year, then fallback to nearest available
                if (config.brackets[year]) return config.brackets[year];
                const years = Object.keys(config.brackets).map(Number).sort();
                const nearest = years.reduce((prev, curr) => Math.abs(curr - year) < Math.abs(prev - year) ? curr : prev);
                return config.brackets[nearest];
            }
            return null;
        }

        function getStateStdDed(stateCode, filingStatus, year) {
            const config = getStateTaxConfig(stateCode);
            if (config.type === 'none') return 0;
            if (config.stdDed) {
                // Multi-year stdDed (like CA)
                if (config.stdDed[year]) return config.stdDed[year][filingStatus] || 0;
                // Check for nearest year
                const years = Object.keys(config.stdDed).map(Number).filter(y => !isNaN(y));
                if (years.length > 0) {
                    const nearest = years.reduce((prev, curr) => Math.abs(curr - year) < Math.abs(prev - year) ? curr : prev);
                    return config.stdDed[nearest][filingStatus] || 0;
                }
                // Single-level stdDed (flat states)
                return config.stdDed[filingStatus] || 0;
            }
            return 0;
        }

        function getStateBracket(income, filingStatus, stateCode, year) {
            const config = getStateTaxConfig(stateCode);
            if (config.type === 'none') return 0;
            if (config.type === 'flat') return config.rate;
            if (config.type === 'effective') return config.topRate;
            // Progressive
            const yearBrackets = getStateBrackets(stateCode, year);
            if (!yearBrackets) return config.topRate || 0;
            const statusBrackets = yearBrackets[filingStatus] || yearBrackets.married_jointly;
            for (const bracket of statusBrackets) {
                if (income >= bracket.min && income < bracket.max) return bracket.rate;
            }
            return config.topRate || 13.3;
        }

        function estimateStateTax(income, filingStatus, stateCode, year) {
            const config = getStateTaxConfig(stateCode);
            if (config.type === 'none') return 0;

            const stdDed = getStateStdDed(stateCode, filingStatus, year);
            const taxableIncome = Math.max(0, income - stdDed);

            if (config.type === 'flat') {
                let tax = taxableIncome * (config.rate / 100);
                // MA surtax
                if (config.surtax && income > config.surtax.threshold) {
                    tax += (income - config.surtax.threshold) * (config.surtax.rate / 100);
                }
                return Math.round(tax);
            }

            if (config.type === 'effective') {
                // Interpolate effective rate from table
                const thresholds = [50000, 100000, 200000, 400000, 1000000];
                const rates = config.rates;
                if (taxableIncome <= 0) return 0;
                let effectiveRate;
                if (taxableIncome <= thresholds[0]) {
                    effectiveRate = rates[0] * (taxableIncome / thresholds[0]);
                } else if (taxableIncome >= thresholds[thresholds.length - 1]) {
                    effectiveRate = rates[rates.length - 1];
                } else {
                    for (let i = 0; i < thresholds.length - 1; i++) {
                        if (taxableIncome >= thresholds[i] && taxableIncome < thresholds[i + 1]) {
                            const pct = (taxableIncome - thresholds[i]) / (thresholds[i + 1] - thresholds[i]);
                            effectiveRate = rates[i] + pct * (rates[i + 1] - rates[i]);
                            break;
                        }
                    }
                }
                return Math.round(taxableIncome * (effectiveRate / 100));
            }

            // Progressive with full brackets
            const yearBrackets = getStateBrackets(stateCode, year);
            if (!yearBrackets) return 0;
            const statusBrackets = yearBrackets[filingStatus] || yearBrackets.married_jointly;
            let tax = 0;
            let remaining = taxableIncome;
            for (const bracket of statusBrackets) {
                if (remaining <= 0) break;
                const taxable = Math.min(remaining, bracket.max - bracket.min);
                tax += taxable * (bracket.rate / 100);
                remaining -= taxable;
            }
            // MA surtax on progressive too (MA is flat but just in case)
            if (config.surtax && income > config.surtax.threshold) {
                tax += (income - config.surtax.threshold) * (config.surtax.rate / 100);
            }
            return Math.round(tax);
        }

        // Year auto-detection
        const CURRENT_YEAR = new Date().getFullYear();
        const AVAILABLE_YEARS = Object.keys(TAX_DATA).map(Number).sort();
        const LATEST_DATA_YEAR = Math.max(...AVAILABLE_YEARS);

        function getTaxData(year) {
            const y = parseInt(year);
            return TAX_DATA[y] || TAX_DATA[LATEST_DATA_YEAR];
        }

        function getSaltCap(year, magi) {
            const data = getTaxData(year);
            let cap = data.saltCap;
            if (data.saltPhaseout && magi > data.saltPhaseout.threshold) {
                const reduction = (magi - data.saltPhaseout.threshold) * data.saltPhaseout.rate;
                cap = Math.max(data.saltPhaseout.floor, cap - reduction);
            }
            return cap;
        }

        function initTaxYearSelector() {
            const select = document.getElementById('taxYear');
            select.innerHTML = '';
            const defaultYear = Math.min(CURRENT_YEAR, LATEST_DATA_YEAR);
            AVAILABLE_YEARS.forEach(year => {
                const opt = document.createElement('option');
                opt.value = year;
                opt.textContent = year;
                if (year === defaultYear) opt.selected = true;
                select.appendChild(opt);
            });
            if (CURRENT_YEAR > LATEST_DATA_YEAR) {
                const warn = document.getElementById('dataWarning');
                warn.style.display = 'block';
                warn.innerHTML = `‚ö†Ô∏è <strong>Tax data last updated for ${LATEST_DATA_YEAR}.</strong> ${CURRENT_YEAR} rates may differ. Using ${LATEST_DATA_YEAR} as best available.`;
            }
        }

        // Compat shims so existing code references still work during transition
        function getStandardDeductions(year, filingStatus) {
            return getTaxData(year).standardDeduction[filingStatus];
        }

        function getFederalBracket(income, filingStatus, year) {
            const data = getTaxData(year);
            const statusBrackets = data.federal[filingStatus] || data.federal.married_jointly;
            for (const bracket of statusBrackets) {
                if (income >= bracket.min && income < bracket.max) return bracket.rate;
            }
            return 37;
        }

        // Legacy CA functions removed ‚Äî now using generic getStateBracket() and estimateStateTax()

        function estimateFederalTax(income, filingStatus, year) {
            const data = getTaxData(year);
            const statusBrackets = data.federal[filingStatus] || data.federal.married_jointly;
            const stdDed = data.standardDeduction[filingStatus] || data.standardDeduction.married_jointly;
            const taxableIncome = Math.max(0, income - stdDed);
            let tax = 0;
            let remaining = taxableIncome;
            for (const bracket of statusBrackets) {
                if (remaining <= 0) break;
                const taxable = Math.min(remaining, bracket.max - bracket.min);
                tax += taxable * (bracket.rate / 100);
                remaining -= taxable;
            }
            return Math.round(tax);
        }

        function calculatePersonTakeHome(baseSalary, annualBonus, annualRSU, retirement401kPercent, preTaxDeductionsMonthly, taxYear, stateCode) {
            stateCode = stateCode || 'CA';
            const data = getTaxData(taxYear);
            const max401k = data.max401k;
            const contrib401k = Math.min(baseSalary * (retirement401kPercent / 100), max401k);
            const preTaxDeductionsAnnual = preTaxDeductionsMonthly * 12;
            const totalPreTaxDeductions = contrib401k + preTaxDeductionsAnnual;

            const totalW2Income = baseSalary + annualBonus + annualRSU;
            const ssTax = Math.min(totalW2Income, data.ssWageBase) * 0.062;

            const medicareTax = 0.0145 * totalW2Income;
            const medicareAdditional = totalW2Income > 200000 ? (totalW2Income - 200000) * 0.009 : 0;

            // State disability insurance (CA, NY, NJ, HI, RI, etc.)
            const sdiRate = getStateSdiRate(stateCode);
            const sdiTax = totalW2Income * sdiRate;

            const totalGross = baseSalary + annualBonus + annualRSU;

            return {
                baseSalary,
                annualBonus,
                annualRSU,
                totalGross,
                contrib401k,
                preTaxDeductionsAnnual,
                totalPreTaxDeductions,
                ssTax,
                medicareTax: medicareTax + medicareAdditional,
                sdiTax,
                ficaTaxes: ssTax + medicareTax + medicareAdditional + sdiTax
            };
        }

        // Withholding rates for supplemental income (bonuses, RSU)
        const BONUS_WITHHOLDING_RATE = 0.22; // Federal flat rate for bonuses < $1M
        const RSU_WITHHOLDING_RATE = 0.37;   // Companies often withhold at higher rate (fed + state + FICA ‚âà 37-45%)

        function calculateTakeHome() {
            const filingStatus = document.getElementById('filingStatus').value;
            const taxYear = document.getElementById('taxYear').value;
            const stateCode = (document.getElementById('stateSelect') || {}).value || 'CA';
            const isMarried = filingStatus === 'married_jointly';

            // Show/hide Person 2 section based on filing status
            const person2Section = document.getElementById('person2Section');
            const person1Title = document.getElementById('person1Title');
            if (isMarried) {
                person2Section.style.display = 'block';
                person1Title.textContent = 'Person 1 Compensation';
            } else {
                person2Section.style.display = 'none';
                person1Title.textContent = 'Your Compensation';
            }

            // Get all inputs for Person 1
            const baseSalary1 = parseFloat(document.getElementById('baseSalary1').value) || 0;
            const annualBonus1 = parseFloat(document.getElementById('annualBonus1').value) || 0;
            const annualRSU1 = parseFloat(document.getElementById('annualRSU1').value) || 0;
            const bonusFreq1 = document.getElementById('bonusFreq1').value;
            const rsuFreq1 = document.getElementById('rsuFreq1').value;
            const retirement401k1 = parseFloat(document.getElementById('retirement401k1').value) || 0;
            const preTax1 = parseFloat(document.getElementById('preTaxDeductions1').value) || 0;

            // Get all inputs for Person 2
            let baseSalary2 = 0, annualBonus2 = 0, annualRSU2 = 0, bonusFreq2 = 'annual', rsuFreq2 = 'quarterly', retirement401k2 = 0, preTax2 = 0;
            if (isMarried) {
                baseSalary2 = parseFloat(document.getElementById('baseSalary2').value) || 0;
                annualBonus2 = parseFloat(document.getElementById('annualBonus2').value) || 0;
                annualRSU2 = parseFloat(document.getElementById('annualRSU2').value) || 0;
                bonusFreq2 = document.getElementById('bonusFreq2').value;
                rsuFreq2 = document.getElementById('rsuFreq2').value;
                retirement401k2 = parseFloat(document.getElementById('retirement401k2').value) || 0;
                preTax2 = parseFloat(document.getElementById('preTaxDeductions2').value) || 0;
            }

            // Calculate person-level data
            const p1 = calculatePersonTakeHome(baseSalary1, annualBonus1, annualRSU1, retirement401k1, preTax1, taxYear, stateCode);
            const p2 = isMarried ? calculatePersonTakeHome(baseSalary2, annualBonus2, annualRSU2, retirement401k2, preTax2, taxYear, stateCode) :
                { baseSalary: 0, annualBonus: 0, annualRSU: 0, totalGross: 0, contrib401k: 0, preTaxDeductionsAnnual: 0, totalPreTaxDeductions: 0, ficaTaxes: 0 };

            // Combined totals
            const totalBaseSalary = p1.baseSalary + p2.baseSalary;
            const totalBonus = p1.annualBonus + p2.annualBonus;
            const totalRSU = p1.annualRSU + p2.annualRSU;
            const totalGross = p1.totalGross + p2.totalGross;
            const totalPreTaxDeductions = p1.totalPreTaxDeductions + p2.totalPreTaxDeductions;
            const totalFicaTaxes = p1.ficaTaxes + p2.ficaTaxes;

            // ACTUAL TAX LIABILITY (what you owe at end of year)
            const taxableIncome = totalGross - totalPreTaxDeductions;
            const federalTax = estimateFederalTax(taxableIncome, filingStatus, taxYear);
            const stateTax = estimateStateTax(taxableIncome, filingStatus, stateCode, taxYear);
            const totalIncomeTax = federalTax + stateTax;
            const totalTaxes = totalIncomeTax + totalFicaTaxes;

            // Effective tax rate
            const effectiveRate = totalGross > 0 ? (totalTaxes / totalGross) * 100 : 0;

            // WITHHOLDING CALCULATIONS (what's taken from each paycheck)
            const stateSupplementalRate = getSupplementalRate(stateCode);
            const sdiRate = getStateSdiRate(stateCode);
            const bonusFicaRate = 0.0765 + sdiRate; // SS + Medicare + SDI
            const bonusTotalWithholding = BONUS_WITHHOLDING_RATE + stateSupplementalRate + bonusFicaRate;
            const bonusNetAnnual = totalBonus * (1 - bonusTotalWithholding);

            // RSU withholding: typically 22% fed + state supplemental + 7.65% FICA = ~40%, but companies often withhold more
            // Using effective rate of ~37-40% for RSU (shares sold to cover)
            const rsuWithholdingRate = 0.40; // Conservative estimate
            const rsuNetAnnual = totalRSU * (1 - rsuWithholdingRate);

            // Base salary monthly net calculation
            // Monthly taxes on base salary (prorated)
            const baseSalaryTaxable = totalBaseSalary - totalPreTaxDeductions;
            const federalTaxOnBase = estimateFederalTax(baseSalaryTaxable, filingStatus, taxYear);
            const stateTaxOnBase = estimateStateTax(baseSalaryTaxable, filingStatus, stateCode, taxYear);

            const data = getTaxData(taxYear);
            const ssTaxBase = Math.min(totalBaseSalary, data.ssWageBase) * 0.062;
            const medicareTaxBase = totalBaseSalary * 0.0145;
            const medicareAddBase = totalBaseSalary > (isMarried ? 250000 : 200000) ?
                (totalBaseSalary - (isMarried ? 250000 : 200000)) * 0.009 : 0;
            const sdiTaxBase = totalBaseSalary * sdiRate;
            const ficaOnBase = ssTaxBase + medicareTaxBase + medicareAddBase + sdiTaxBase;

            const totalTaxOnBase = federalTaxOnBase + stateTaxOnBase + ficaOnBase;
            const baseNetAnnual = totalBaseSalary - totalTaxOnBase - totalPreTaxDeductions;
            const monthlyBaseNet = baseNetAnnual / 12;

            // Average monthly take-home (including bonus and RSU spread across months)
            const totalAnnualNet = baseNetAnnual + bonusNetAnnual + rsuNetAnnual;
            const avgMonthlyTakeHome = totalAnnualNet / 12;

            // RSU/Bonus frequency display
            const rsuPerQuarter = totalRSU / 4 * (1 - rsuWithholdingRate);
            const rsuPerMonth = totalRSU / 12 * (1 - rsuWithholdingRate);
            const bonusPerQuarter = totalBonus / 4 * (1 - bonusTotalWithholding);

            // Determine display text based on frequencies
            let rsuDisplayText = '';
            let bonusDisplayText = '';

            // For RSU display - use most frequent vesting schedule
            const rsuFreqDisplay = isMarried ?
                (rsuFreq1 === 'monthly' || rsuFreq2 === 'monthly' ? 'monthly' :
                 rsuFreq1 === 'quarterly' || rsuFreq2 === 'quarterly' ? 'quarterly' : 'annual') : rsuFreq1;

            if (rsuFreqDisplay === 'monthly') {
                rsuDisplayText = '+' + formatCurrency(rsuPerMonth) + '/mo';
            } else if (rsuFreqDisplay === 'quarterly') {
                rsuDisplayText = '+' + formatCurrency(rsuPerQuarter) + '/qtr';
            } else {
                rsuDisplayText = '+' + formatCurrency(rsuNetAnnual) + '/yr';
            }

            // For bonus display
            const bonusFreqDisplay = isMarried ?
                (bonusFreq1 === 'quarterly' || bonusFreq2 === 'quarterly' ? 'quarterly' : 'annual') : bonusFreq1;

            if (bonusFreqDisplay === 'quarterly') {
                bonusDisplayText = '+' + formatCurrency(bonusPerQuarter) + '/qtr';
            } else {
                bonusDisplayText = '+' + formatCurrency(bonusNetAnnual) + '/yr';
            }

            // UPDATE ALL DISPLAYS
            // Summary section
            document.getElementById('summaryBaseSalary').textContent = formatCurrency(totalBaseSalary);
            document.getElementById('summaryBonusGross').textContent = formatCurrency(totalBonus);
            document.getElementById('summaryBonusNet').textContent = formatCurrency(bonusNetAnnual);
            document.getElementById('summaryRSUGross').textContent = formatCurrency(totalRSU);
            document.getElementById('summaryRSUNet').textContent = formatCurrency(rsuNetAnnual);
            document.getElementById('totalGrossComp').textContent = formatCurrency(totalGross);
            document.getElementById('totalDeductions').textContent = '-' + formatCurrency(totalPreTaxDeductions);
            document.getElementById('estimatedTaxes').textContent = '-' + formatCurrency(totalTaxes);
            document.getElementById('effectiveTaxRate').textContent = effectiveRate.toFixed(1) + '%';

            // Monthly cash flow section
            document.getElementById('monthlyBaseNet').textContent = formatCurrency(monthlyBaseNet);
            document.getElementById('monthlyRSUNet').textContent = rsuDisplayText;
            document.getElementById('monthlyBonusNet').textContent = bonusDisplayText;
            document.getElementById('calculatedTakeHome').textContent = formatCurrency(avgMonthlyTakeHome);

            // Update 401k hints
            document.getElementById('contrib401kHint1').textContent = formatCurrency(p1.contrib401k) + '/yr';
            if (isMarried) {
                document.getElementById('contrib401kHint2').textContent = formatCurrency(p2.contrib401k) + '/yr';
            }

            // Update bonus hints
            const bonusPercent1 = p1.baseSalary > 0 ? Math.round((p1.annualBonus / p1.baseSalary) * 100) : 0;
            document.getElementById('bonusHint1').textContent = bonusPercent1 + '%';
            if (isMarried) {
                const bonusPercent2 = p2.baseSalary > 0 ? Math.round((p2.annualBonus / p2.baseSalary) * 100) : 0;
                document.getElementById('bonusHint2').textContent = bonusPercent2 + '%';
            }

            // Update the take-home input field (only if not manually overridden)
            if (!document.getElementById('overrideTakeHome').checked) {
                document.getElementById('monthlyTakeHome').value = Math.round(avgMonthlyTakeHome);
            }

            // Sync annualIncome for tax bracket calculations
            document.getElementById('annualIncome').value = totalGross;

            // Trigger recalculation
            updateTaxBrackets();
        }

        function toggleTakeHomeOverride() {
            const isOverride = document.getElementById('overrideTakeHome').checked;
            const input = document.getElementById('monthlyTakeHome');
            if (isOverride) {
                input.removeAttribute('readonly');
                input.classList.remove('readonly-input');
            } else {
                input.setAttribute('readonly', true);
                input.classList.add('readonly-input');
                calculateTakeHome(); // re-sync to calculated value
            }
        }

        function updateTaxRules() {
            const year = document.getElementById('taxYear').value;
            const data = getTaxData(year);
            const saltHint = document.getElementById('saltHint');
            const filingStatus = document.getElementById('filingStatus').value;
            const stdDed = data.standardDeduction[filingStatus] || 0;
            const saltCapStr = data.saltCap >= 40000 ? `$${(data.saltCap/1000).toFixed(0)}k` : `$${(data.saltCap/1000).toFixed(0)}k`;

            if (saltHint) {
                saltHint.textContent = `${year}: SALT cap ${saltCapStr}, Std ded ${formatCurrency(stdDed)} (${filingStatus === 'married_jointly' ? 'MFJ' : filingStatus === 'single' ? 'Single' : 'HoH'})`;
            }

            updateTaxBrackets();
        }

        function updateTaxBrackets() {
            const income = parseFloat(document.getElementById('annualIncome').value) || 0;
            const filingStatus = document.getElementById('filingStatus').value;
            const year = document.getElementById('taxYear').value;
            const stateCode = (document.getElementById('stateSelect') || {}).value || 'CA';
            const stateMeta = getStateMeta(stateCode);

            const federalRate = getFederalBracket(income, filingStatus, year);
            const stateRate = getStateBracket(income, filingStatus, stateCode, year);
            const estimatedStateTax = estimateStateTax(income, filingStatus, stateCode, year);

            document.getElementById('federalTax').value = federalRate;
            document.getElementById('stateTax').value = stateRate;
            document.getElementById('stateIncomeTax').value = estimatedStateTax;
            const stateAbbr = stateCode;
            document.getElementById('bracketHint').textContent = `Federal: ${federalRate}% | ${stateAbbr}: ${stateRate}%`;

            calculate();
        }

        function calculateMonthlyPayment(principal, annualRate, years) {
            const monthlyRate = annualRate / 100 / 12;
            const numPayments = years * 12;
            if (monthlyRate === 0) return principal / numPayments;
            return principal * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);
        }

        const _currFmt = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 0 });
        const _currFmtDetailed = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2, maximumFractionDigits: 2 });

        function formatCurrency(amount) {
            return _currFmt.format(amount);
        }

        function formatCurrencyDetailed(amount) {
            return _currFmtDetailed.format(amount);
        }

        function validateInputs() {
            const rules = [
                { id: 'purchasePrice', min: 1000, max: 50000000, msg: 'Enter a price between $1,000 and $50M' },
                { id: 'downPaymentPercent', min: 0, max: 100, msg: 'Must be 0-100%' },
                { id: 'downPaymentAmount', min: 0, max: parseFloat(document.getElementById('purchasePrice').value) || 50000000, msg: 'Cannot exceed purchase price' },
                { id: 'interestRate', min: 0, max: 20, msg: 'Enter a rate between 0% and 20%' },
                { id: 'propertyTaxRate', min: 0, max: 5, msg: 'Typically 0-5%' },
                { id: 'maintenance', min: 0, max: 10, msg: 'Typically 0-10%' },
                { id: 'appreciation', min: -10, max: 20, msg: 'Typically -10% to 20%' },
            ];
            let valid = true;
            rules.forEach(rule => {
                const el = document.getElementById(rule.id);
                if (!el || el.style.display === 'none') return;
                const val = parseFloat(el.value);
                const errId = rule.id + 'Error';
                let errEl = document.getElementById(errId);
                if (isNaN(val) || val < rule.min || val > rule.max) {
                    el.classList.add('input-error');
                    el.setAttribute('aria-invalid', 'true');
                    if (!errEl) {
                        errEl = document.createElement('div');
                        errEl.id = errId;
                        errEl.className = 'input-error-msg';
                        errEl.setAttribute('role', 'alert');
                        el.parentNode.insertBefore(errEl, el.nextSibling);
                    }
                    errEl.textContent = rule.msg;
                    valid = false;
                } else {
                    el.classList.remove('input-error');
                    el.removeAttribute('aria-invalid');
                    if (errEl) errEl.remove();
                }
            });
            return valid;
        }

        function calculate() {
          try {
            dismissError();
            if (!validateInputs()) return;
            // In affordability mode, compute max price first, then run normal calc
            if (currentCalcMode === 'affordability') {
                calculateAffordability();
            }
            const inputs = getInputs();

            // Derived values - use getDownPayment() for flexible input mode
            const dp = getDownPayment();
            const downPayment = dp.amount;
            const downPaymentPercent = dp.percent;
            const loanAmount = inputs.purchasePrice - downPayment;

            // Extra payments ‚Äî lump sum reduces effective starting balance
            const effectiveLumpSum = Math.min(inputs.lumpSum, loanAmount);
            const effectiveLoanAmount = loanAmount - effectiveLumpSum;

            // Update down payment hint
            syncDownPaymentHint();

            // Monthly P&I (based on effective loan after lump sum)
            const monthlyPI = calculateMonthlyPayment(effectiveLoanAmount, inputs.interestRate, inputs.loanTerm);
            // Baseline P&I without extra payments (for savings comparison)
            const baselineMonthlyPI = effectiveLumpSum > 0 || inputs.extraMonthly > 0
                ? calculateMonthlyPayment(loanAmount, inputs.interestRate, inputs.loanTerm)
                : monthlyPI;

            // Monthly costs
            const monthlyPropertyTax = (inputs.purchasePrice * inputs.propertyTaxRate / 100) / 12;
            const monthlyMelloRoos = inputs.melloRoos / 12;
            const monthlyInsurance = inputs.insurance / 12;
            const monthlyHOA = inputs.hoa;

            // PMI (if down < 20%)
            let monthlyPMI = 0;
            if (downPaymentPercent < 20) {
                monthlyPMI = (loanAmount * inputs.pmiRate / 100) / 12;
            }

            const monthlyMaintenance = (inputs.purchasePrice * inputs.maintenance / 100) / 12;
            const monthlyUtilities = inputs.utilities;

            // Totals
            const monthlyPITI = monthlyPI + monthlyPropertyTax + monthlyMelloRoos + monthlyInsurance + monthlyPMI + monthlyHOA;
            const trueMonthlyCost = monthlyPITI + monthlyMaintenance + monthlyUtilities + inputs.extraMonthly;

            // === UPFRONT COSTS ===
            const closingCosts = {
                'Loan Origination (0.75%)': loanAmount * 0.0075,
                'Appraisal Fee': 600,
                'Credit Report': 50,
                'Title Insurance': inputs.purchasePrice * 0.003,
                'Escrow Fee': inputs.purchasePrice * 0.002,
                'Recording Fees': 200,
                'Notary Fees': 200,
                'Home Inspection': 500,
                'Pest Inspection': 150,
                'Prepaid Interest (15 days)': (loanAmount * inputs.interestRate / 100 / 365) * 15,
                'Prepaid Property Tax (2 mo)': monthlyPropertyTax * 2,
                'Prepaid Insurance (12 mo)': inputs.insurance,
            };
            if (inputs.hoa > 0) closingCosts['HOA Transfer Fee'] = 500;

            const totalClosingCosts = Object.values(closingCosts).reduce((a, b) => a + b, 0);
            const escrowReserve = monthlyPropertyTax * 2 + monthlyInsurance * 2;
            const totalCashNeeded = downPayment + totalClosingCosts + escrowReserve + effectiveLumpSum;

            // === TAX BENEFITS ===
            const standardDeduction = inputs.standardDeduction;
            // SALT cap with phaseout for high earners
            const saltCap = getSaltCap(inputs.taxYear, inputs.annualIncome);
            const stateCode = inputs.stateCode;

            // Year 1 interest (with extra payments factored in)
            let balance = effectiveLoanAmount;
            let totalInterestYear1 = 0;
            const monthlyRate = inputs.interestRate / 100 / 12;
            for (let month = 1; month <= 12; month++) {
                if (balance <= 0) break;
                const interestPayment = balance * monthlyRate;
                const basePrincipal = monthlyPI - interestPayment;
                const extraPrinc = Math.min(inputs.extraMonthly, balance - basePrincipal);
                const principalPayment = Math.min(basePrincipal + Math.max(extraPrinc, 0), balance);
                totalInterestYear1 += interestPayment;
                balance = Math.max(balance - principalPayment, 0);
            }

            const deductibleLoan = Math.min(effectiveLoanAmount, 750000);
            const deductibleInterest = effectiveLoanAmount > 0 ? totalInterestYear1 * (deductibleLoan / effectiveLoanAmount) : 0;
            const annualPropertyTax = inputs.purchasePrice * inputs.propertyTaxRate / 100;

            // SALT Cap: Dynamic based on year ($10k for 2024, $40k for 2025)
            const totalSALT = inputs.stateIncomeTax + annualPropertyTax;
            const deductibleSALT = Math.min(totalSALT, saltCap);
            // How much of the SALT cap goes to property tax?
            const deductiblePropertyTax = Math.min(annualPropertyTax, Math.max(0, saltCap - inputs.stateIncomeTax));
            const deductibleStateIncome = deductibleSALT - deductiblePropertyTax;

            // FEDERAL TAX CALCULATION
            // Itemized deductions with home: mortgage interest + SALT (capped)
            const itemizedWithHome = deductibleInterest + deductibleSALT;

            // Itemized deductions WITHOUT home (what you'd deduct as a renter)
            // As a renter, you'd only have state income tax (capped at SALT limit)
            const itemizedWithoutHome = Math.min(inputs.stateIncomeTax, saltCap);

            // Should you itemize WITH the home?
            const shouldItemize = itemizedWithHome > standardDeduction;

            // Would you itemize WITHOUT the home?
            const wouldItemizeWithoutHome = itemizedWithoutHome > standardDeduction;

            // ACTUAL TAX BENEFIT CALCULATION
            // Compare: what you'd pay in taxes WITH home vs WITHOUT home
            let federalTaxSavings = 0;
            const federalRate = inputs.federalTax / 100;

            if (shouldItemize) {
                // With home: use itemized deductions
                const deductionWithHome = itemizedWithHome;
                // Without home: use whichever is higher (standard or state tax only)
                const deductionWithoutHome = wouldItemizeWithoutHome ? itemizedWithoutHome : standardDeduction;
                // Savings = extra deduction * tax rate
                federalTaxSavings = Math.max(0, (deductionWithHome - deductionWithoutHome)) * federalRate;
            } else {
                // Not itemizing with home - no federal mortgage benefit
                // (you'd take standard deduction either way)
                federalTaxSavings = 0;
            }

            // STATE TAX BENEFIT
            // Most states allow mortgage interest deduction if you itemize on federal
            // Simplified: state benefit only if itemizing federally
            const stateRate = inputs.stateTax / 100;
            let stateTaxSavings = 0;
            if (shouldItemize) {
                stateTaxSavings = deductibleInterest * stateRate;
            }

            const annualTaxSavings = federalTaxSavings + stateTaxSavings;

            // Homestead/Homeowners' Exemption (varies by state)
            const homesteadSavings = getHomesteadSavings(stateCode, inputs.purchasePrice, inputs.propertyTaxRate);
            const totalAnnualTaxBenefit = annualTaxSavings + homesteadSavings;
            const monthlyTaxSavings = totalAnnualTaxBenefit / 12;

            const effectiveMonthlyCost = trueMonthlyCost - monthlyTaxSavings;

            // === WEALTH BUILDING (10 years) ===
            const wealthData = [];
            let cumulativeTaxSavings = 0;
            balance = effectiveLoanAmount;
            let loanPaidOff = false;

            const isARM = inputs.loanType !== 'fixed';
            const armFixedYears = isARM ? parseInt(inputs.loanType) : inputs.loanTerm;
            let currentRate = inputs.interestRate;
            let currentMonthlyPI = monthlyPI;

            for (let year = 1; year <= 10; year++) {
                // ARM: adjust rate after fixed period
                if (isARM && year > armFixedYears) {
                    currentRate = Math.min(currentRate + inputs.armAdjustment, inputs.armCap);
                    const remainingYears = inputs.loanTerm - year + 1;
                    currentMonthlyPI = calculateMonthlyPayment(Math.max(balance, 0), currentRate, remainingYears);
                }

                const yearMonthlyRate = currentRate / 100 / 12;
                let yearInterest = 0;
                let yearPrincipal = 0;

                for (let month = 1; month <= 12; month++) {
                    if (balance <= 0) { loanPaidOff = true; break; }
                    const interestPayment = balance * yearMonthlyRate;
                    const basePrincipal = currentMonthlyPI - interestPayment;
                    const extraPrincipal = Math.min(inputs.extraMonthly, balance - basePrincipal);
                    const principalPayment = Math.min(basePrincipal + Math.max(extraPrincipal, 0), balance);
                    yearInterest += interestPayment;
                    yearPrincipal += principalPayment;
                    balance = Math.max(balance - principalPayment, 0);
                }

                const homeValue = inputs.purchasePrice * Math.pow(1 + inputs.appreciation / 100, year);
                const appreciationGain = homeValue - inputs.purchasePrice;
                const equityFromPayments = effectiveLoanAmount - balance + effectiveLumpSum;
                const totalEquity = downPayment + equityFromPayments + appreciationGain;

                // Tax benefit calculation per year (using corrected logic)
                const loanRef = effectiveLoanAmount > 0 ? effectiveLoanAmount : 1;
                const yearDeductibleInterest = effectiveLoanAmount > 0 ? yearInterest * (Math.min(deductibleLoan, effectiveLoanAmount) / loanRef) : 0;
                const yearItemizedWithHome = yearDeductibleInterest + deductibleSALT;
                const yearShouldItemize = yearItemizedWithHome > standardDeduction;

                let yearFederalSavings = 0;
                let yearStateSavings = 0;
                if (yearShouldItemize) {
                    const yearDeductionWithoutHome = wouldItemizeWithoutHome ? itemizedWithoutHome : standardDeduction;
                    yearFederalSavings = Math.max(0, (yearItemizedWithHome - yearDeductionWithoutHome)) * federalRate;
                    yearStateSavings = yearDeductibleInterest * stateRate;
                }
                const yearTaxSavings = yearFederalSavings + yearStateSavings + homesteadSavings;
                cumulativeTaxSavings += yearTaxSavings;

                wealthData.push({
                    year,
                    homeValue,
                    remainingMortgage: balance,
                    equityFromPayments,
                    appreciationGain,
                    totalEquity,
                    cumulativeTaxSavings,
                    totalWealthImpact: totalEquity + cumulativeTaxSavings,
                    yearInterest,
                    yearPrincipal,
                    rate: currentRate,
                    monthlyPayment: currentMonthlyPI + inputs.extraMonthly
                });
            }

            // === EXTRA PAYMENT SAVINGS (full-term comparison) ===
            const hasExtraPayments = inputs.extraMonthly > 0 || effectiveLumpSum > 0;
            let extraPaymentResults = null;
            if (hasExtraPayments) {
                // Baseline: original loan, no extra payments
                let baseBalance = loanAmount;
                let baseTotalInterest = 0;
                let baseMonths = 0;
                const baseRate = inputs.interestRate / 100 / 12;
                while (baseBalance > 0.01 && baseMonths < inputs.loanTerm * 12) {
                    baseMonths++;
                    const interest = baseBalance * baseRate;
                    const principal = baselineMonthlyPI - interest;
                    baseTotalInterest += interest;
                    baseBalance = Math.max(baseBalance - principal, 0);
                }

                // With extra payments
                let extraBalance = effectiveLoanAmount;
                let extraTotalInterest = 0;
                let extraMonths = 0;
                while (extraBalance > 0.01 && extraMonths < inputs.loanTerm * 12) {
                    extraMonths++;
                    const interest = extraBalance * baseRate;
                    const basePrinc = monthlyPI - interest;
                    const extraPrinc = Math.min(inputs.extraMonthly, extraBalance - basePrinc);
                    const totalPrinc = Math.min(basePrinc + Math.max(extraPrinc, 0), extraBalance);
                    extraTotalInterest += interest;
                    extraBalance = Math.max(extraBalance - totalPrinc, 0);
                }

                extraPaymentResults = {
                    interestSaved: baseTotalInterest - extraTotalInterest,
                    monthsSaved: baseMonths - extraMonths,
                    originalMonths: baseMonths,
                    newMonths: extraMonths
                };
            }
            updateExtraPaymentBanner(extraPaymentResults);

            // === CASHFLOW CALCULATION ===
            const totalMonthlyIncome = inputs.monthlyTakeHome + inputs.otherIncome;
            const totalOtherExpenses = Object.values(inputs.expenses).reduce((a, b) => a + b, 0);

            // Debt payments for DTI calculation
            const debtPayments = inputs.expenses.car + inputs.expenses.studentLoans +
                                 inputs.expenses.creditCards + inputs.expenses.otherDebt;

            // Gross monthly income for DTI (use annual / 12)
            const grossMonthlyIncome = inputs.annualIncome / 12;

            // DTI Calculations
            const frontEndDTI = grossMonthlyIncome > 0 ? (monthlyPITI / grossMonthlyIncome) * 100 : 0;
            const backEndDTI = grossMonthlyIncome > 0 ? ((monthlyPITI + debtPayments) / grossMonthlyIncome) * 100 : 0;

            // Cashflow
            const monthlyCashflow = totalMonthlyIncome - trueMonthlyCost - totalOtherExpenses;

            // === PMI CALCULATION ===
            const pmiInfo = calculatePMIRemoval(effectiveLoanAmount, inputs.purchasePrice, monthlyPI, inputs.interestRate, inputs.appreciation, downPaymentPercent, inputs.extraMonthly, inputs.pmiRate);
            updatePMITab(pmiInfo, monthlyPMI, downPaymentPercent);

            // === UPDATE UI ===
            updateSummaryCards(totalCashNeeded, monthlyPITI, trueMonthlyCost, effectiveMonthlyCost, monthlyTaxSavings, isARM, inputs.loanType, monthlyPI, monthlyPropertyTax, monthlyInsurance);
            updateMonthlyBreakdown(monthlyPI, monthlyPropertyTax, monthlyMelloRoos, monthlyInsurance, monthlyPMI, monthlyHOA, monthlyMaintenance, monthlyUtilities);
            updateUpfrontBreakdown(downPayment, closingCosts, escrowReserve, totalCashNeeded);
            updateTaxBreakdown({
                totalInterestYear1,
                deductibleInterest,
                annualPropertyTax,
                deductiblePropertyTax,
                stateIncomeTax: inputs.stateIncomeTax,
                deductibleSALT,
                saltCap,
                itemizedWithHome,
                itemizedWithoutHome,
                standardDeduction,
                shouldItemize,
                wouldItemizeWithoutHome,
                federalTaxSavings,
                stateTaxSavings,
                annualTaxSavings,
                homesteadSavings,
                totalAnnualTaxBenefit,
                federalRate,
                stateRate,
                taxYear: inputs.taxYear,
                annualIncome: inputs.annualIncome,
                stateCode: stateCode
            });
            updateCashflow({
                totalMonthlyIncome,
                trueMonthlyCost,
                totalOtherExpenses,
                monthlyCashflow,
                frontEndDTI,
                backEndDTI,
                grossMonthlyIncome,
                monthlyPITI,
                debtPayments,
                expenses: inputs.expenses,
                monthlyPI,
                monthlyPropertyTax,
                monthlyInsurance,
                monthlyPMI,
                monthlyHOA,
                monthlyMaintenance,
                monthlyUtilities: inputs.utilities,
                monthlyMelloRoos,
                otherIncome: inputs.otherIncome
            });
            updateWealthProjection(wealthData);
            updateAmortizationTable(wealthData);
            updateCharts(monthlyPI, monthlyPropertyTax + monthlyMelloRoos, monthlyInsurance, monthlyPMI, monthlyHOA, monthlyMaintenance, monthlyUtilities, wealthData);
            calculateRentVsBuy(inputs, wealthData, trueMonthlyCost);
          } catch (err) {
            showError('Calculation error: ' + (err.message || 'Please check your inputs.'));
            console.error('calculate() error:', err);
          }
        }

        function updateSummaryCards(totalCashNeeded, monthlyPITI, trueMonthlyCost, effectiveCost, monthlyTaxSavings, isARM, loanType, monthlyPI, monthlyPropertyTax, monthlyInsurance) {
            document.getElementById('totalCashNeeded').textContent = formatCurrency(totalCashNeeded);
            const pitiText = formatCurrency(monthlyPITI);
            document.getElementById('monthlyPayment').textContent = pitiText;
            if (isARM) {
                document.getElementById('monthlyPayment').innerHTML = pitiText + ' <span class="arm-badge">' + loanType + '/1 ARM</span>';
            }
            document.getElementById('trueMonthlyCost').textContent = formatCurrency(trueMonthlyCost);
            document.getElementById('effectiveCost').textContent = formatCurrency(effectiveCost);
            document.getElementById('taxSavingsNote').textContent = monthlyTaxSavings > 0
                ? `Saving ${formatCurrency(monthlyTaxSavings)}/mo in taxes`
                : 'Standard deduction may be better';
            // Hero banner (only update in payment mode; affordability mode sets its own)
            if (currentCalcMode === 'payment') {
                document.getElementById('heroMonthlyPayment').textContent = pitiText;
                if (monthlyPI !== undefined) {
                    document.getElementById('heroPITIBreakdown').textContent =
                        `P&I ${formatCurrency(monthlyPI)} + Tax ${formatCurrency(monthlyPropertyTax)} + Ins ${formatCurrency(monthlyInsurance)}`;
                }
            }
        }

        let cashflowChart;

        function updateCashflow(c) {
            const totalIncome = c.totalMonthlyIncome;
            const housingCost = c.trueMonthlyCost;
            const otherExpenses = c.totalOtherExpenses;
            const cashflow = c.monthlyCashflow;

            // Update summary cards
            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('housingCostSummary').textContent = formatCurrency(housingCost);
            document.getElementById('housingPercent').textContent = totalIncome > 0
                ? `${((housingCost / totalIncome) * 100).toFixed(1)}% of income`
                : '0%';
            document.getElementById('otherExpensesSummary').textContent = formatCurrency(otherExpenses);
            document.getElementById('otherPercent').textContent = totalIncome > 0
                ? `${((otherExpenses / totalIncome) * 100).toFixed(1)}% of income`
                : '0%';
            document.getElementById('monthlyCashflow').textContent = formatCurrency(cashflow);
            document.getElementById('cashflowPercent').textContent = totalIncome > 0
                ? `${((cashflow / totalIncome) * 100).toFixed(1)}% remaining`
                : '0%';

            // Style cashflow box based on positive/negative
            const cashflowBox = document.getElementById('cashflowBox');
            if (cashflow >= 0) {
                cashflowBox.classList.remove('highlight');
                cashflowBox.style.background = 'linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%)';
            } else {
                cashflowBox.style.background = 'linear-gradient(135deg, #fee2e2 0%, #fecaca 100%)';
            }

            // Cashflow advice
            const advice = document.getElementById('cashflowAdvice');
            const housingRatio = totalIncome > 0 ? (housingCost / totalIncome) * 100 : 0;

            if (cashflow < 0) {
                advice.innerHTML = `‚ùå <strong>Negative cashflow!</strong> Your expenses exceed your income by ${formatCurrency(Math.abs(cashflow))}/month. Consider a less expensive home or reducing other expenses.`;
                advice.style.background = '#fee2e2';
                advice.style.borderColor = '#fca5a5';
                advice.style.color = '#991b1b';
            } else if (housingRatio > 35) {
                advice.innerHTML = `‚ö†Ô∏è <strong>Housing cost is high (${housingRatio.toFixed(1)}% of income).</strong> Financial experts recommend keeping housing under 28-30% of gross income. You have ${formatCurrency(cashflow)}/month remaining.`;
                advice.style.background = '#fef3c7';
                advice.style.borderColor = '#fcd34d';
                advice.style.color = '#92400e';
            } else if (cashflow < 500) {
                advice.innerHTML = `‚ö†Ô∏è <strong>Tight budget.</strong> Only ${formatCurrency(cashflow)}/month remaining after all expenses. Consider building more buffer for emergencies.`;
                advice.style.background = '#fef3c7';
                advice.style.borderColor = '#fcd34d';
                advice.style.color = '#92400e';
            } else {
                advice.innerHTML = `‚úÖ <strong>Healthy cashflow!</strong> You have ${formatCurrency(cashflow)}/month (${((cashflow / totalIncome) * 100).toFixed(1)}%) remaining after all expenses. Housing is ${housingRatio.toFixed(1)}% of income.`;
                advice.style.background = '#dcfce7';
                advice.style.borderColor = '#86efac';
                advice.style.color = '#166534';
            }

            // DTI Table
            const dtiHtml = `
                <tr>
                    <td>Gross Monthly Income</td>
                    <td>${formatCurrency(c.grossMonthlyIncome)}</td>
                </tr>
                <tr>
                    <td>Housing Payment (PITI)</td>
                    <td>${formatCurrency(c.monthlyPITI)}</td>
                </tr>
                <tr>
                    <td>Other Debt Payments</td>
                    <td>${formatCurrency(c.debtPayments)}</td>
                </tr>
                <tr class="subtotal">
                    <td>Front-End DTI (Housing Only)</td>
                    <td><span class="tag ${c.frontEndDTI <= 28 ? 'yes' : 'no'}">${c.frontEndDTI.toFixed(1)}%</span></td>
                </tr>
                <tr>
                    <td class="dti-hint">Recommended: ‚â§ 28%</td>
                    <td></td>
                </tr>
                <tr class="subtotal">
                    <td>Back-End DTI (All Debt)</td>
                    <td><span class="tag ${c.backEndDTI <= 36 ? 'yes' : 'no'}">${c.backEndDTI.toFixed(1)}%</span></td>
                </tr>
                <tr>
                    <td class="dti-hint">Recommended: ‚â§ 36-43%</td>
                    <td></td>
                </tr>
            `;
            document.getElementById('dtiTable').innerHTML = dtiHtml;

            // Budget Breakdown Table
            const budgetRows = [
                ['üìà INCOME', '', 'header'],
                ['Take-Home Pay', totalIncome - (c.expenses.savings || 0) - (c.otherIncome || 0), ''],
                ['Other Income', c.otherIncome || 0, ''],
                ['', '', 'spacer'],
                ['üè† HOUSING COSTS', '', 'header'],
                ['Principal & Interest', c.monthlyPI, ''],
                ['Property Tax', c.monthlyPropertyTax, ''],
                ['Special Assessment', c.monthlyMelloRoos, ''],
                ['Homeowners Insurance', c.monthlyInsurance, ''],
                ['PMI', c.monthlyPMI, ''],
                ['HOA', c.monthlyHOA, ''],
                ['Maintenance Reserve', c.monthlyMaintenance, ''],
                ['Utilities', c.monthlyUtilities, ''],
                ['', c.trueMonthlyCost, 'subtotal-housing'],
                ['', '', 'spacer'],
                ['üöó TRANSPORTATION', '', 'header'],
                ['Car Payment', c.expenses.car, ''],
                ['Gas / Transport', c.expenses.gas, ''],
                ['Car Insurance', c.expenses.carInsurance, ''],
                ['', '', 'spacer'],
                ['üçî FOOD', '', 'header'],
                ['Groceries', c.expenses.food, ''],
                ['Dining Out', c.expenses.dining, ''],
                ['', '', 'spacer'],
                ['üè• HEALTH & INSURANCE', '', 'header'],
                ['Health Insurance', c.expenses.health, ''],
                ['Medical / Rx', c.expenses.medical, ''],
                ['', '', 'spacer'],
                ['üí≥ DEBT PAYMENTS', '', 'header'],
                ['Student Loans', c.expenses.studentLoans, ''],
                ['Credit Cards', c.expenses.creditCards, ''],
                ['Other Debt', c.expenses.otherDebt, ''],
                ['', '', 'spacer'],
                ['üéØ LIFESTYLE', '', 'header'],
                ['Phone / Internet', c.expenses.phone, ''],
                ['Subscriptions', c.expenses.subscriptions, ''],
                ['Shopping / Personal', c.expenses.shopping, ''],
                ['Entertainment', c.expenses.entertainment, ''],
                ['Childcare', c.expenses.childcare, ''],
                ['Pets', c.expenses.pets, ''],
                ['Other', c.expenses.other, ''],
                ['', '', 'spacer'],
                ['üí∞ SAVINGS', '', 'header'],
                ['Savings / 401k', c.expenses.savings, ''],
            ].filter(r => r[2] === 'header' || r[2] === 'spacer' || r[2] === 'subtotal-housing' || r[1] > 0);

            let budgetHtml = '';
            for (const row of budgetRows) {
                if (row[2] === 'header') {
                    budgetHtml += `<tr><td colspan="2" style="font-weight:600;padding-top:12px;color:#2563eb;">${row[0]}</td></tr>`;
                } else if (row[2] === 'spacer') {
                    budgetHtml += `<tr><td colspan="2" style="height:8px;"></td></tr>`;
                } else if (row[2] === 'subtotal-housing') {
                    budgetHtml += `<tr class="subtotal"><td>Total Housing</td><td>${formatCurrency(row[1])}</td></tr>`;
                } else {
                    budgetHtml += `<tr><td style="padding-left:16px;">${row[0]}</td><td>${formatCurrency(row[1])}</td></tr>`;
                }
            }

            budgetHtml += `
                <tr><td colspan="2" style="height:12px;"></td></tr>
                <tr class="total"><td>TOTAL EXPENSES</td><td>${formatCurrency(housingCost + otherExpenses)}</td></tr>
                <tr class="total" style="color:${cashflow >= 0 ? '#16a34a' : '#dc2626'}">
                    <td>REMAINING CASHFLOW</td><td>${formatCurrency(cashflow)}</td>
                </tr>
            `;
            document.getElementById('budgetBreakdown').innerHTML = budgetHtml;

            // Cashflow Pie Chart
            const ctx = document.getElementById('cashflowChart').getContext('2d');

            if (cashflowChart) cashflowChart.destroy();

            const chartData = [
                { label: 'Housing', value: housingCost, color: '#2563eb' },
                { label: 'Transportation', value: c.expenses.car + c.expenses.gas + c.expenses.carInsurance, color: '#7c3aed' },
                { label: 'Food', value: c.expenses.food + c.expenses.dining, color: '#ea580c' },
                { label: 'Health', value: c.expenses.health + c.expenses.medical, color: '#0891b2' },
                { label: 'Debt', value: c.expenses.studentLoans + c.expenses.creditCards + c.expenses.otherDebt, color: '#dc2626' },
                { label: 'Lifestyle', value: c.expenses.phone + c.expenses.subscriptions + c.expenses.shopping + c.expenses.entertainment + c.expenses.childcare + c.expenses.pets + c.expenses.other, color: '#16a34a' },
                { label: 'Savings', value: c.expenses.savings, color: '#ca8a04' },
                { label: 'Remaining', value: Math.max(0, cashflow), color: '#64748b' },
            ].filter(d => d.value > 0);

            cashflowChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: chartData.map(d => d.label),
                    datasets: [{
                        data: chartData.map(d => d.value),
                        backgroundColor: chartData.map(d => d.color),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: window.innerWidth <= 768 ? 'bottom' : 'right',
                            labels: { font: { size: 11 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const pct = ((context.raw / totalIncome) * 100).toFixed(1);
                                    return `${context.label}: ${formatCurrency(context.raw)} (${pct}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Populate sr-only data table for screen readers
            const cfTable = document.getElementById('cashflowChartTable');
            if (cfTable) {
                cfTable.innerHTML = '<table><caption>Expense Breakdown</caption><thead><tr><th>Category</th><th>Amount</th></tr></thead><tbody>' +
                    chartData.map(d => '<tr><td>' + d.label + '</td><td>' + formatCurrency(d.value) + '</td></tr>').join('') +
                    '</tbody></table>';
            }
        }

        function updateMonthlyBreakdown(pi, propTax, melloRoos, insurance, pmi, hoa, maintenance, utilities) {
            const rows = [
                ['Principal & Interest', pi],
                ['Property Tax', propTax],
                ['Special Assessment', melloRoos],
                ['Homeowners Insurance', insurance],
                ['PMI', pmi],
                ['HOA', hoa],
            ].filter(r => r[1] > 0);

            const piti = pi + propTax + melloRoos + insurance + pmi + hoa;
            rows.push(['', '', 'subtotal']);
            rows.push(['PITI + HOA + PMI', piti, 'subtotal']);

            rows.push(['Maintenance Reserve', maintenance]);
            rows.push(['Utilities', utilities]);
            rows.push(['', '', 'total']);
            rows.push(['TRUE MONTHLY COST', piti + maintenance + utilities, 'total']);

            document.getElementById('monthlyBreakdown').innerHTML = rows.map(r => {
                if (r[2] === 'subtotal') return `<tr class="subtotal"><td>${r[0]}</td><td>${r[1] ? formatCurrency(r[1]) : ''}</td></tr>`;
                if (r[2] === 'total') return `<tr class="total"><td>${r[0]}</td><td>${r[1] ? formatCurrency(r[1]) : ''}</td></tr>`;
                return `<tr><td>${r[0]}</td><td>${formatCurrency(r[1])}</td></tr>`;
            }).join('');
        }

        function updateUpfrontBreakdown(downPayment, closingCosts, escrowReserve, total) {
            let html = `<tr class="subtotal"><td>Down Payment</td><td>${formatCurrency(downPayment)}</td></tr>`;
            html += '<tr><td colspan="2" style="padding-top:16px;font-weight:600;">Closing Costs</td></tr>';

            for (const [name, amount] of Object.entries(closingCosts)) {
                if (amount > 0) {
                    html += `<tr><td style="padding-left:16px;">${name}</td><td>${formatCurrency(amount)}</td></tr>`;
                }
            }

            const totalClosing = Object.values(closingCosts).reduce((a, b) => a + b, 0);
            html += `<tr class="subtotal"><td>Total Closing Costs</td><td>${formatCurrency(totalClosing)}</td></tr>`;
            html += `<tr><td>Escrow Reserves</td><td>${formatCurrency(escrowReserve)}</td></tr>`;
            html += `<tr class="total"><td>TOTAL CASH NEEDED</td><td>${formatCurrency(total)}</td></tr>`;

            document.getElementById('upfrontBreakdown').innerHTML = html;
        }

        function updateTaxBreakdown(t) {
            const itemizeAdvice = document.getElementById('itemizeAdvice');
            if (t.shouldItemize && t.annualTaxSavings > 0) {
                itemizeAdvice.innerHTML = `‚úÖ <strong>You benefit from itemizing!</strong> Your itemized deductions (${formatCurrency(t.itemizedWithHome)}) exceed the standard deduction (${formatCurrency(t.standardDeduction)}). You save ${formatCurrency(t.annualTaxSavings)}/year vs. renting.`;
                itemizeAdvice.style.background = '#dcfce7';
                itemizeAdvice.style.borderColor = '#86efac';
                itemizeAdvice.style.color = '#166534';
            } else if (t.shouldItemize) {
                itemizeAdvice.innerHTML = `‚ö†Ô∏è <strong>Marginal benefit.</strong> You'll itemize (${formatCurrency(t.itemizedWithHome)} > ${formatCurrency(t.standardDeduction)}), but you'd also itemize as a renter due to high state income tax. Home adds ${formatCurrency(t.annualTaxSavings)}/year benefit.`;
                itemizeAdvice.style.background = '#fef3c7';
                itemizeAdvice.style.borderColor = '#fcd34d';
                itemizeAdvice.style.color = '#92400e';
            } else {
                itemizeAdvice.innerHTML = `‚ùå <strong>No federal tax benefit from mortgage.</strong> Standard deduction (${formatCurrency(t.standardDeduction)}) beats your itemized (${formatCurrency(t.itemizedWithHome)}). You'd take standard deduction either way.`;
                itemizeAdvice.style.background = '#fee2e2';
                itemizeAdvice.style.borderColor = '#fca5a5';
                itemizeAdvice.style.color = '#991b1b';
            }

            const saltCapFormatted = formatCurrency(t.saltCap);

            const html = `
                <tr><td colspan="2" style="font-weight:600;padding-top:8px;">Tax Year: ${t.taxYear} | Income: ${formatCurrency(t.annualIncome)}</td></tr>

                <tr><td colspan="2" style="font-weight:600;padding-top:12px;">Mortgage Interest</td></tr>
                <tr><td style="padding-left:16px;">Interest Paid (Year 1)</td><td>${formatCurrency(t.totalInterestYear1)}</td></tr>
                <tr><td style="padding-left:16px;">Deductible (up to $750k loan)</td><td>${formatCurrency(t.deductibleInterest)}</td></tr>

                <tr><td colspan="2" style="font-weight:600;padding-top:12px;">SALT (State & Local Tax) - ${saltCapFormatted} Cap</td></tr>
                <tr><td style="padding-left:16px;">State Income Tax Paid</td><td>${formatCurrency(t.stateIncomeTax)}</td></tr>
                <tr><td style="padding-left:16px;">Property Tax Paid</td><td>${formatCurrency(t.annualPropertyTax)}</td></tr>
                <tr><td style="padding-left:16px;">Total SALT (uncapped)</td><td>${formatCurrency(t.stateIncomeTax + t.annualPropertyTax)}</td></tr>
                <tr><td style="padding-left:16px;">Deductible SALT (capped at ${saltCapFormatted})</td><td>${formatCurrency(t.deductibleSALT)}</td></tr>
                <tr><td class="dti-hint">‚îî Property Tax portion</td><td style="font-size:0.85em;">${formatCurrency(t.deductiblePropertyTax)}</td></tr>

                <tr><td colspan="2" style="font-weight:600;padding-top:12px;">Federal Itemization Analysis</td></tr>
                <tr><td style="padding-left:16px;">Itemized WITH Home</td><td>${formatCurrency(t.itemizedWithHome)}</td></tr>
                <tr><td style="padding-left:16px;">Itemized WITHOUT Home (renting)</td><td>${formatCurrency(t.itemizedWithoutHome)}</td></tr>
                <tr><td style="padding-left:16px;">Standard Deduction (${t.taxYear})</td><td>${formatCurrency(t.standardDeduction)}</td></tr>
                <tr><td style="padding-left:16px;">Should Itemize with Home?</td><td><span class="tag ${t.shouldItemize ? 'yes' : 'no'}">${t.shouldItemize ? 'YES' : 'NO'}</span></td></tr>
                <tr><td style="padding-left:16px;">Would Itemize as Renter?</td><td><span class="tag ${t.wouldItemizeWithoutHome ? 'yes' : 'no'}">${t.wouldItemizeWithoutHome ? 'YES' : 'NO'}</span></td></tr>

                <tr><td colspan="2" style="font-weight:600;padding-top:12px;">Actual Tax Savings (vs. Renting)</td></tr>
                <tr><td style="padding-left:16px;">Federal Savings (${(t.federalRate*100).toFixed(0)}% bracket)</td><td>${formatCurrency(t.federalTaxSavings)}</td></tr>
                <tr><td style="padding-left:16px;">${t.stateCode || 'State'} State Savings (${(t.stateRate*100).toFixed(1)}% bracket)</td><td>${formatCurrency(t.stateTaxSavings)}</td></tr>
                <tr class="subtotal"><td>Total Income Tax Savings</td><td>${formatCurrency(t.annualTaxSavings)}</td></tr>

                <tr><td colspan="2" style="font-weight:600;padding-top:12px;">Other Benefits</td></tr>
                <tr><td style="padding-left:16px;">Homestead Exemption (${(STATE_META[t.stateCode] || {}).name || 'State'})</td><td>${formatCurrency(t.homesteadSavings)}</td></tr>

                <tr class="total"><td>TOTAL ANNUAL TAX BENEFIT</td><td>${formatCurrency(t.totalAnnualTaxBenefit)}</td></tr>
                <tr><td>Monthly Equivalent</td><td>${formatCurrency(t.totalAnnualTaxBenefit / 12)}</td></tr>
            `;
            document.getElementById('taxBreakdown').innerHTML = html;
        }

        function updateExtraPaymentBanner(results) {
            const banner = document.getElementById('extraPaymentSavings');
            const text = document.getElementById('extraPaymentText');
            if (!results) {
                banner.style.display = 'none';
                return;
            }
            const yearsSaved = Math.floor(results.monthsSaved / 12);
            const moSaved = results.monthsSaved % 12;
            let timeStr = '';
            if (yearsSaved > 0) timeStr += yearsSaved + ' year' + (yearsSaved !== 1 ? 's' : '');
            if (yearsSaved > 0 && moSaved > 0) timeStr += ', ';
            if (moSaved > 0) timeStr += moSaved + ' month' + (moSaved !== 1 ? 's' : '');
            if (!timeStr) timeStr = '0 months';

            text.textContent = 'You save ' + formatCurrency(results.interestSaved) + ' in interest and pay off your mortgage ' + timeStr + ' early (' + Math.ceil(results.newMonths / 12) + '-year payoff vs ' + Math.ceil(results.originalMonths / 12) + '-year).';
            banner.style.display = 'block';
        }

        function updateWealthProjection(wealthData) {
            const year10 = wealthData[9];
            document.getElementById('homeValue10').textContent = formatCurrency(year10.homeValue);
            document.getElementById('equity10').textContent = formatCurrency(year10.totalEquity);
            document.getElementById('wealthImpact10').textContent = formatCurrency(year10.totalWealthImpact);
        }

        function calculatePMIRemoval(loanAmount, purchasePrice, monthlyPI, interestRate, appreciationRate, downPaymentPercent, extraMonthly, pmiRate) {
            if (downPaymentPercent >= 20) {
                return { hasPMI: false };
            }

            extraMonthly = extraMonthly || 0;
            pmiRate = pmiRate || 0.5;
            const monthlyRate = interestRate / 100 / 12;
            const monthlyPMIRate = (pmiRate / 100) / 12;
            let balance = loanAmount;
            let month = 0;
            let totalPMIPaid = 0;
            const monthlyPMI = loanAmount * monthlyPMIRate;

            // Auto-removal at 78% of ORIGINAL purchase price
            const autoRemovalBalance = purchasePrice * 0.78;
            let autoRemovalMonth = null;

            // Request removal at 80% of CURRENT appraised value
            let requestRemovalMonth = null;

            while (month < 360 && balance > 0) {
                month++;
                const interest = balance * monthlyRate;
                const basePrincipal = monthlyPI - interest;
                const extra = Math.min(extraMonthly, balance - basePrincipal);
                const principal = Math.min(basePrincipal + Math.max(extra, 0), balance);
                balance = Math.max(balance - principal, 0);

                if (balance > autoRemovalBalance) {
                    totalPMIPaid += monthlyPMI;
                }

                if (autoRemovalMonth === null && balance <= autoRemovalBalance) {
                    autoRemovalMonth = month;
                }

                // Current value with appreciation
                const currentValue = purchasePrice * Math.pow(1 + appreciationRate / 100, month / 12);
                const currentLTV = (balance / currentValue) * 100;

                if (requestRemovalMonth === null && currentLTV <= 80) {
                    requestRemovalMonth = month;
                }

                if (autoRemovalMonth && requestRemovalMonth) break;
            }

            return {
                hasPMI: true,
                monthlyPMI,
                autoRemovalMonth,
                requestRemovalMonth,
                totalPMIPaidUntilAuto: totalPMIPaid,
                savedByRequesting: autoRemovalMonth && requestRemovalMonth
                    ? (autoRemovalMonth - requestRemovalMonth) * monthlyPMI
                    : 0,
                autoRemovalYear: autoRemovalMonth ? (autoRemovalMonth / 12).toFixed(1) : 'N/A',
                requestRemovalYear: requestRemovalMonth ? (requestRemovalMonth / 12).toFixed(1) : 'N/A'
            };
        }

        function updatePMITab(pmiInfo, monthlyPMI, downPaymentPercent) {
            const advice = document.getElementById('pmiAdvice');
            const stats = document.getElementById('pmiStats');
            const timeline = document.getElementById('pmiTimeline');
            const details = document.getElementById('pmiDetails');

            if (!pmiInfo.hasPMI) {
                advice.innerHTML = '<strong>No PMI Required</strong> ‚Äî Your down payment is 20% or more. You are not paying PMI.';
                advice.style.background = '#dcfce7';
                advice.style.borderColor = '#16a34a';
                advice.style.color = '#166534';
                stats.innerHTML = '';
                timeline.innerHTML = '';
                details.innerHTML = '';
                return;
            }

            advice.innerHTML = '<strong>PMI is required</strong> ‚Äî Down payment is ' + downPaymentPercent.toFixed(1) + '% (under 20%). You can request removal early or it auto-cancels at 78% LTV.';
            advice.style.background = '#fef3c7';
            advice.style.borderColor = '#f59e0b';
            advice.style.color = '#92400e';

            stats.innerHTML = `
                <div class="pmi-stat">
                    <div class="val">${formatCurrency(monthlyPMI)}</div>
                    <div class="label">Monthly PMI</div>
                </div>
                <div class="pmi-stat">
                    <div class="val">${pmiInfo.requestRemovalYear} yrs</div>
                    <div class="label">Request Removal (80% current value)</div>
                </div>
                <div class="pmi-stat">
                    <div class="val">${pmiInfo.autoRemovalYear} yrs</div>
                    <div class="label">Auto Cancellation (78% original)</div>
                </div>
                <div class="pmi-stat">
                    <div class="val">${formatCurrency(pmiInfo.totalPMIPaidUntilAuto)}</div>
                    <div class="label">Total PMI if You Wait</div>
                </div>
            `;

            // Timeline bar
            const maxMonths = pmiInfo.autoRemovalMonth || 120;
            const requestPct = pmiInfo.requestRemovalMonth ? (pmiInfo.requestRemovalMonth / maxMonths * 100) : 0;
            timeline.innerHTML = `
                <h3 style="margin:16px 0 8px;font-size:0.95rem;">PMI Timeline</h3>
                <div class="pmi-timeline">
                    <div class="pmi-timeline-bar">
                        <div class="pmi-timeline-fill" style="width:${requestPct}%;background:#16a34a;display:inline-block;float:left;" title="Request removal"></div>
                        <div class="pmi-timeline-fill" style="width:${100 - requestPct}%;background:#f59e0b;display:inline-block;float:left;" title="Auto cancel"></div>
                    </div>
                </div>
                <div style="display:flex;justify-content:space-between;font-size:0.75rem;color:var(--text-muted);margin-top:4px;">
                    <span>Month 0</span>
                    ${pmiInfo.requestRemovalMonth ? `<span style="color:#16a34a;">Request @ mo ${pmiInfo.requestRemovalMonth}</span>` : ''}
                    <span style="color:#f59e0b;">Auto @ mo ${pmiInfo.autoRemovalMonth || '?'}</span>
                </div>
            `;

            if (pmiInfo.savedByRequesting > 0) {
                details.innerHTML = `
                    <div style="margin-top:12px;padding:12px;background:#eff6ff;border-radius:8px;border-left:3px solid var(--primary);">
                        <strong>Save ${formatCurrency(pmiInfo.savedByRequesting)}</strong> by requesting PMI removal at month ${pmiInfo.requestRemovalMonth} instead of waiting for auto-cancellation at month ${pmiInfo.autoRemovalMonth}.
                        You'll need a new appraisal (~$500) to prove 80% LTV based on current market value.
                    </div>
                `;
            } else {
                details.innerHTML = '';
            }
        }

        function toggleARMInputs() {
            const loanType = document.getElementById('loanType').value;
            const armInputs = document.getElementById('armInputs');
            armInputs.style.display = loanType === 'fixed' ? 'none' : 'block';
        }

        function toggleAdvancedMode(forceState) {
            const isAdvanced = forceState !== undefined ? forceState : !document.body.classList.contains('advanced-mode');
            document.body.classList.toggle('advanced-mode', isAdvanced);
            const toggle = document.getElementById('advancedToggle');
            toggle.classList.toggle('on', isAdvanced);
            toggle.setAttribute('aria-checked', isAdvanced);
            document.getElementById('simpleModeLabel').classList.toggle('active', !isAdvanced);
            document.getElementById('advancedModeLabel').classList.toggle('active', isAdvanced);
            try { localStorage.setItem('calcAdvancedMode', isAdvanced ? '1' : '0'); } catch (e) {}
            // If switching to simple mode while on Income/Expenses tab, go back to Property
            if (!isAdvanced) {
                const activeTab = document.querySelector('.tabs [role="tab"][aria-selected="true"]');
                if (activeTab && (activeTab.id === 'tab-income' || activeTab.id === 'tab-expenses')) {
                    showInputTab('propertyTab', document.getElementById('tab-property'));
                }
            }
        }

        // ========================================
        // AFFORDABILITY CALCULATOR
        // ========================================
        let currentCalcMode = 'payment';
        let savedPurchasePrice = null;

        function setCalcMode(mode) {
            const priceInput = document.getElementById('purchasePrice');
            if (mode === 'affordability' && currentCalcMode !== 'affordability') {
                savedPurchasePrice = priceInput.value;
            } else if (mode === 'payment' && currentCalcMode === 'affordability' && savedPurchasePrice !== null) {
                priceInput.value = savedPurchasePrice;
                savedPurchasePrice = null;
            }
            currentCalcMode = mode;
            const btns = document.querySelectorAll('.calc-mode-btn');
            btns.forEach(btn => {
                const isActive = (mode === 'payment' && btn.textContent.includes('Monthly')) ||
                                 (mode === 'affordability' && btn.textContent.includes('Afford'));
                btn.classList.toggle('active', isActive);
                btn.setAttribute('aria-checked', isActive);
            });
            if (mode === 'affordability') {
                priceInput.readOnly = true;
                priceInput.classList.add('readonly-input');
                document.getElementById('heroLabel').textContent = 'Maximum Purchase Price';
            } else {
                priceInput.readOnly = false;
                priceInput.classList.remove('readonly-input');
                document.getElementById('heroLabel').textContent = 'Your Monthly Payment';
            }
            calculate();
        }

        function calculateAffordability() {
            // Binary search for max price where PITI <= 28% of gross monthly income
            const inputs = getInputs();
            const usingFallback = inputs.annualIncome <= 0;
            const grossMonthly = usingFallback ? 150000 / 12 : inputs.annualIncome / 12;
            const targetPITI = grossMonthly * 0.28;

            const dpInfo = getDownPayment();
            const dpMode = document.getElementById('downPaymentMode').value;

            let lo = 50000, hi = 10000000;
            for (let i = 0; i < 30; i++) {
                const mid = Math.round((lo + hi) / 2);
                const dp = dpMode === 'amount' ? dpInfo.amount : mid * (dpInfo.percent / 100);
                const loan = mid - dp;
                const pi = calculateMonthlyPayment(loan, inputs.interestRate, inputs.loanTerm);
                const tax = (mid * inputs.propertyTaxRate / 100) / 12;
                const ins = inputs.insurance / 12;
                const dpPercent = mid > 0 ? (dp / mid) * 100 : 0;
                const pmi = (dpPercent < 20) ? (loan * (inputs.pmiRate / 100)) / 12 : 0;
                const hoa = inputs.hoa || 0;
                const maint = (mid * (inputs.maintenance || 0) / 100) / 12;
                const utils = inputs.utilities || 0;
                const piti = pi + tax + ins + pmi + hoa + maint + utils;
                if (piti <= targetPITI) {
                    lo = mid;
                } else {
                    hi = mid;
                }
            }
            // Clamp and round to nearest $1000
            const maxPrice = Math.min(Math.max(Math.round(lo / 1000) * 1000, 50000), 10000000);
            document.getElementById('purchasePrice').value = maxPrice;
            syncDownPaymentHint();
            // Update hero to show max price
            document.getElementById('heroMonthlyPayment').textContent = formatCurrency(maxPrice);
            const incomeNote = usingFallback
                ? `‚ö† No income entered ‚Äî using $150k estimate. Enter your income in the Income tab for accurate results.`
                : `Based on ${formatCurrency(Math.round(grossMonthly))} gross monthly income (28% DTI)`;
            document.getElementById('heroPITIBreakdown').textContent = incomeNote;
        }

        // ========================================
        // RENT VS BUY
        // ========================================
        let rentVsBuyChart;

        function calculateRentVsBuy(inputs, wealthData, trueMonthlyCost) {
            const rentAmount = parseFloat(document.getElementById('rentAmount').value) || 3000;
            const rentIncrease = (parseFloat(document.getElementById('rentIncrease').value) || 3) / 100;
            const investReturn = (parseFloat(document.getElementById('investReturn').value) || 7) / 100;

            const dp = getDownPayment();
            const downPayment = dp.amount;
            const years = 10;
            const yearData = [];
            let cumulativeRent = 0;
            let cumulativeBuy = 0;
            let renterPortfolio = downPayment; // Renter invests the down payment
            let breakEvenYear = null;

            for (let y = 1; y <= years; y++) {
                const wd = wealthData[y - 1] || wealthData[wealthData.length - 1];
                const currentRent = rentAmount * Math.pow(1 + rentIncrease, y - 1);
                const yearlyRent = currentRent * 12;
                cumulativeRent += yearlyRent;

                // Renter invests monthly savings (buy cost - rent cost) + grows portfolio
                const monthlySavings = Math.max(0, trueMonthlyCost - currentRent);
                renterPortfolio = renterPortfolio * (1 + investReturn) + monthlySavings * 12;

                // Buyer: cumulative housing costs
                cumulativeBuy += trueMonthlyCost * 12;
                const buyerWealth = wd.totalEquity || 0;

                if (!breakEvenYear && buyerWealth > renterPortfolio) {
                    breakEvenYear = y;
                }

                yearData.push({
                    year: y,
                    rent: Math.round(yearlyRent),
                    cumulativeRent: Math.round(cumulativeRent),
                    buyCost: Math.round(trueMonthlyCost * 12),
                    cumulativeBuy: Math.round(cumulativeBuy),
                    buyerWealth: Math.round(buyerWealth),
                    renterWealth: Math.round(renterPortfolio)
                });
            }

            // Update summary boxes
            document.getElementById('breakEvenYear').textContent = breakEvenYear ? `Year ${breakEvenYear}` : '> 10 years';
            document.getElementById('totalRentCost').textContent = formatCurrency(cumulativeRent);
            document.getElementById('totalBuyCost').textContent = formatCurrency(cumulativeBuy);

            // Advice banner
            const adviceEl = document.getElementById('rentVsBuyAdvice');
            if (breakEvenYear && breakEvenYear <= 5) {
                adviceEl.style.background = '#dcfce7';
                adviceEl.style.color = '#166534';
                adviceEl.innerHTML = `<strong>Buying looks favorable.</strong> You break even in just ${breakEvenYear} year${breakEvenYear > 1 ? 's' : ''}, making homeownership a strong financial choice here.`;
            } else if (breakEvenYear && breakEvenYear <= 10) {
                adviceEl.style.background = '#fef3c7';
                adviceEl.style.color = '#92400e';
                adviceEl.innerHTML = `<strong>Moderate outlook.</strong> Break-even at year ${breakEvenYear}. Buying makes sense if you plan to stay at least ${breakEvenYear}+ years.`;
            } else {
                adviceEl.style.background = '#fee2e2';
                adviceEl.style.color = '#991b1b';
                adviceEl.innerHTML = `<strong>Renting may be better.</strong> Buying doesn't break even within 10 years. Consider renting and investing the difference.`;
            }

            // Update chart
            const ctx = document.getElementById('rentVsBuyChart');
            if (ctx) {
                if (rentVsBuyChart) rentVsBuyChart.destroy();
                rentVsBuyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: yearData.map(d => `Year ${d.year}`),
                        datasets: [
                            {
                                label: 'Buyer Wealth (Equity)',
                                data: yearData.map(d => d.buyerWealth),
                                borderColor: '#2563eb',
                                backgroundColor: 'rgba(37,99,235,0.1)',
                                fill: true,
                                tension: 0.3
                            },
                            {
                                label: 'Renter Wealth (Portfolio)',
                                data: yearData.map(d => d.renterWealth),
                                borderColor: '#ea580c',
                                backgroundColor: 'rgba(234,88,12,0.1)',
                                fill: true,
                                tension: 0.3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: ctx => `${ctx.dataset.label}: ${formatCurrency(ctx.parsed.y)}`
                                }
                            }
                        },
                        scales: {
                            y: {
                                ticks: { callback: v => formatCurrency(v) }
                            }
                        }
                    }
                });
            }

            // sr-only table
            let srHtml = '<table><caption>Rent vs Buy Comparison</caption><thead><tr><th>Year</th><th>Annual Rent</th><th>Annual Buy Cost</th><th>Buyer Wealth</th><th>Renter Wealth</th></tr></thead><tbody>';
            yearData.forEach(d => {
                srHtml += `<tr><td>${d.year}</td><td>${formatCurrency(d.rent)}</td><td>${formatCurrency(d.buyCost)}</td><td>${formatCurrency(d.buyerWealth)}</td><td>${formatCurrency(d.renterWealth)}</td></tr>`;
            });
            srHtml += '</tbody></table>';
            document.getElementById('rentVsBuyChartTable').innerHTML = srHtml;

            // Visible table
            let tableHtml = '<thead><tr><th>Year</th><th>Annual Rent</th><th>Cumul. Rent</th><th>Annual Buy</th><th>Cumul. Buy</th><th>Buyer Wealth</th><th>Renter Wealth</th></tr></thead><tbody>';
            yearData.forEach(d => {
                const highlight = d.year === breakEvenYear ? ' style="background:#dcfce7;"' : '';
                tableHtml += `<tr${highlight}><td>${d.year}</td><td>${formatCurrency(d.rent)}</td><td>${formatCurrency(d.cumulativeRent)}</td><td>${formatCurrency(d.buyCost)}</td><td>${formatCurrency(d.cumulativeBuy)}</td><td>${formatCurrency(d.buyerWealth)}</td><td>${formatCurrency(d.renterWealth)}</td></tr>`;
            });
            tableHtml += '</tbody>';
            document.getElementById('rentVsBuyTable').innerHTML = tableHtml;
        }

        function updateAmortizationTable(wealthData) {
            const showARM = wealthData.some((d, i) => i > 0 && d.rate !== wealthData[0].rate);
            let html = `
                <thead>
                    <tr>
                        <th>Year</th>
                        ${showARM ? '<th>Rate</th><th>Payment</th>' : ''}
                        <th>Home Value</th>
                        <th>Mortgage Bal.</th>
                        <th>Interest</th>
                        <th>Principal</th>
                        <th>Equity</th>
                        <th>Tax Savings</th>
                    </tr>
                </thead>
                <tbody>
            `;

            for (const d of wealthData) {
                const rateChanged = d.rate !== wealthData[0].rate;
                html += `
                    <tr${rateChanged ? ' style="background:#fef3c7;"' : ''}>
                        <td>${d.year}</td>
                        ${showARM ? `<td>${d.rate.toFixed(2)}%</td><td>${formatCurrency(d.monthlyPayment)}</td>` : ''}
                        <td>${formatCurrency(d.homeValue)}</td>
                        <td>${formatCurrency(d.remainingMortgage)}</td>
                        <td>${formatCurrency(d.yearInterest)}</td>
                        <td>${formatCurrency(d.yearPrincipal)}</td>
                        <td>${formatCurrency(d.totalEquity)}</td>
                        <td>${formatCurrency(d.cumulativeTaxSavings)}</td>
                    </tr>
                `;
            }

            html += '</tbody>';
            document.getElementById('amortizationTable').innerHTML = html;
        }

        // ========================================
        // CHARTS
        // ========================================
        let monthlyChart, wealthChart;

        function updateCharts(pi, tax, insurance, pmi, hoa, maintenance, utilities, wealthData) {
            // Monthly breakdown pie chart
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');

            if (monthlyChart) monthlyChart.destroy();

            const monthlyData = [
                { label: 'Principal & Interest', value: pi, color: '#2563eb' },
                { label: 'Property Tax', value: tax, color: '#7c3aed' },
                { label: 'Insurance', value: insurance, color: '#0891b2' },
                { label: 'PMI', value: pmi, color: '#ea580c' },
                { label: 'HOA', value: hoa, color: '#16a34a' },
                { label: 'Maintenance', value: maintenance, color: '#ca8a04' },
                { label: 'Utilities', value: utilities, color: '#64748b' },
            ].filter(d => d.value > 0);

            monthlyChart = new Chart(monthlyCtx, {
                type: 'doughnut',
                data: {
                    labels: monthlyData.map(d => d.label),
                    datasets: [{
                        data: monthlyData.map(d => d.value),
                        backgroundColor: monthlyData.map(d => d.color),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: window.innerWidth <= 768 ? 'bottom' : 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    }
                }
            });

            // Wealth building chart
            const wealthCtx = document.getElementById('wealthChart').getContext('2d');

            if (wealthChart) wealthChart.destroy();

            wealthChart = new Chart(wealthCtx, {
                type: 'line',
                data: {
                    labels: wealthData.map(d => 'Year ' + d.year),
                    datasets: [
                        {
                            label: 'Home Value',
                            data: wealthData.map(d => d.homeValue),
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            fill: false,
                            tension: 0.3
                        },
                        {
                            label: 'Mortgage Balance',
                            data: wealthData.map(d => d.remainingMortgage),
                            borderColor: '#dc2626',
                            backgroundColor: 'rgba(220, 38, 38, 0.1)',
                            fill: false,
                            tension: 0.3
                        },
                        {
                            label: 'Total Equity',
                            data: wealthData.map(d => d.totalEquity),
                            borderColor: '#16a34a',
                            backgroundColor: 'rgba(22, 163, 74, 0.1)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });

            // Populate sr-only data tables for screen readers
            const monthlyTable = document.getElementById('monthlyChartTable');
            if (monthlyTable) {
                monthlyTable.innerHTML = '<table><caption>Monthly Housing Cost Breakdown</caption><thead><tr><th>Category</th><th>Amount</th></tr></thead><tbody>' +
                    monthlyData.map(d => '<tr><td>' + d.label + '</td><td>' + formatCurrency(d.value) + '</td></tr>').join('') +
                    '</tbody></table>';
            }

            const wealthTable = document.getElementById('wealthChartTable');
            if (wealthTable) {
                wealthTable.innerHTML = '<table><caption>10-Year Wealth Projection</caption><thead><tr><th>Year</th><th>Home Value</th><th>Mortgage Balance</th><th>Total Equity</th></tr></thead><tbody>' +
                    wealthData.map(d => '<tr><td>' + d.year + '</td><td>' + formatCurrency(d.homeValue) + '</td><td>' + formatCurrency(d.remainingMortgage) + '</td><td>' + formatCurrency(d.totalEquity) + '</td></tr>').join('') +
                    '</tbody></table>';
            }
        }

        // ========================================
        // TAB SWITCHING
        // ========================================
        function showTab(tabId, btn) {
            // Right panel tabs ‚Äî update ARIA states
            const resultsCard = document.querySelector('section[aria-label="Results"] .card');
            resultsCard.querySelectorAll('.tabs [role="tab"]').forEach(t => {
                t.classList.remove('active');
                t.setAttribute('aria-selected', 'false');
            });
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            btn.classList.add('active');
            btn.setAttribute('aria-selected', 'true');
            document.getElementById(tabId).classList.add('active');
        }

        function showInputTab(tabId, btn) {
            // Left panel input tabs ‚Äî update ARIA states
            const inputCard = document.querySelector('.sticky-sidebar .card, aside .card');
            inputCard.querySelectorAll('[role="tab"]').forEach(t => {
                t.classList.remove('active');
                t.setAttribute('aria-selected', 'false');
            });
            inputCard.querySelectorAll('.input-tab-content').forEach(c => c.classList.remove('active'));

            btn.classList.add('active');
            btn.setAttribute('aria-selected', 'true');
            document.getElementById(tabId).classList.add('active');
        }

        // Arrow key navigation for tab lists
        document.querySelectorAll('[role="tablist"]').forEach(tablist => {
            tablist.addEventListener('keydown', function(e) {
                const tabs = Array.from(this.querySelectorAll('[role="tab"]'));
                const current = tabs.indexOf(document.activeElement);
                if (current === -1) return;
                let next;
                if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                    next = (current + 1) % tabs.length;
                } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                    next = (current - 1 + tabs.length) % tabs.length;
                } else if (e.key === 'Home') {
                    next = 0;
                } else if (e.key === 'End') {
                    next = tabs.length - 1;
                } else {
                    return;
                }
                e.preventDefault();
                tabs[next].focus();
                tabs[next].click();
            });
        });

        // ========================================
        // SAVE / LOAD / RESET
        // ========================================
        const STORAGE_KEY = 'houseCalculatorData';

        // List of all input field IDs to save
        const inputFields = [
            'stateSelect',
            'purchasePrice', 'downPaymentMode', 'downPaymentPercent', 'downPaymentAmount', 'interestRate', 'loanTerm',
            'loanType', 'armAdjustment', 'armCap',
            'countySelect', 'propertyTaxRate', 'melloRoos',
            'insurance', 'hoa', 'pmiRate', 'maintenance', 'utilities',
            'taxYear', 'filingStatus', 'annualIncome',
            'appreciation', 'extraMonthly', 'lumpSum',
            // Person 1 compensation
            'baseSalary1', 'annualBonus1', 'bonusFreq1', 'annualRSU1', 'rsuFreq1', 'retirement401k1', 'preTaxDeductions1',
            // Person 2 compensation
            'baseSalary2', 'annualBonus2', 'bonusFreq2', 'annualRSU2', 'rsuFreq2', 'retirement401k2', 'preTaxDeductions2',
            'monthlyTakeHome', 'otherIncome',
            'expCar', 'expGas', 'expCarInsurance', 'expHealth',
            'expFood', 'expDining', 'expPhone', 'expSubscriptions',
            'expChildcare', 'expStudentLoans', 'expCreditCards', 'expOtherDebt',
            'expShopping', 'expEntertainment', 'expMedical', 'expPets',
            'expSavings', 'expOther',
            // Rent vs Buy
            'rentAmount', 'rentIncrease', 'investReturn'
        ];

        function saveData() {
            const data = {};
            inputFields.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    data[id] = el.value;
                }
            });

            data.overrideTakeHome = document.getElementById('overrideTakeHome').checked;
            try { localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); } catch (e) {}

            // Show save confirmation
            const status = document.getElementById('saveStatus');
            status.textContent = '‚úì Saved!';
            setTimeout(() => {
                status.textContent = '';
            }, 2000);
        }

        function loadData() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return false;

            try {
                const data = JSON.parse(saved);
                // Backward compatibility: default to CA if no state saved
                if (!data.stateSelect) data.stateSelect = 'CA';
                inputFields.forEach(id => {
                    const el = document.getElementById(id);
                    if (el && data[id] !== undefined) {
                        el.value = data[id];
                    }
                });

                // Rebuild county dropdown for loaded state, then restore saved county/tax
                const savedCounty = data.countySelect;
                const savedTaxRate = data.propertyTaxRate;
                if (data.stateSelect) onStateChange();
                if (savedCounty !== undefined) document.getElementById('countySelect').value = savedCounty;
                if (savedTaxRate !== undefined) document.getElementById('propertyTaxRate').value = savedTaxRate;

                // Apply down payment mode display
                applyDownPaymentMode();
                toggleARMInputs();
                if (data.overrideTakeHome) {
                    document.getElementById('overrideTakeHome').checked = true;
                    toggleTakeHomeOverride();
                } else {
                    document.getElementById('overrideTakeHome').checked = false;
                }

                return true;
            } catch (e) {
                console.error('Error loading saved data:', e);
                return false;
            }
        }

        function applyDownPaymentMode() {
            const mode = document.getElementById('downPaymentMode').value;
            const percentInput = document.getElementById('downPaymentPercent');
            const amountInput = document.getElementById('downPaymentAmount');

            if (mode === 'percent') {
                percentInput.style.display = 'block';
                amountInput.style.display = 'none';
            } else {
                percentInput.style.display = 'none';
                amountInput.style.display = 'block';
            }
        }

        function resetData() {
            if (!confirm('Reset all values to defaults? This cannot be undone.')) {
                return;
            }

            localStorage.removeItem(STORAGE_KEY);

            // Default values
            const defaults = {
                stateSelect: 'CA',
                purchasePrice: 800000,
                downPaymentMode: 'percent',
                downPaymentPercent: 20,
                downPaymentAmount: 160000,
                interestRate: 6.5,
                loanTerm: 30,
                loanType: 'fixed',
                armAdjustment: 0.25,
                armCap: 11,
                countySelect: '1.10',
                propertyTaxRate: 1.1,
                melloRoos: 0,
                insurance: 2400,
                hoa: 0,
                pmiRate: 0.5,
                maintenance: 1,
                utilities: 300,
                taxYear: String(Math.min(CURRENT_YEAR, LATEST_DATA_YEAR)),
                filingStatus: 'married_jointly',
                annualIncome: 480000,
                appreciation: 3,
                extraMonthly: 0,
                lumpSum: 0,
                // Person 1 compensation defaults
                baseSalary1: 200000,
                annualBonus1: 30000,
                bonusFreq1: 'annual',
                annualRSU1: 50000,
                rsuFreq1: 'quarterly',
                retirement401k1: 6,
                preTaxDeductions1: 500,
                // Person 2 compensation defaults
                baseSalary2: 150000,
                annualBonus2: 20000,
                bonusFreq2: 'annual',
                annualRSU2: 30000,
                rsuFreq2: 'quarterly',
                retirement401k2: 6,
                preTaxDeductions2: 300,
                monthlyTakeHome: 20000,
                otherIncome: 0,
                expCar: 500,
                expGas: 300,
                expCarInsurance: 200,
                expHealth: 400,
                expFood: 800,
                expDining: 400,
                expPhone: 150,
                expSubscriptions: 100,
                expChildcare: 0,
                expStudentLoans: 0,
                expCreditCards: 0,
                expOtherDebt: 0,
                expShopping: 300,
                expEntertainment: 200,
                expMedical: 100,
                expPets: 0,
                expSavings: 1000,
                expOther: 200,
                // Rent vs Buy
                rentAmount: 3000,
                rentIncrease: 3,
                investReturn: 7
            };

            inputFields.forEach(id => {
                const el = document.getElementById(id);
                if (el && defaults[id] !== undefined) {
                    el.value = defaults[id];
                }
            });

            applyDownPaymentMode();
            toggleARMInputs();
            onStateChange(); // Rebuild county dropdown for default state
            document.getElementById('overrideTakeHome').checked = false;
            toggleTakeHomeOverride();
            calculateTakeHome();
            updateTaxRules();

            const status = document.getElementById('saveStatus');
            status.textContent = '‚úì Reset to defaults';
            setTimeout(() => {
                status.textContent = '';
            }, 2000);
        }

        // ========================================
        // ACCESSIBLE TOOLTIPS
        // ========================================
        function initTooltips() {
            document.querySelectorAll('[data-tooltip]').forEach(el => {
                const text = el.getAttribute('data-tooltip');
                // Create info button
                const btn = document.createElement('button');
                btn.className = 'tooltip-trigger';
                btn.setAttribute('aria-label', 'More info');
                btn.setAttribute('type', 'button');
                btn.textContent = '?';
                // Create bubble
                const bubble = document.createElement('div');
                bubble.className = 'tooltip-bubble';
                bubble.setAttribute('role', 'tooltip');
                bubble.textContent = text;
                // Insert into the h3 if present, otherwise into the element
                const heading = el.querySelector('h3');
                if (heading) {
                    heading.appendChild(btn);
                } else {
                    el.appendChild(btn);
                }
                el.appendChild(bubble);
                // Toggle on click
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const wasOpen = el.classList.contains('tooltip-open');
                    // Close all other tooltips
                    document.querySelectorAll('.tooltip-open').forEach(t => {
                        t.classList.remove('tooltip-open');
                        const b = t.querySelector('.tooltip-bubble');
                        if (b) { b.style.left = ''; b.style.transform = ''; }
                    });
                    if (!wasOpen) {
                        el.classList.add('tooltip-open');
                        // Adjust position to prevent viewport clipping
                        requestAnimationFrame(() => {
                            const rect = bubble.getBoundingClientRect();
                            if (rect.left < 8) {
                                bubble.style.left = '0';
                                bubble.style.transform = 'none';
                            } else if (rect.right > window.innerWidth - 8) {
                                bubble.style.left = 'auto';
                                bubble.style.right = '0';
                                bubble.style.transform = 'none';
                            }
                        });
                    }
                });
            });
            // Close tooltips when clicking elsewhere
            document.addEventListener('click', function() {
                document.querySelectorAll('.tooltip-open').forEach(t => t.classList.remove('tooltip-open'));
            });
        }
        initTooltips();

        // ========================================
        // URL SHARING
        // ========================================
        const URL_PARAM_MAP = {
            state: 'stateSelect',
            price: 'purchasePrice',
            down: 'downPaymentPercent',
            rate: 'interestRate',
            term: 'loanTerm',
            type: 'loanType',
            tax: 'propertyTaxRate',
            county: 'countySelect',
            hoa: 'hoa',
            ins: 'insurance',
            income: 'monthlyTakeHome',
            appr: 'appreciation',
            extra: 'extraMonthly',
            lump: 'lumpSum',
            rent: 'rentAmount',
            rinc: 'rentIncrease',
            inv: 'investReturn'
        };

        function buildShareURL() {
            const params = new URLSearchParams();
            for (const [param, fieldId] of Object.entries(URL_PARAM_MAP)) {
                const el = document.getElementById(fieldId);
                if (el) params.set(param, el.value);
            }
            return window.location.origin + window.location.pathname + '?' + params.toString();
        }

        function exportPDF() {
            if (typeof html2pdf === 'undefined') {
                alert('PDF library is still loading. Please try again in a moment.');
                return;
            }
            const inputs = getInputs();
            const dp = getDownPayment();
            const div = document.createElement('div');
            div.style.padding = '30px';
            div.style.fontFamily = 'system-ui, sans-serif';
            div.style.color = '#1e293b';
            div.style.maxWidth = '700px';
            div.innerHTML = `
                <h1 style="font-size:22px;margin-bottom:4px;">Mortgage Payment Summary</h1>
                <p style="color:#64748b;font-size:13px;margin-bottom:20px;">Generated ${new Date().toLocaleDateString()} ¬∑ Not financial advice</p>
                <div style="background:#2563eb;color:white;padding:20px;border-radius:10px;text-align:center;margin-bottom:20px;">
                    <div style="font-size:14px;opacity:0.85;">Monthly Payment (PITI)</div>
                    <div style="font-size:36px;font-weight:800;">${document.getElementById('monthlyPayment').textContent}</div>
                </div>
                <table style="width:100%;border-collapse:collapse;font-size:14px;margin-bottom:20px;">
                    <tr style="border-bottom:1px solid #e2e8f0;"><td style="padding:8px 0;color:#64748b;">State</td><td style="padding:8px 0;text-align:right;font-weight:600;">${inputs.stateCode}</td></tr>
                    <tr style="border-bottom:1px solid #e2e8f0;"><td style="padding:8px 0;color:#64748b;">Purchase Price</td><td style="padding:8px 0;text-align:right;font-weight:600;">${formatCurrency(inputs.purchasePrice)}</td></tr>
                    <tr style="border-bottom:1px solid #e2e8f0;"><td style="padding:8px 0;color:#64748b;">Down Payment</td><td style="padding:8px 0;text-align:right;font-weight:600;">${formatCurrency(dp.amount)} (${dp.percent.toFixed(0)}%)</td></tr>
                    <tr style="border-bottom:1px solid #e2e8f0;"><td style="padding:8px 0;color:#64748b;">Interest Rate</td><td style="padding:8px 0;text-align:right;font-weight:600;">${inputs.interestRate}%</td></tr>
                    <tr style="border-bottom:1px solid #e2e8f0;"><td style="padding:8px 0;color:#64748b;">Loan Term</td><td style="padding:8px 0;text-align:right;font-weight:600;">${inputs.loanTerm} years</td></tr>
                    <tr style="border-bottom:1px solid #e2e8f0;"><td style="padding:8px 0;color:#64748b;">Cash Needed at Closing</td><td style="padding:8px 0;text-align:right;font-weight:600;">${document.getElementById('totalCashNeeded').textContent}</td></tr>
                    <tr style="border-bottom:1px solid #e2e8f0;"><td style="padding:8px 0;color:#64748b;">True Monthly Cost</td><td style="padding:8px 0;text-align:right;font-weight:600;">${document.getElementById('trueMonthlyCost').textContent}</td></tr>
                    <tr><td style="padding:8px 0;color:#64748b;">Effective (After Tax)</td><td style="padding:8px 0;text-align:right;font-weight:600;">${document.getElementById('effectiveCost').textContent}</td></tr>
                </table>
                <p style="font-size:11px;color:#94a3b8;border-top:1px solid #e2e8f0;padding-top:12px;">This is an estimate for informational purposes only. Consult a qualified financial advisor for personalized advice. Generated by Mortgage Payment Calculator.</p>
            `;
            html2pdf().set({
                margin: [10, 10, 10, 10],
                filename: 'mortgage-summary.pdf',
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            }).from(div).save();
        }

        function shareURL() {
            const url = buildShareURL();
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(url).then(() => {
                    const status = document.getElementById('saveStatus');
                    status.textContent = '‚úì Link copied!';
                    setTimeout(() => { status.textContent = ''; }, 2000);
                }).catch(() => {
                    prompt('Copy this URL to share:', url);
                });
            } else {
                prompt('Copy this URL to share:', url);
            }
        }

        function loadFromURL() {
            const params = new URLSearchParams(window.location.search);
            if (params.toString() === '') return false;
            let loaded = false;
            for (const [param, fieldId] of Object.entries(URL_PARAM_MAP)) {
                if (params.has(param)) {
                    const el = document.getElementById(fieldId);
                    if (el) {
                        el.value = params.get(param);
                        loaded = true;
                    }
                }
            }
            if (loaded && params.has('state')) {
                const savedCounty = params.has('county') ? document.getElementById('countySelect').value : undefined;
                const savedTaxRate = params.has('tax') ? document.getElementById('propertyTaxRate').value : undefined;
                onStateChange();
                if (savedCounty !== undefined) document.getElementById('countySelect').value = savedCounty;
                if (savedTaxRate !== undefined) document.getElementById('propertyTaxRate').value = savedTaxRate;
            }
            return loaded;
        }

        // ========================================
        // SCENARIO COMPARISON
        // ========================================
        const SCENARIO_STORAGE_KEY = 'houseCalcScenarios';
        const MAX_SCENARIOS = 3;

        function escapeHTML(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function getScenarios() {
            try {
                return JSON.parse(localStorage.getItem(SCENARIO_STORAGE_KEY)) || [];
            } catch (e) { return []; }
        }

        function saveScenario() {
            const scenarios = getScenarios();
            if (scenarios.length >= MAX_SCENARIOS) {
                alert('Maximum ' + MAX_SCENARIOS + ' scenarios. Delete one to save a new one.');
                return;
            }
            const name = prompt('Scenario name:', 'Scenario ' + (scenarios.length + 1));
            if (!name) return;

            const snapshot = {
                name: name,
                timestamp: Date.now(),
                price: document.getElementById('purchasePrice').value,
                down: getDownPayment().percent,
                rate: document.getElementById('interestRate').value,
                term: document.getElementById('loanTerm').value,
                cashNeeded: document.getElementById('totalCashNeeded') ? document.getElementById('totalCashNeeded').textContent : '',
                monthlyPITI: document.getElementById('monthlyPayment') ? document.getElementById('monthlyPayment').textContent : '',
                trueCost: document.getElementById('trueMonthlyCost') ? document.getElementById('trueMonthlyCost').textContent : '',
                effectiveCost: document.getElementById('effectiveCost') ? document.getElementById('effectiveCost').textContent : '',
                inputs: {}
            };
            // Save all input field values for full restoration
            inputFields.forEach(function(id) {
                var el = document.getElementById(id);
                if (el) snapshot.inputs[id] = el.value;
            });
            snapshot.overrideTakeHome = document.getElementById('overrideTakeHome').checked;

            scenarios.push(snapshot);
            try { localStorage.setItem(SCENARIO_STORAGE_KEY, JSON.stringify(scenarios)); } catch (e) {}
            renderScenarios();
            const status = document.getElementById('saveStatus');
            status.textContent = '‚úì Scenario saved!';
            setTimeout(() => { status.textContent = ''; }, 2000);
        }

        function deleteScenario(index) {
            const scenarios = getScenarios();
            scenarios.splice(index, 1);
            try { localStorage.setItem(SCENARIO_STORAGE_KEY, JSON.stringify(scenarios)); } catch (e) {}
            renderScenarios();
        }

        function loadScenario(index) {
            const scenarios = getScenarios();
            const s = scenarios[index];
            if (!s) return;

            if (s.inputs) {
                // Full restore from saved inputs
                inputFields.forEach(function(id) {
                    var el = document.getElementById(id);
                    if (el && s.inputs[id] !== undefined) el.value = s.inputs[id];
                });
                // Rebuild county dropdown, then restore saved county/tax
                var savedCounty = s.inputs.countySelect;
                var savedTaxRate = s.inputs.propertyTaxRate;
                if (s.inputs.stateSelect) onStateChange();
                if (savedCounty !== undefined) document.getElementById('countySelect').value = savedCounty;
                if (savedTaxRate !== undefined) document.getElementById('propertyTaxRate').value = savedTaxRate;
                if (s.overrideTakeHome) {
                    document.getElementById('overrideTakeHome').checked = true;
                    toggleTakeHomeOverride();
                } else {
                    document.getElementById('overrideTakeHome').checked = false;
                }
                applyDownPaymentMode();
                toggleARMInputs();
                calculateTakeHome();
                updateTaxRules();
            } else {
                // Legacy scenarios (only 4 core fields)
                document.getElementById('purchasePrice').value = s.price;
                document.getElementById('downPaymentPercent').value = s.down;
                document.getElementById('interestRate').value = s.rate;
                document.getElementById('loanTerm').value = s.term;
                calculate();
            }
        }

        function renderScenarios() {
            const scenarios = getScenarios();
            const section = document.getElementById('scenarioSection');
            const grid = document.getElementById('scenarioGrid');
            if (!section || !grid) return;

            if (scenarios.length === 0) {
                section.style.display = 'none';
                return;
            }
            section.style.display = 'block';
            grid.innerHTML = scenarios.map(function(s, i) {
                var safeName = escapeHTML(s.name);
                return '<div class="scenario-card">' +
                    '<button class="scenario-delete" onclick="deleteScenario(' + i + ')" aria-label="Delete ' + safeName + '">&times;</button>' +
                    '<h4>' + safeName + '</h4>' +
                    '<div class="scenario-row"><span>Price</span><span>$' + Number(s.price).toLocaleString() + '</span></div>' +
                    '<div class="scenario-row"><span>Down</span><span>' + escapeHTML(s.down) + '%</span></div>' +
                    '<div class="scenario-row"><span>Rate</span><span>' + escapeHTML(s.rate) + '%</span></div>' +
                    '<div class="scenario-row"><span>Cash Needed</span><span>' + escapeHTML(s.cashNeeded) + '</span></div>' +
                    '<div class="scenario-row"><span>PITI</span><span>' + escapeHTML(s.monthlyPITI) + '</span></div>' +
                    '<div class="scenario-row"><span>True Cost</span><span>' + escapeHTML(s.trueCost) + '</span></div>' +
                    '<div class="scenario-row"><span>After Tax</span><span>' + escapeHTML(s.effectiveCost) + '</span></div>' +
                    '<button onclick="loadScenario(' + i + ')" style="margin-top:8px;width:100%;padding:6px;border:1px solid var(--primary);background:white;color:var(--primary);border-radius:4px;cursor:pointer;font-size:0.8rem;">Load</button>' +
                    '</div>';
            }).join('');
        }

        // ========================================
        // EVENT LISTENERS
        // ========================================
        let calcTimer;
        function debouncedCalculate() {
            clearTimeout(calcTimer);
            calcTimer = setTimeout(calculate, 300);
        }
        document.querySelectorAll('input, select').forEach(el => {
            el.addEventListener('input', debouncedCalculate);
            el.addEventListener('change', calculate); // Immediate on dropdown/blur
        });

        // Add numeric keyboard hint to all number inputs for mobile
        document.querySelectorAll('input[type="number"]').forEach(el => {
            if (!el.getAttribute('inputmode')) {
                el.setAttribute('inputmode', 'decimal');
            }
        });

        // Associate labels with their inputs for accessibility
        document.querySelectorAll('.input-group').forEach(group => {
            const label = group.querySelector('label');
            const input = group.querySelector('input, select');
            if (label && input && input.id && !label.getAttribute('for')) {
                label.setAttribute('for', input.id);
            }
        });

        // Initial setup - load from URL params first, then localStorage fallback
        initTaxYearSelector();
        const hadURLData = loadFromURL();
        const hadSavedData = hadURLData ? false : loadData();
        // Restore advanced mode preference
        if (localStorage.getItem('calcAdvancedMode') === '1') {
            toggleAdvancedMode(true);
        }
        toggleARMInputs();
        calculateTakeHome();
        updateTaxRules();
        renderScenarios();

        if (hadURLData) {
            document.getElementById('saveStatus').textContent = '‚úì Loaded from shared link';
            setTimeout(() => {
                document.getElementById('saveStatus').textContent = '';
            }, 3000);
        } else if (hadSavedData) {
            document.getElementById('saveStatus').textContent = '‚úì Loaded saved data';
            setTimeout(() => {
                document.getElementById('saveStatus').textContent = '';
            }, 2000);
        }
    </script>
</body>
</html>
